<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Lab6: Missing Data • WILD8370</title>
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Lab6: Missing Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WILD8370</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2025.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-house-chimney"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../articles/syllabus.html"><span class="fa fab fa-readme"></span> Syllabus</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/schedule.html"><span class="fa far fa-calendar"></span> Schedule</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lectures" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-file-powerpoint"></span> Lectures</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lectures">
<li><a class="dropdown-item" href="../articles/lectures/00_course_intro/00_course_intro.html">Lecture 0: Course introduction</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/01_inference/01_inference.html">Lecture 1: Statistical inference in ecology</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/02_probability/02_probability.html">Lecture 2: Probability refresher</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/03_bayes/03_bayes.html">Lecture 3: Principles of Bayesian inference</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/04_intro_nimble/Intro_Nimble.html">Lecture 4: Introduction to Nimble</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/05_glms/05_glms.html">Lecture 5: Generalized linear model review</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/06_priors/06_priors.html">Lecture 6: More about priors</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/07_random_effects/07_random_effects.html">Lecture 7: Random vs. Fixed Effects</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/08_occupancy/08_occupancy.html">Lecture 8: State Space Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/09_NMix/09_NMix.html">Lecture 9: N-Mixture and Occupancy</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/11_DynamicNMix/11_DynamicNMix.html">Lecture 11: Dynamic N-Mixture Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/9b_ExtraOcc/9b_ExtraOcc.html">Lecture 9b: Static Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/10_DynamicOcc/10_DynamicOcc.html">Lecture 10: Dynamic Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/12_MovementModels/12_MovementModels.html">Lecture 12: Movement Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/13_ClosedCMR/Lecture13_ClosedCMR.html">Lecture 13: Closed CMR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/14_ClosedSCR/Lecture14_ClosedSCR.html">Lecture 14: Closed SCR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/15_KnownFate/15_KnownFate.html">Lecture 15: Known Fate Modeling</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/16_CJS/16_CJS.html">Lecture 16: CJS Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/17_MultiState/17_Multistate.html">Lecture 17: Multistate Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/18_CT/18_CT.html">Lecture 18: Continuous-time CMR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/19_JS/19_openCMR.html">Lecture 19: Open Capture Mark Recapture Part 1</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/20_JSSuper/20_JSSuper.html">Lecture 20: Open Capture Mark Recapture Part 2</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/21_MultiOcc/21_MultiOcc.html">Lecture 21: Multispecies Occupancy</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-labs" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-laptop-code"></span> Labs</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-labs">
<li><a class="dropdown-item" href="../articles/lab01_intro_to_R.html">Lab 0: Introduction to R</a></li>
    <li><a class="dropdown-item" href="../articles/Lab01b_Mathematical_Notation.html">Lab 1: Mathematical Notation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab2_simulation.html">Lab 2: Data Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab3_BasicMCMC.html">Lab 3: Basic MCMC</a></li>
    <li><a class="dropdown-item" href="../articles/Lab4_glms.html">Lab 4: GLMs</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Lab 5: Priors</a></li>
    <li><a class="dropdown-item" href="../articles/Lab6_MissingData.html">Lab 6: Missing Data</a></li>
    <li><a class="dropdown-item" href="../articles/Lab7_GOF.html">Lab 7: Goodness of Fit</a></li>
    <li><a class="dropdown-item" href="../articles/Lab8_Movement.html">Lab 8: Resource Selection Functions</a></li>
    <li><a class="dropdown-item" href="../articles/Lab9_SCR.html">Lab 9: Spatial Capture Recapture</a></li>
    <li><a class="dropdown-item" href="../articles/Lab10_CJS.html">Lab 10: CJS</a></li>
    <li><a class="dropdown-item" href="../articles/Lab11_Multistate.html">Lab 11: Continuous-time CMR</a></li>
    <li><a class="dropdown-item" href="../articles/Lab12_JointLiveDead.html">Lab 12: Joint Live-Dead Recovery Models</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-references" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-bookmark"></span> References</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-references">
<li><a class="dropdown-item" href="../articles/homework.html">Assignment instructions</a></li>
    <li><a class="dropdown-item" href="../articles/projects_and_directories.html">Projects and directories</a></li>
    <li><a class="dropdown-item" href="../articles/RMarkdown.html">R Markdown reference</a></li>
    <li><a class="dropdown-item" href="../articles/graphics.html">Creating publication-quality graphics</a></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Lab6: Missing Data</h1>
            
      

      <div class="d-none name"><code>Lab6_MissingData.Rmd</code></div>
    </div>

    
    
<p>Over the past few weeks, we’ve covered a lot of the foundational
concepts that you will need to build many, if not most, Bayesian models.
In this activity we will combine the concepts of linear models, random
effects and state-space models to practice what we’ve learned so
far.</p>
<hr>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<ul>
<li><p>Analyze data using both random and fixed effects</p></li>
<li><p>Deal with missing data</p></li>
<li><p>Gain experience with Nimble</p></li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="european-hares">European Hares<a class="anchor" aria-label="anchor" href="#european-hares"></a>
</h2>
<p>Data for today comes from the Swiss hare data included in Marc Kéry’s
2010 book, <em>Introduction to WinBUGS for Ecologists</em>. The data
contain replicated counts of Brown hares (<em>Lepus europaeus</em>)
conducted over 17 years (1992-2008) at 56 sites in 8 regions of
Switzerland. Each year, two counts were conducted during a two-week
period. Sites vary in area, elevation, and belong to two types of
habitat (arable and grassland). You can read more about this study here:
<a href="https://www.sciencedirect.com/science/article/pii/S0006320710004921?via=ihub" class="external-link uri">https://www.sciencedirect.com/science/article/pii/S0006320710004921?via=ihub</a></p>
<p><img src="Hare.webp" width="50%" style="display: block; margin: auto;"></p>
<p>Let’s begin by taking a look at the data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"swiss_hares"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">hares</span><span class="op">)</span></span>
<span><span class="co">#&gt;   no site     region    site2 area elevation landuse year count1 count2</span></span>
<span><span class="co">#&gt; 1  1 AG01 CH.Central Reusstal 2.23       384  arable 1992     NA     NA</span></span>
<span><span class="co">#&gt; 2  2 AG01 CH.Central Reusstal 2.23       384  arable 1993     NA     NA</span></span>
<span><span class="co">#&gt; 3  3 AG01 CH.Central Reusstal 2.23       384  arable 1994     NA     NA</span></span>
<span><span class="co">#&gt; 4  4 AG01 CH.Central Reusstal 2.23       384  arable 1995      6      4</span></span>
<span><span class="co">#&gt; 5  5 AG01 CH.Central Reusstal 2.23       384  arable 1996      7      5</span></span>
<span><span class="co">#&gt; 6  6 AG01 CH.Central Reusstal 2.23       384  arable 1997      3      3</span></span>
<span><span class="co">#&gt;   mean.density</span></span>
<span><span class="co">#&gt; 1           NA</span></span>
<span><span class="co">#&gt; 2           NA</span></span>
<span><span class="co">#&gt; 3           NA</span></span>
<span><span class="co">#&gt; 4        2.691</span></span>
<span><span class="co">#&gt; 5        3.139</span></span>
<span><span class="co">#&gt; 6        1.345</span></span></code></pre></div>
<p>For now, let’s focus on hares in the Central region.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">Central_hares</span> <span class="op">&lt;-</span> <span class="va">hares</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">'CH.Central'</span><span class="op">)</span></span></code></pre></div>
<p>We can start with a simple model with no random effects and a
binomial observation process. Since these are count data, a natural
choice for the process model is a poisson with a log link.</p>
<p>Perhaps hare abundance is affected by the size of the site
(<code>area</code>) and the landuse type (<code>landuse</code>) and
detection probability is different between different sites
(<code>site1</code>).</p>
<p>Let <span class="math inline">i</span> be a site (<code>site1</code>)
in the study area that was surveyed in year <span class="math inline">t</span>.Then:</p>
<p><span class="math display"> log(\lambda_{i,t}) = \beta_0 +
\beta_1[landuse_i] + \beta_2*area_{i} </span> <span class="math display"> N_{i,t} \sim Pois(\lambda_{i,t}) </span> Further,
let <span class="math inline">y</span> represent the number of hares
observed during survey <span class="math inline">k</span> in a given
year:</p>
<p><span class="math display"> y_{i,t,k} \sim Binomial(N_{i,t}, p_{i})
</span></p>
<p><span class="math display"> p_i =
ln(\frac{\alpha[site]}{1-\alpha[site]})</span></p>
<p>(Remember that writing <span class="math inline">ln(\frac{x}{1-x})</span> is the same as logit(f(x)).
)</p>
</div>
<div class="section level2">
<h2 id="building-the-nimble-model">Building the Nimble model<a class="anchor" aria-label="anchor" href="#building-the-nimble-model"></a>
</h2>
<p>We can more or less work backwards from the mathematical model to
write our nimble model. Ignoring correct formatting, we have:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co">#Process model</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">beta0</span> <span class="op">+</span> <span class="va">beta1</span><span class="op">[</span><span class="va">landuse</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta2</span><span class="op">*</span><span class="va">site_area</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>   <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>   </span>
<span>   <span class="co">#observation model</span></span>
<span>   <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha</span><span class="op">[</span><span class="va">site</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Now we can just add in loops to get the indexing correct and then
choose some priors. Let’s start with making landuse a fixed effect.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hare_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co">#Process model</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">beta0</span> <span class="op">+</span> <span class="va">beta1</span><span class="op">[</span><span class="va">landuse</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta2</span><span class="op">*</span><span class="va">site_area</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>      <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">{</span> <span class="co">#could also do 1:ncounts[t] if we wanted to be fancy</span></span>
<span>        <span class="co">#observation model</span></span>
<span>        <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha</span><span class="op">[</span><span class="va">site</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="co">#priors:</span></span>
<span>  <span class="va">beta0</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">beta2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nlandtypes</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">beta1</span><span class="op">[</span><span class="va">m</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">alpha</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Now we can get our data, constants, and inits ready.</p>
<div class="section level3">
<h3 id="in-class-question">In Class Question<a class="anchor" aria-label="anchor" href="#in-class-question"></a>
</h3>
<ul>
<li><p>What parameters will need initial values?</p></li>
<li><p>What parameters and objects will need to be included in
constants?</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="missing-data-values">Missing Data Values<a class="anchor" aria-label="anchor" href="#missing-data-values"></a>
</h3>
<p>Now we come across a common issue - missing data. Not all sites were
surveyed in all years. What to do? We could cut out years where not all
sites are surveyed, but we’d end up throwing away a lot of data. We’re
also still going to need to deal with the sites that were only surveyed
once in a given year.</p>
<p>To solve this, we can adjust our code to also include a parameter for
<em>effort</em> indicating if the site was surveyed in that session. If
effort is 0, our detections for that survey round are also 0 (since we
didn’t survey).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hare_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co">#Process model</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">beta0</span> <span class="op">+</span> <span class="va">beta1</span><span class="op">[</span><span class="va">landuse</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta2</span><span class="op">*</span><span class="va">site_area</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>      <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">{</span> <span class="co">#could also do 1:ncounts[t] if we wanted to be fancy</span></span>
<span>        <span class="co">#observation model</span></span>
<span>        <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha</span><span class="op">[</span><span class="va">site</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="co">#priors:</span></span>
<span>  <span class="va">beta0</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">beta2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nlandtypes</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">beta1</span><span class="op">[</span><span class="va">m</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">alpha</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Based on our code, we see that we need our observations in a 3-d
array, with sites as rows, time as columns and sessions (1 or 2) as the
third dimension. An easy way to turn character strings into numbers is
to first turn them into factors, then convert them to numeric.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Central_hares</span><span class="op">$</span><span class="va">site_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Central_hares</span><span class="op">$</span><span class="va">site</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can create an empty array for both y (our counts) and effort (a
binary indicating if we surveyed).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">Central_hares</span><span class="op">$</span><span class="va">site_n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fl">1992</span><span class="op">:</span><span class="fl">2008</span><span class="op">)</span>, </span>
<span>                                <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">effort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">Central_hares</span><span class="op">$</span><span class="va">site_n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fl">1992</span><span class="op">:</span><span class="fl">2008</span><span class="op">)</span>, </span>
<span>                                <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we can fill in the arrays by using… wait for it… for-loops!</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Central_hares</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mysite</span> <span class="op">&lt;-</span> <span class="va">Central_hares</span><span class="op">$</span><span class="va">site_n</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">myyear</span> <span class="op">&lt;-</span> <span class="va">Central_hares</span><span class="op">$</span><span class="va">year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1991</span> <span class="co">#so that year 1 will be 1992</span></span>
<span>  <span class="va">y</span><span class="op">[</span><span class="va">mysite</span>, <span class="va">myyear</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Central_hares</span><span class="op">$</span><span class="va">count1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">Central_hares</span><span class="op">$</span><span class="va">count2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">effort</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co">#if y is NA, we didn't survey</span></span>
<span><span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co">#if y is NA, that means our count is 0</span></span>
<span></span>
<span><span class="va">hare.dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span><span class="va">y</span><span class="op">)</span> <span class="co">#for nimble</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="constants">Constants<a class="anchor" aria-label="anchor" href="#constants"></a>
</h3>
<p>In nimble we need to separate data (stochastic known information)
from constants (unchanging known information). Let’s make our constants
list next.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">constants_prep</span> <span class="op">&lt;-</span> <span class="va">Central_hares</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>landuse_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">landuse</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>        landuse <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">landuse_n</span><span class="op">)</span>,  <span class="co"># Get the landuse type for each site</span></span>
<span>        area <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">area</span><span class="op">)</span>,        <span class="co"># Get the area for each site</span></span>
<span>        .groups <span class="op">=</span> <span class="st">"drop"</span>           <span class="co"># To remove grouping after summarizing</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">constants_prep</span><span class="op">$</span><span class="va">area_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">constants_prep</span><span class="op">$</span><span class="va">area</span><span class="op">)</span> <span class="co">#scale the area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">constants_prep</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 4</span></span></span>
<span><span class="co">#&gt;   site  landuse  area area_s[,1]</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> AG01        1  2.23    -<span style="color: #BB0000;">0.861</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> AG02        1  3.58    -<span style="color: #BB0000;">0.573</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> AG03        1  4.79    -<span style="color: #BB0000;">0.315</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> AG04        1  5.8     -<span style="color: #BB0000;">0.099</span><span style="color: #BB0000; text-decoration: underline;">9</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> LU01        2 16.5      2.18  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> LU07A       2  5.85    -<span style="color: #BB0000;">0.089</span><span style="color: #BB0000; text-decoration: underline;">2</span></span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hare.consts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nsites <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">Central_hares</span><span class="op">$</span><span class="va">site_n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    nyears <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fl">1992</span><span class="op">:</span><span class="fl">2008</span><span class="op">)</span>, </span>
<span>                    landuse <span class="op">=</span> <span class="va">constants_prep</span><span class="op">$</span><span class="va">landuse</span>,</span>
<span>                    site_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">constants_prep</span><span class="op">$</span><span class="va">area_s</span><span class="op">)</span>, <span class="co">#remove the 'attributes' part</span></span>
<span>                    site <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">constants_prep</span><span class="op">)</span>,</span>
<span>                    effort <span class="op">=</span> <span class="va">effort</span>,</span>
<span>                    nlandtypes <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="initial-values">Initial Values<a class="anchor" aria-label="anchor" href="#initial-values"></a>
</h3>
<p>Now we need to initialize our model. Reminder that we need to
initialize anything that comes from a distribution that is not already
known. In this case, that means N, beta0, beta1, beta2 and alpha all
need to have initial values.</p>
<p>There are many ways to initialize our model, but an easy way is often
to set all betas to 0 except the intercepts. For N, we know that y is
the result of N*p, so we can start N as max(y)/p for each site.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hare.consts</span><span class="op">$</span><span class="va">nsites</span>, <span class="va">hare.consts</span><span class="op">$</span><span class="va">nyears</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">N.init</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">N.init</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">i</span>,,<span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fl">.5</span>  <span class="co">#can use .5 b/c the mean of the prior alpha is 0, which becomes p = .5 </span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="va">hare.inits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co">#match the prior</span></span>
<span>                   beta1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="co">#effect of two land types</span></span>
<span>                   beta2 <span class="op">=</span> <span class="fl">0</span>, <span class="co">#effect of area</span></span>
<span>                   alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">hare.consts</span><span class="op">$</span><span class="va">nsites</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co">#match prior</span></span>
<span>                   N <span class="op">=</span> <span class="va">N.init</span></span>
<span>                   <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="run-the-model">Run the Model<a class="anchor" aria-label="anchor" href="#run-the-model"></a>
</h2>
<div class="section level3">
<h3 id="parallel-processing">Parallel Processing<a class="anchor" aria-label="anchor" href="#parallel-processing"></a>
</h3>
<p>In the past, we’ve run Nimble with 3 chains, one after the other.
This is fine, but it means that we have to wait for each chain to be
finished to start the next one. To save time, let’s run all three chains
at the same time using our computer’s multi-core system.</p>
<p>For this to work, we’ll need to use the <code>parallel</code> package
in R. There are several ways to run parallel chains in R, but here’s my
preferred method. We begin by loading the <code>parallel</code> and
<code>coda</code> packages in R, and using the
<code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster()</a></code> command to prepare to run the three chains in
parallel</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="co">#each chain will be run separately </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span></code></pre></div>
<p>Next we export all the needed information to our cluster. This
includes our initial values, data, constants, and model code.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, varlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hare.inits"</span>, <span class="st">"hare.dat"</span>, <span class="st">"hare.consts"</span>, <span class="st">"hare_mod"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we put all the relevant parts of the model run into the
<code><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ()</a></code> function. What I like about this method is
that you can first test out all the code by indivdiually running each
line inside the function and then run it all together once you’re
positive you’ve de-bugged everything.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hares.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>,<span class="op">{</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span> <span class="co">#reload packages for each core</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="co">#Specify params:</span></span>
<span><span class="va">pars</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'beta0'</span>, <span class="st">'beta1'</span>, <span class="st">'beta2'</span>, <span class="st">'alpha'</span>, <span class="st">'N'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">hare_mod</span>, constants <span class="op">=</span> <span class="va">hare.consts</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">hare.dat</span>, inits <span class="op">=</span> <span class="va">hare.inits</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">pars</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">150000</span>, nburnin <span class="op">=</span> <span class="fl">50000</span>, thin <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co">#this will take awhile and not produce any progress bar. </span></span>
<span><span class="co">#You know it's done when the hares.out object is created in your environment.</span></span>
<span><span class="va">hares.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">as.mcmc.list</a></span><span class="op">(</span><span class="va">hares.out</span><span class="op">)</span></span></code></pre></div>
<p>On my computer, this takes about a minute.</p>
<p>After you’ve run your model in parallel, it’s good practice to close
the Cluster.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="inspecting-output">Inspecting Output<a class="anchor" aria-label="anchor" href="#inspecting-output"></a>
</h2>
<p>Let’s take a look at what our model told us. We can start with the
beta and alpha values. We can use the <code>grep</code> function to only
select variables that don’t contain the word ‘N’ (abundance) in
them.</p>
<p>In this case, we’ll ask R for the column names in our first list
(chain 1) and then use <code>grep</code> to tell us which of those names
contains an ‘N’. Then we’ll save only those parameters without an N in
our new object.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="va">hares.out</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">'N'</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">hares.out</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p>Let’s plot the beta values using the MCMCvis package</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/caseyyoungflesh/MCMCvis" class="external-link">MCMCvis</a></span><span class="op">)</span></span>
<span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">betas</span>, pdf <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-20-1.png" width="576" style="display: block; margin: auto;"><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-20-2.png" width="576" style="display: block; margin: auto;"><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-20-3.png" width="576" style="display: block; margin: auto;"><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-20-4.png" width="576" style="display: block; margin: auto;">
Oh dear. The alpha parameters look great, but the beta parameters look
pretty terrible. We can see that the chains are having a lot of trouble
mixing.</p>
<p>Often this can happen if parameters are not identifiable. It’s pretty
easy to see why that would happen here - if the effect of area on
abundance were 0, we’d be left with an equation that says abundance is
the sum of two numbers and without more information it’s impossible to
solve for both variables!</p>
<p>If you aren’t sure if two parameters are correlated (and potentially
unidentifiable), you can graph the correlation of the chains using the
<code>mcmcOutput</code> package.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mikemeredith/mcmcOutput" class="external-link">mcmcOutput</a></span><span class="op">)</span></span>
<span><span class="fu">mcmcOutput</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mcmcOutput/man/plot_crosscorrPlot.html" class="external-link">crosscorrPlot</a></span><span class="op">(</span><span class="va">betas</span><span class="op">[</span>,<span class="fl">8</span><span class="op">:</span><span class="fl">11</span>,<span class="op">]</span>, addSpace <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-21-1.png" width="576" style="display: block; margin: auto;">
In the above plot, we can see that beta0 has a strong negative
correlation (about -1) with both beta1[1] and beta1[2]. No good.</p>
</div>
<div class="section level2">
<h2 id="re-write-the-model">Re-write the Model<a class="anchor" aria-label="anchor" href="#re-write-the-model"></a>
</h2>
<p>Let’s fix our model by removing beta0.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hare_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co">#Process model</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">beta1</span><span class="op">[</span><span class="va">landuse</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta2</span><span class="op">*</span><span class="va">site_area</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>      <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">{</span> <span class="co">#could also do 1:ncounts[t] if we wanted to be fancy</span></span>
<span>        <span class="co">#observation model</span></span>
<span>        <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha</span><span class="op">[</span><span class="va">site</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="co">#priors:</span></span>
<span>  <span class="va">beta2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nlandtypes</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">beta1</span><span class="op">[</span><span class="va">m</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">alpha</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We also need to remove the initial value for beta0 from our inits
object.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hare.inits</span><span class="op">$</span><span class="va">beta0</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Time to re-run.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="co">#each chain will be run separately </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, varlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hare.inits"</span>, <span class="st">"hare.dat"</span>, <span class="st">"hare.consts"</span>, <span class="st">"hare_mod"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hares.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>,<span class="op">{</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span> <span class="co">#reload packages for each core</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="co">#Specify params:</span></span>
<span><span class="va">pars</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'beta1'</span>, <span class="st">'beta2'</span>, <span class="st">'alpha'</span>, <span class="st">'N'</span><span class="op">)</span> <span class="co">#removed beta0</span></span>
<span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">hare_mod</span>, constants <span class="op">=</span> <span class="va">hare.consts</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">hare.dat</span>, inits <span class="op">=</span> <span class="va">hare.inits</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">pars</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">150000</span>, nburnin <span class="op">=</span> <span class="fl">50000</span>, thin <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co">#this will take awhile and not produce any progress bar. </span></span>
<span><span class="co">#You know it's done when the hares.out object is created in your environment.</span></span>
<span><span class="va">hares.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">as.mcmc.list</a></span><span class="op">(</span><span class="va">hares.out</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Grab the alpha and beta params again and plot</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="va">hares.out</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">'N'</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">hares.out</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">betas</span>, pdf <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-26-1.png" width="576" style="display: block; margin: auto;"><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-26-2.png" width="576" style="display: block; margin: auto;"><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-26-3.png" width="576" style="display: block; margin: auto;"><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-26-4.png" width="576" style="display: block; margin: auto;">
Much better!</p>
</div>
<div class="section level2">
<h2 id="random-effects">Random Effects<a class="anchor" aria-label="anchor" href="#random-effects"></a>
</h2>
<p>Up until this point, we’ve been treating detection probability as a
fixed effect of the site. That is, there is no expected similarity
between detection probabilities at different sites. Let’s try model this
as a random effect instead and see how it changes our estimates.</p>
<p>Before we do that, let’s grab the current model’s alpha values so we
can see how they compare.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alphas1</span> <span class="op">&lt;-</span>  <span class="va">hares.out</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">'alpha'</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">hares.out</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p>Okay, now on to the model:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hare_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co">#Process model</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">beta1</span><span class="op">[</span><span class="va">landuse</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta2</span><span class="op">*</span><span class="va">site_area</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>      <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">{</span> <span class="co">#could also do 1:ncounts[t] if we wanted to be fancy</span></span>
<span>        <span class="co">#observation model</span></span>
<span>        <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha</span><span class="op">[</span><span class="va">site</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="co">#priors:</span></span>
<span>  <span class="va">beta2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nlandtypes</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">beta1</span><span class="op">[</span><span class="va">m</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">alpha</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sd.site</span><span class="op">)</span> <span class="co">#this is the change</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">sd.site</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">dexp</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>See how that works? When we use a random effect, we’re saying that
the average effect is 0, but each site’s specific beta is higher or
lower. The amount of variation from the mean is controlled by
<code>sd.site</code>, which will require a prior of its own. We can
describe alpha as a parameter and <code>sd.site</code> as a
‘hyper-parameter.’</p>
<p>Time to update our inits object with a value for sd.site.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hare.inits</span><span class="op">$</span><span class="va">sd.site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>  <span class="co">#from the prior</span></span></code></pre></div>
<p>Run the model again:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="co">#each chain will be run separately </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, varlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hare.inits"</span>, <span class="st">"hare.dat"</span>, <span class="st">"hare.consts"</span>, <span class="st">"hare_mod"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hares.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>,<span class="op">{</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span> <span class="co">#reload packages for each core</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="co">#Specify params:</span></span>
<span><span class="va">pars</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'beta1'</span>, <span class="st">'beta2'</span>, <span class="st">'sd.site'</span>, <span class="st">'alpha'</span>, <span class="st">'N'</span><span class="op">)</span> <span class="co">#add sd.site</span></span>
<span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">hare_mod</span>, constants <span class="op">=</span> <span class="va">hare.consts</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">hare.dat</span>, inits <span class="op">=</span> <span class="va">hare.inits</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">pars</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">250000</span>, nburnin <span class="op">=</span> <span class="fl">150000</span>, thin <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co">#this will take awhile and not produce any progress bar. </span></span>
<span><span class="co">#You know it's done when the hares.out object is created in your environment.</span></span>
<span><span class="va">hares.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">as.mcmc.list</a></span><span class="op">(</span><span class="va">hares.out</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Let’s check out the alpha parameters from this version of the
model:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alphas2</span> <span class="op">&lt;-</span> <span class="va">hares.out</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">'alpha'</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">hares.out</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">alphas2</span>, pdf <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-32-1.png" width="576" style="display: block; margin: auto;"><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-32-2.png" width="576" style="display: block; margin: auto;"><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-32-3.png" width="576" style="display: block; margin: auto;"></p>
<p>They seem to have mixed nicely. How do they compare to when we
modeled alpha as a fixed effect? Let’s make a quick graph to
compare.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod1_alphas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">alphas1</span><span class="op">)</span><span class="op">$</span><span class="va">quantiles</span> </span>
<span><span class="va">mod2_alphas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">alphas2</span><span class="op">)</span><span class="op">$</span><span class="va">quantiles</span></span>
<span><span class="va">gg_alphas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'alpha'</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                        LCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mod1_alphas</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">mod2_alphas</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                        Median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mod1_alphas</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, <span class="va">mod2_alphas</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                        UCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mod1_alphas</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span>, <span class="va">mod2_alphas</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                        Model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Fixed Effect"</span>, <span class="st">"Random Effect"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>                        </span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">gg_alphas</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">param</span>, y <span class="op">=</span> <span class="va">Median</span>, col <span class="op">=</span> <span class="va">Model</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">LCI</span>, ymax <span class="op">=</span> <span class="va">UCI</span><span class="op">)</span>, position<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Parameter"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'#7C94EC'</span>, <span class="st">'#C88B37'</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mod1_alphas</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'#7C94EC'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mod2_alphas</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'#C88B37'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">30</span>, hjust <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab6_MissingData_files/figure-html/unnamed-chunk-34-1.png" width="576" style="display: block; margin: auto;"></p>
<p>We can see numerically that the spread of the alphas is a little
smaller for the second model.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">mod1_alphas</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.4728</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">mod2_alphas</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.4</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="homework">Homework<a class="anchor" aria-label="anchor" href="#homework"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Last week we talked about prior predictive checks. Try running the
model we just ran in lab (detection is a random effect of site) and
running a prior predictive check. Plot out a few of the posteriors for
lambda and y.</li>
</ol>
<p>Hint: Instead of putting your data in the “data” object, put it in as
an initial value. Other than your data, all other information
(constants, params, etc.) is still the same.</p>
<ol start="2" style="list-style-type: decimal">
<li><p>When this data was formally analyzed, the authors used a random
effect of year in the process model and a random effect of site in the
detection process. Run the model with both of these random effects. Use
ggplot to compare the beta1 values (the effect of landuse type on the
expected abundance) produced by this new mode vs the model in Question
1. At a site with average area (scaled area = 0), what is the expected
abundance for each land use type?</p></li>
<li><p>Since this is an abundance model, it makes sense to make a plot
of abundance over time. Inside the model that you used for Question 2,
create 2 <em>derived parameterS</em> that represents the total abundance
of all sites of each landtype (one parameter for each landtype) in each
year. Use ggplot to graph the estimated total average density by
landtype over time, including the CIs. (Note: To get density, determine
the total area of all plots of each landtype, then divide your estimates
by this number).</p></li>
<li><p>To practice converting model code to the mathematical notation
expected in a scientific paper, write your model for Question 2 in its
full mathematical form, including priors.</p></li>
<li><p>On a 1-10 scale, with 1 being the worst week ever and 10 being
the best, how would you rate this week’s content? What lingering
questions/confusion about the lecture or lab do you still have?</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Clark Rushing, Heather Gaya.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
