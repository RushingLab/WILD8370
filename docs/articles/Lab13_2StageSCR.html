<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Lab13: 2 Stage SCR • WILD8370</title>
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Lab13: 2 Stage SCR">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WILD8370</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2025.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-house-chimney"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../articles/syllabus.html"><span class="fa fab fa-readme"></span> Syllabus</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/schedule.html"><span class="fa far fa-calendar"></span> Schedule</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lectures" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-file-powerpoint"></span> Lectures</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lectures">
<li><a class="dropdown-item" href="../articles/lectures/00_course_intro/00_course_intro.html">Lecture 0: Course introduction</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/01_inference/01_inference.html">Lecture 1: Statistical inference in ecology</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/02_probability/02_probability.html">Lecture 2: Probability refresher</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/03_bayes/03_bayes.html">Lecture 3: Principles of Bayesian inference</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/04_intro_nimble/Intro_Nimble.html">Lecture 4: Introduction to Nimble</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/05_glms/05_glms.html">Lecture 5: Generalized linear model review</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/06_priors/06_priors.html">Lecture 6: More about priors</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/07_random_effects/07_random_effects.html">Lecture 7: Random vs. Fixed Effects</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/08_occupancy/08_occupancy.html">Lecture 8: State Space Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/09_NMix/09_NMix.html">Lecture 9: N-Mixture and Occupancy</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/11_DynamicNMix/11_DynamicNMix.html">Lecture 11: Dynamic N-Mixture Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/9b_ExtraOcc/9b_ExtraOcc.html">Lecture 9b: Static Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/10_DynamicOcc/10_DynamicOcc.html">Lecture 10: Dynamic Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/12_MovementModels/12_MovementModels.html">Lecture 12: Movement Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/13_ClosedCMR/Lecture13_ClosedCMR.html">Lecture 13: Closed CMR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/14_ClosedSCR/Lecture14_ClosedSCR.html">Lecture 14: Closed SCR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/15_KnownFate/15_KnownFate.html">Lecture 15: Known Fate Modeling</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/16_CJS/16_CJS.html">Lecture 16: CJS Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/17_MultiState/17_Multistate.html">Lecture 17: Multistate Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/18_CT/18_CT.html">Lecture 18: Continuous-time CMR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/19_JS/19_openCMR.html">Lecture 19: Open Capture Mark Recapture Part 1</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/20_JSSuper/20_JSSuper.html">Lecture 20: Open Capture Mark Recapture Part 2</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/21_MultiOcc/21_MultiOcc.html">Lecture 21: Multispecies Occupancy</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/22_USCR/22_USCR.html">Lecture 22: Unmarked SCR</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-labs" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-laptop-code"></span> Labs</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-labs">
<li><a class="dropdown-item" href="../articles/lab01_intro_to_R.html">Lab 0: Introduction to R</a></li>
    <li><a class="dropdown-item" href="../articles/Lab01b_Mathematical_Notation.html">Lab 1: Mathematical Notation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab2_simulation.html">Lab 2: Data Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab3_BasicMCMC.html">Lab 3: Basic MCMC</a></li>
    <li><a class="dropdown-item" href="../articles/Lab4_glms.html">Lab 4: GLMs</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Lab 5: Priors</a></li>
    <li><a class="dropdown-item" href="../articles/Lab6_MissingData.html">Lab 6: Missing Data</a></li>
    <li><a class="dropdown-item" href="../articles/Lab7_GOF.html">Lab 7: Goodness of Fit</a></li>
    <li><a class="dropdown-item" href="../articles/Lab8_Movement.html">Lab 8: Resource Selection Functions</a></li>
    <li><a class="dropdown-item" href="../articles/Lab9_SCR.html">Lab 9: Spatial Capture Recapture</a></li>
    <li><a class="dropdown-item" href="../articles/Lab10_CJS.html">Lab 10: CJS</a></li>
    <li><a class="dropdown-item" href="../articles/Lab11_Multistate.html">Lab 11: Continuous-time CMR</a></li>
    <li><a class="dropdown-item" href="../articles/Lab12_JointLiveDead.html">Lab 12: Joint Live-Dead Recovery Models</a></li>
    <li><a class="dropdown-item" href="../articles/Lab13_2StageSCR.html">Lab 13: Two Stage SCR</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-references" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-bookmark"></span> References</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-references">
<li><a class="dropdown-item" href="../articles/homework.html">Assignment instructions</a></li>
    <li><a class="dropdown-item" href="../articles/projects_and_directories.html">Projects and directories</a></li>
    <li><a class="dropdown-item" href="../articles/RMarkdown.html">R Markdown reference</a></li>
    <li><a class="dropdown-item" href="../articles/graphics.html">Creating publication-quality graphics</a></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Lab13: 2 Stage SCR</h1>
            
      

      <div class="d-none name"><code>Lab13_2StageSCR.Rmd</code></div>
    </div>

    
    
<p>Today’s lab will focus on a two-step spatial capture recapture model.
This is a bonus lab, so there is no homework.</p>
<p>If you want a published example of this type of model, check out this
deer paper:</p>
<p>Margenau, Lydia L. S., Michael J. Cherry, Karl V. Miller, Elina P.
Garrison, and Richard B. Chandler. 2022. “ Monitoring Partially Marked
Populations Using Camera and Telemetry Data.” Ecological Applications
32(4): e2553. <a href="https://doi.org/10.1002/eap.2553" class="external-link uri">https://doi.org/10.1002/eap.2553</a></p>
<div class="section level2">
<h2 id="lab-overview">Lab Overview<a class="anchor" aria-label="anchor" href="#lab-overview"></a>
</h2>
<p>As we talked about in lecture, unmarked SCR models can be somewhat
unreliable without extra data. However, even a small amount of prior
information about <span class="math inline">g_0</span> or <span class="math inline">\sigma</span> makes a big difference and can turn an
unhelpful model into a solid abundance estimate.</p>
<p>But how do we get more information about <span class="math inline">g_0</span> or <span class="math inline">\sigma</span>? Using marked animals!</p>
<p>The basic idea is that a subset of animals are marked. We will use
their capture histories to inform <span class="math inline">g_0</span>
and <span class="math inline">\sigma</span> for the entire population.
It is <em>critically</em> important that the marked animals are
representative of the unmarked individuals and the probability of
detection of marked animals is the same as unmarked animals.</p>
<p>For today’s lab we will discuss how you can combine collar data
(known locations) with unmarked SCR data (camera trap information) to
make robust estimates of abundance.</p>
</div>
<div class="section level2">
<h2 id="stage-1">Stage 1<a class="anchor" aria-label="anchor" href="#stage-1"></a>
</h2>
<p>In Stage 1, we will combine a movement model with the camera capture
history of our collared animals to get posteriors for <span class="math inline">g_0</span> and <span class="math inline">\sigma</span>.</p>
<p>Because we are not interested in abundance, we will only loop over
our known, collared individuals. Each individual has an activity center
<span class="math inline">\mathbf{s_{i}}</span> with realized locations
<span class="math inline">\mathbf{u_{i,t}}</span>.</p>
<p><span class="math display">\large \mathbf{s_{i}} \sim
Uniform(s_{min}, s_{max})</span></p>
<p><span class="math display">\large p_{i,j} = g_0*e^{(-\|s_i -
x_j\|^2/(2\sigma^2))}</span></p>
<p><span class="math display">\large y_{j} \sim Binomial(1 -
e^{-(\sum_{i = 1}^M p_{i,j}*z_i)}, K)</span></p>
<p><span class="math display">\large \mathbf{u_{i,t}} \sim
Normal(s_{t-1}, \sigma^2)</span></p>
<p>Notice that the sigma for detection is the same as the sigma for
movement.</p>
<p>The output of this model will then give us a posterior for both <span class="math inline">g_0</span> and <span class="math inline">\sigma</span>.</p>
</div>
<div class="section level2">
<h2 id="stage-2">Stage 2<a class="anchor" aria-label="anchor" href="#stage-2"></a>
</h2>
<p>In SCR models, <span class="math inline">g_0</span> and <span class="math inline">\sigma</span> will always co-vary. As populations
get sparser, <span class="math inline">g_0</span> tends to decrease as
<span class="math inline">\sigma</span> increases. Thus, we don’t just
want the posterior of each value, we also want the covariance matrix
associated with the posteriors of both of these parameters.</p>
<p>Then our unmarked model will be simple to fit and run.</p>
<p>You’ll sometimes see this written in the literature as:</p>
<p><span class="math display">\large log(\mathbf{X}) \sim Normal_k(
\mathbf{\mu_k,\sum})</span></p>
<p>Which can be read as “the vector X is dstributed as a multivariate
normal with mean vector <span class="math inline">\mu</span> and
variance-covariance matrix <span class="math inline">\sum</span>”</p>
<p>In this case, <span class="math inline">\mathbf{\mu}</span> is just a
vector of length 2: <span class="math inline">(\widehat{g_0},\widehat{\sigma})</span> and the
variance- covariance matrix is:</p>
<p><span class="math display">
\sum = \begin{pmatrix}
  var(g_0) &amp; cov(g_0, \sigma) \\
  cov(\sigma, g_0) &amp; var(\sigma)
\end{pmatrix}
</span> If there were no covariance between <span class="math inline">\sigma</span> and <span class="math inline">g_0</span>, the left (minor) diagonal would be all
0s.</p>
<p><span class="math display">\large \Lambda = \int_{\mathcal{S}}
\lambda(s)</span></p>
<p><span class="math display">\large \mathbf{s_{i}} \sim
Uniform(s_{min}, s_{max})</span></p>
<p><span class="math display">\large z_{i} \sim
Bernoulli(\frac{\Lambda}{M})</span></p>
<p><span class="math display">\large p_{ij} = g_0*e^{(-\|s_i -
x_j\|^2/(2\sigma^2))}</span></p>
<p><span class="math display">\large y_{j} \sim Binomial(1 -
e^{-(\sum_{i = 1}^M p_{i,j}*z_i)}, K)</span></p>
<p><span class="math display">\large N = \sum^M_{i=1} z_i</span></p>
</div>
<div class="section level2">
<h2 id="model-in-nimble---stage-1">Model in Nimble - Stage 1<a class="anchor" aria-label="anchor" href="#model-in-nimble---stage-1"></a>
</h2>
<p>Before we can run this model in Nimble, we need an example dataset.
We’re going to steal some data from the paper I referenced above, since
the authors were kind enough to make both the data and model available
on Zenodo. This data comes from a group of camera traps in South Florida
in 2015.</p>
<p>I have modified their code below to make this a static model, but
check out the original paper if you want to know how to run an
open-population version of this model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">markedNimble</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="co">### Prior Distributions</span></span>
<span>  <span class="co"># Detection parameter- lam0</span></span>
<span>  <span class="va">loglam0</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="co"># mean (over time) lam0 on log scale  </span></span>
<span>  <span class="va">lam0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">loglam0</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># spatial scale parameter - sigma </span></span>
<span>  <span class="va">logsigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">380</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="co"># mean (over time) sigma on log scale  </span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logsigma</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># SCR model </span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n0</span><span class="op">)</span> <span class="op">{</span> <span class="co"># loop over known</span></span>
<span>    <span class="co">#for(t in first[i]:last[i]) { # loop over each time interval </span></span>
<span>      <span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">xlim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">xlim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>  <span class="co"># activity centers probabilities assumed uniform  </span></span>
<span>      <span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">ylim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">ylim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Model telemetry data conditional on activity centers </span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nTelemLocs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span> <span class="co"># for each telemetry location </span></span>
<span>        <span class="va">u</span><span class="op">[</span><span class="va">i</span>,<span class="va">k</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span> <span class="co"># x coord inform activity centers </span></span>
<span>        <span class="va">u</span><span class="op">[</span><span class="va">i</span>,<span class="va">k</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span> <span class="co"># y coord </span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nTraps</span><span class="op">)</span> <span class="op">{</span> <span class="co"># loop over each trap location </span></span>
<span>        <span class="co"># calculate distance from activity center to trap location  </span></span>
<span>        <span class="va">d</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="va">j</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="va">j</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="co">#x = trap location</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nOccasions</span><span class="op">)</span> <span class="op">{</span> <span class="co"># loop over each sampling occassion </span></span>
<span>          <span class="co"># calculate encounter rate as a distance decay fx with operational matrix </span></span>
<span>          <span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lam0</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">d</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="va">oper</span><span class="op">[</span><span class="va">j</span>,<span class="va">k</span><span class="op">]</span> <span class="co">#was the camera working </span></span>
<span>          <span class="co"># convert lambda to detection prob, Pr(at least one detection)  </span></span>
<span>          <span class="va">psi</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span> </span>
<span>          <span class="co"># This implies a Poisson distribution for independent counts</span></span>
<span>          <span class="co"># convert to binary counts using bernoulli distribution</span></span>
<span>          <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">psi</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span> </span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="grab-some-data-for-part-1">Grab Some Data for Part 1<a class="anchor" aria-label="anchor" href="#grab-some-data-for-part-1"></a>
</h2>
<p>Their model was fancier than what we’re going to fit, so we’ll only
use the 29th fortnight of their data (it has the most detection
data).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'scr2stage'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">telemetry.deer2</span> <span class="op">&lt;-</span> <span class="va">scr2stage</span><span class="op">$</span><span class="va">telemetry.deer</span><span class="op">[</span>,,,<span class="fl">29</span><span class="op">]</span> <span class="co">#first fortnight </span></span>
<span><span class="va">nTelemLocs2</span> <span class="op">&lt;-</span> <span class="va">scr2stage</span><span class="op">$</span><span class="va">nTelemLocs</span><span class="op">[</span>, <span class="fl">29</span><span class="op">]</span></span>
<span><span class="va">keepers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">nTelemLocs2</span> <span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">telemetry.deer2</span> <span class="op">&lt;-</span> <span class="va">telemetry.deer2</span><span class="op">[</span><span class="va">keepers</span>,,<span class="op">]</span> <span class="co">#only keep ones with data</span></span>
<span><span class="va">nTelemLocs2</span> <span class="op">&lt;-</span> <span class="va">nTelemLocs2</span><span class="op">[</span><span class="va">keepers</span><span class="op">]</span></span>
<span><span class="va">traps</span> <span class="op">&lt;-</span> <span class="va">scr2stage</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="va">traphist</span> <span class="op">&lt;-</span> <span class="va">scr2stage</span><span class="op">$</span><span class="va">histories4D</span><span class="op">[</span><span class="va">keepers</span>,,,<span class="fl">29</span><span class="op">]</span></span></code></pre></div>
<p>Let’s do a quick plot so we know what’s happening:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">traps</span>, asp <span class="op">=</span> <span class="fl">1</span>, pch<span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">telemetry.deer2</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">telemetry.deer2</span><span class="op">[</span><span class="va">k</span>,,<span class="op">]</span>, col <span class="op">=</span> <span class="va">k</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex<span class="op">=</span> <span class="fl">.25</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Lab13_2StageSCR_files/figure-html/unnamed-chunk-4-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Cleanup some more data pre-nimble</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># number of marked individuals</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nTelemLocs2</span><span class="op">)</span></span>
<span><span class="co"># Set the limits of study area to the camera grid with 1 km buffer  </span></span>
<span><span class="va">xlim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">traps</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1000</span>,<span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">ylim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">traps</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1000</span>,<span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># number of secondary sampling occasions (1 fortnight)</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">14</span></span>
<span><span class="va">operational</span> <span class="op">&lt;-</span> <span class="va">scr2stage</span><span class="op">$</span><span class="va">oper3D</span><span class="op">[</span>,,<span class="fl">29</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">xlim</span>, ylim <span class="op">=</span> <span class="va">ylim</span>, </span>
<span>                  nTraps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">traps</span><span class="op">)</span>,</span>
<span>                  n0<span class="op">=</span><span class="va">N</span>, nOccasions <span class="op">=</span> <span class="va">K</span>,  </span>
<span>                  x <span class="op">=</span> <span class="va">traps</span>, </span>
<span>                  nTelemLocs <span class="op">=</span> <span class="va">nTelemLocs2</span>,</span>
<span>                  oper <span class="op">=</span> <span class="va">operational</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">traphist</span>,  </span>
<span>             u<span class="op">=</span><span class="va">telemetry.deer2</span> </span>
<span>            <span class="op">)</span></span>
<span></span>
<span><span class="co"># Start activity centers:</span></span>
<span><span class="va">si</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">si</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">xlim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">xlim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">si</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">ylim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">ylim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Initial values </span></span>
<span><span class="va">inits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>loglam0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.05</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.6</span><span class="op">)</span><span class="op">)</span>, </span>
<span>              logsigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">850</span><span class="op">)</span>, </span>
<span>              s <span class="op">=</span> <span class="va">si</span></span>
<span>              <span class="op">)</span> </span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logsigma"</span>, <span class="st">"loglam0"</span>, <span class="st">'sigma'</span>, <span class="st">'lam0'</span><span class="op">)</span></span></code></pre></div>
<p>Check model:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod.nimble</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">markedNimble</span>,</span>
<span>                          constants <span class="op">=</span> <span class="va">constants</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">data</span>,</span>
<span>                          inits <span class="op">=</span> <span class="va">inits</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Did everything initialize correctly?</span></span>
<span><span class="va">mod.nimble</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -49264</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-stage-1">Run Stage 1<a class="anchor" aria-label="anchor" href="#run-stage-1"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="co">#each chain will be run separately </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, varlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"inits"</span>,  <span class="st">"constants"</span>, <span class="st">'data'</span>, <span class="st">"markedNimble"</span>, <span class="st">'params'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">stage1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>,<span class="op">{</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span> <span class="co">#reload packages for each core</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">markedNimble</span>,</span>
<span>                          constants <span class="op">=</span> <span class="va">constants</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">data</span>,</span>
<span>                          inits <span class="op">=</span> <span class="va">inits</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">params</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">100000</span>, nburnin <span class="op">=</span> <span class="fl">75000</span>, thin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co">#this will take awhile and not produce any progress bar</span></span>
<span><span class="va">stage1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">as.mcmc.list</a></span><span class="op">(</span><span class="va">stage1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Check Output:</p>
<p>We would probably want to run this just a tad longer to get better
convergence</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">stage1</span>, pdf <span class="op">=</span> <span class="cn">F</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span>, iter <span class="op">=</span> <span class="fl">20000</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab13_2StageSCR_files/figure-html/unnamed-chunk-10-1.png" width="768" style="display: block; margin: auto;"><img src="Lab13_2StageSCR_files/figure-html/unnamed-chunk-10-2.png" width="768" style="display: block; margin: auto;"></p>
<p>Before we move on to stage 2, we need to create a variance-covariance
matrix for <span class="math inline">g_0</span> and <span class="math inline">\sigma</span>. We need the log values for this.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samps_stage1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">stage1</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"loglam0"</span>, <span class="st">"logsigma"</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">xbar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">samps_stage1</span><span class="op">)</span></span>
<span><span class="va">xvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">samps_stage1</span><span class="op">)</span></span></code></pre></div>
<p>Our means on the log scale</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xbar</span></span>
<span><span class="co">#&gt;  loglam0 logsigma </span></span>
<span><span class="co">#&gt;   -2.617    5.951</span></span></code></pre></div>
<p>Our variances on the log scale</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xvar</span></span>
<span><span class="co">#&gt;             loglam0   logsigma</span></span>
<span><span class="co">#&gt; loglam0   0.0229673 -1.522e-04</span></span>
<span><span class="co">#&gt; logsigma -0.0001522  4.939e-05</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-in-nimble---stage-2">Model in Nimble - Stage 2<a class="anchor" aria-label="anchor" href="#model-in-nimble---stage-2"></a>
</h2>
<p>This step should look just like a normal unmarked SCR model, with the
exception of the priors.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">densityNimble</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">### Prior Distributions</span></span>
<span>    <span class="co"># Use the posterior estimates from the marked population as informative</span></span>
<span>    <span class="co"># priors for the unmarked population</span></span>
<span>    <span class="co"># Multivariate normal distribution</span></span>
<span>    <span class="va">log_sig_lam0</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dmnorm</span><span class="op">(</span><span class="va">prior_means</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, cov<span class="op">=</span><span class="va">prior_vcov</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sig_lam0</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">lam0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_sig_lam0</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">psi</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#real or not?</span></span>
<span>   <span class="co">###Unmarked SCR</span></span>
<span>     <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span> <span class="co"># loop over each individual</span></span>
<span></span>
<span>       <span class="co"># probability of being a member of the population</span></span>
<span>       <span class="va">z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">psi</span><span class="op">)</span></span>
<span></span>
<span>       <span class="co"># activity centers probabilities assummed uniform</span></span>
<span>       <span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">xlim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">xlim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>       <span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">ylim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">ylim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>       <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span> <span class="co"># loop over each trap location</span></span>
<span>         <span class="co"># calculate distance from activity center to trap location</span></span>
<span>         <span class="va">d</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="va">j</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="va">j</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>         <span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lam0</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">d</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>       <span class="op">}</span></span>
<span>     <span class="op">}</span></span>
<span></span>
<span>     <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span> <span class="op">{</span></span>
<span>       <span class="va">Hazard</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">inprod</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">M</span>,<span class="va">j</span><span class="op">]</span> , <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">]</span><span class="op">)</span></span>
<span>       <span class="va">p</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">Hazard</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>       <span class="va">nsum</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbin</span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, <span class="va">K</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>     <span class="op">}</span></span>
<span>    </span>
<span>     <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">]</span><span class="op">)</span></span>
<span>     <span class="va">D</span> <span class="op">&lt;-</span> <span class="va">N</span><span class="op">/</span><span class="va">Area</span></span>
<span> <span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="grab-some-data-for-part-2">Grab Some Data for Part 2<a class="anchor" aria-label="anchor" href="#grab-some-data-for-part-2"></a>
</h2>
<p>We now also need our unmarked counts of the number of days each
camera saw at least one deer. As we can see, despite being out for 2
weeks, there were many sites with relatively few detections.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nsum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">scr2stage</span><span class="op">$</span><span class="va">n3D</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span></span>
<span><span class="va">nsum</span> <span class="op">&lt;-</span> <span class="va">nsum</span><span class="op">[</span>,<span class="fl">29</span><span class="op">]</span></span>
<span><span class="va">nsum</span></span>
<span><span class="co">#&gt;  [1] 0 0 0 1 0 0 0 0 0 0 0 3 0 2 6 0 0 1 3 4 0 2 2 1 5 2 0 3 0 0 1 1 2 0 5 0 1 1</span></span>
<span><span class="co">#&gt; [39] 0 1 1 0 0 0 0 1 0 1 4 0 3 1 0 3 1 2 2 0 9 0</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Area</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">xlim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">xlim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">ylim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">ylim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fl">1e6</span> <span class="co">## sq-km</span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">350</span> <span class="co">#lots of deer!</span></span></code></pre></div>
<p>Nimble objects for part 2</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>M<span class="op">=</span><span class="va">M</span>, K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">operational</span><span class="op">)</span>, </span>
<span>                  J<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">traps</span><span class="op">)</span>,</span>
<span>                  xlim <span class="op">=</span> <span class="va">xlim</span>, ylim <span class="op">=</span> <span class="va">ylim</span>, </span>
<span>                  Area <span class="op">=</span> <span class="va">Area</span>, x <span class="op">=</span> <span class="va">traps</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nsum <span class="op">=</span> <span class="va">nsum</span>, </span>
<span>             prior_means <span class="op">=</span> <span class="va">xbar</span>, prior_vcov <span class="op">=</span> <span class="va">xvar</span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_sig_lam0.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">log_sig_lam0.init</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">.1</span><span class="op">)</span></span>
<span><span class="va">log_sig_lam0.init</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">800</span><span class="op">)</span></span>
<span></span>
<span><span class="va">M.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">xlim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">xlim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">M.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">ylim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">ylim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">si</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">M</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">si</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M.x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">si</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">M.y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">inits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>s <span class="op">=</span> <span class="va">si</span>, z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">M</span><span class="op">)</span>,</span>
<span>              log_sig_lam0 <span class="op">=</span> <span class="va">log_sig_lam0.init</span>,</span>
<span>              psi <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span>
<span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sigma"</span>, <span class="st">"lam0"</span>, <span class="st">"psi"</span>, </span>
<span>            <span class="st">"N"</span>, <span class="st">"D"</span><span class="op">)</span></span></code></pre></div>
<p>Check model:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod.nimble2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">densityNimble</span>,</span>
<span>                          constants <span class="op">=</span> <span class="va">constants</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">data</span>,</span>
<span>                          inits <span class="op">=</span> <span class="va">inits</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Did everything initialize correctly?</span></span>
<span><span class="va">mod.nimble2</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -13617</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-stage-2">Run Stage 2<a class="anchor" aria-label="anchor" href="#run-stage-2"></a>
</h2>
<p>This part takes a little bit longer, but still isn’t too bad in terms
of time. Maybe 10 minutes?</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="co">#each chain will be run separately </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, varlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"inits"</span>,  <span class="st">"constants"</span>, <span class="st">'data'</span>, <span class="st">"densityNimble"</span>, <span class="st">'params'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">stage2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>,<span class="op">{</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span> <span class="co">#reload packages for each core</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">densityNimble</span>,</span>
<span>                          constants <span class="op">=</span> <span class="va">constants</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">data</span>,</span>
<span>                          inits <span class="op">=</span> <span class="va">inits</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">params</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">100000</span>, nburnin <span class="op">=</span> <span class="fl">75000</span>, thin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co">#this will take awhile and not produce any progress bar</span></span>
<span><span class="va">stage2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">as.mcmc.list</a></span><span class="op">(</span><span class="va">stage2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Make sure psi is reasonable and other outputs seem to have mixed.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">stage2</span>, pdf <span class="op">=</span> <span class="cn">F</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab13_2StageSCR_files/figure-html/unnamed-chunk-21-1.png" width="768" style="display: block; margin: auto;"><img src="Lab13_2StageSCR_files/figure-html/unnamed-chunk-21-2.png" width="768" style="display: block; margin: auto;"></p>
<p>The estimated density (per square kilometer) for female deer at this
location is:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCsummary</span><span class="op">(</span><span class="va">stage2</span>, <span class="st">'D'</span>, Rhat <span class="op">=</span> <span class="cn">F</span>, n.eff <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="co">#&gt;    mean     sd   2.5%   50% 97.5%</span></span>
<span><span class="co">#&gt; D 1.295 0.2633 0.8489 1.273  1.88</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Clark Rushing, Heather Gaya.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
