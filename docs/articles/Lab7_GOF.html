<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Lab7: Goodness of Fit • WILD8370</title>
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Lab7: Goodness of Fit">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WILD8370</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2025.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-house-chimney"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../articles/syllabus.html"><span class="fa fab fa-readme"></span> Syllabus</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/schedule.html"><span class="fa far fa-calendar"></span> Schedule</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lectures" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-file-powerpoint"></span> Lectures</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lectures">
<li><a class="dropdown-item" href="../articles/lectures/00_course_intro/00_course_intro.html">Lecture 0: Course introduction</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/01_inference/01_inference.html">Lecture 1: Statistical inference in ecology</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/02_probability/02_probability.html">Lecture 2: Probability refresher</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/03_bayes/03_bayes.html">Lecture 3: Principles of Bayesian inference</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/04_intro_nimble/Intro_Nimble.html">Lecture 4: Introduction to Nimble</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/05_glms/05_glms.html">Lecture 5: Generalized linear model review</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/06_priors/06_priors.html">Lecture 6: More about priors</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/07_random_effects/07_random_effects.html">Lecture 7: Random vs. Fixed Effects</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/08_occupancy/08_occupancy.html">Lecture 8: State Space Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/09_NMix/09_NMix.html">Lecture 9: N-Mixture and Occupancy</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/10_DynamicOcc/10_DynamicOcc.html">Lecture 10: Dynamic Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/11_DynamicNMix/11_DynamicNMix.html">Lecture 11: Dynamic N-Mixture Models</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-labs" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-laptop-code"></span> Labs</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-labs">
<li><a class="dropdown-item" href="../articles/lab01_intro_to_R.html">Lab 0: Introduction to R</a></li>
    <li><a class="dropdown-item" href="../articles/Lab01b_Mathematical_Notation.html">Lab 1: Mathematical Notation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab2_simulation.html">Lab 2: Data Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab3_BasicMCMC.html">Lab 3: Basic MCMC</a></li>
    <li><a class="dropdown-item" href="../articles/Lab4_glms.html">Lab 4: GLMs</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Lab 5: Priors</a></li>
    <li><a class="dropdown-item" href="../articles/Lab6_MissingData.html">Lab 6: Missing Data</a></li>
    <li><a class="dropdown-item" href="../articles/Lab7_GOF.html">Lab 7: Goodness of Fit</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-references" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-bookmark"></span> References</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-references">
<li><a class="dropdown-item" href="../articles/homework.html">Assignment instructions</a></li>
    <li><a class="dropdown-item" href="../articles/projects_and_directories.html">Projects and directories</a></li>
    <li><a class="dropdown-item" href="../articles/RMarkdown.html">R Markdown reference</a></li>
    <li><a class="dropdown-item" href="../articles/graphics.html">Creating publication-quality graphics</a></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Lab7: Goodness of Fit</h1>
            
      

      <div class="d-none name"><code>Lab7_GOF.Rmd</code></div>
    </div>

    
    
<p>In this activity we’ll learn a few metrics for assessing model fit in
a Bayesian framework. We’ll also look at our model’s predictive
abilities by removing some observation points and assessing the
difference in the predicted values of latent variables.</p>
<hr>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<ul>
<li><p>Assess our models for goodness of fit using posterior predictive
checks and Bayesian p-values</p></li>
<li><p>Review occupancy and N-mixture models</p></li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="what-is-goodness-of-fit">What is Goodness of Fit?<a class="anchor" aria-label="anchor" href="#what-is-goodness-of-fit"></a>
</h2>
<p>Goodness-of-ﬁt assessment is a key for the assessment of assumption
violations in a model.</p>
<p>It is an excellent tool for:</p>
<ul>
<li><p>Identifying glaring flaws in our model</p></li>
<li><p>Testing if model assumptions are being met</p></li>
<li><p>Double checking that the model is doing what we think it’s
doing</p></li>
</ul>
<p>Goodness of Fit does <em>NOT</em> tell us:</p>
<ul>
<li><p>If our model is the best available model for our data</p></li>
<li><p>If we made a coding error</p></li>
<li><p>If there is a small violation of model assumptions</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="bayesian-p-values">Bayesian p-values<a class="anchor" aria-label="anchor" href="#bayesian-p-values"></a>
</h2>
<p>The basic idea of a posterior predictive check is to see if the data
we fit to the model can be predicted by the model we fit. This is
similar (but not identical) to the maximum likelihood approach of
<em>boostrapping</em>.</p>
<p>When a model ﬁts the observed data adequately (i.e., when the
underlying model assumptions are met sufﬁciently well) it should be
possible to generate, by simulation, a new replicate data set using the
model structure and estimated parameters similar to those of the
observed data set.</p>
<p>Posterior predictive checks compute one or more discrepancy measures
from observed and replicate data sets. The general method is
usually:</p>
<ol style="list-style-type: decimal">
<li><p>Simulate new data from the fit model.</p></li>
<li><p>Calculate a discrepancy measure between the observed data and the
expected value from the process model.</p></li>
<li><p>Calculate a discrepancy measure between the simulated data and
the expected value from the process model.</p></li>
<li><p>Calculate the proportion of data points where the observed data’s
discrepancy value was more extreme than the simulated data’s discrepancy
value. This proportion is called a Bayesian p-value.</p></li>
</ol>
<div class="section level3">
<h3 id="a-simple-example">A Simple Example:<a class="anchor" aria-label="anchor" href="#a-simple-example"></a>
</h3>
<p>Let’s imagine an extremely simple example where we model the weight
of birds at 500 sites in our study area as a random variable with a
normal distribution. Our data says the observed abundances were:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">abundance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">500</span>, mean <span class="op">=</span> <span class="fl">50</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>After we fit the model, we have a posterior estimate of <span class="math inline">\mu</span> = 45 and <span class="math inline">\sigma</span> = 1. We’re kind of suspicious of that
mean estimate, so we simulate some data from <span class="math inline">Normal(5, 1)</span> and calculate the average
discrepancy of the simulated results from the expected value (5). If
they were both from the same distribution, we’d expect the correlation
between their values to be about 1:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fakedat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">500</span>, mean <span class="op">=</span> <span class="fl">45</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">sim.discrep</span> <span class="op">&lt;-</span> <span class="va">fakedat</span><span class="op">-</span><span class="fl">45</span></span>
<span><span class="va">real.discrep</span> <span class="op">&lt;-</span> <span class="va">abundance</span> <span class="op">-</span> <span class="fl">45</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim.discrep</span>, <span class="va">real.discrep</span>, asp <span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a <span class="op">=</span><span class="fl">0</span>, b<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab7_GOF_files/figure-html/unnamed-chunk-3-1.png" width="576" style="display: block; margin: auto;">
Uh oh! Our simulated discrepancy value was greater than our real data’s
discrepancy 100% of the time! That’s a sign that our model is probably
not very good.</p>
<p>What does this look like if we had a perfect model? Let’s see:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fakedat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">500</span>, mean <span class="op">=</span> <span class="fl">50</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">sim.discrep</span> <span class="op">&lt;-</span> <span class="va">fakedat</span><span class="op">-</span><span class="fl">50</span></span>
<span><span class="va">real.discrep</span> <span class="op">&lt;-</span> <span class="va">abundance</span> <span class="op">-</span> <span class="fl">50</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim.discrep</span>, <span class="va">real.discrep</span>, asp <span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a <span class="op">=</span><span class="fl">0</span>, b<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab7_GOF_files/figure-html/unnamed-chunk-4-1.png" width="576" style="display: block; margin: auto;">
Nice!</p>
</div>
</div>
<div class="section level2">
<h2 id="discrepancy-measures-in-nimble">Discrepancy Measures in Nimble<a class="anchor" aria-label="anchor" href="#discrepancy-measures-in-nimble"></a>
</h2>
<p>Obviously our examples in real life are going to be a bit more
complicated. Let’s take an example from lecture this week and see how we
would implement this in Nimble if we were looking at an N-mixture
model.</p>
<p>Before we begin, it’s important to note that there are <em>many</em>
ways to calculate discrepancy. No one way is necessarily better than the
others. Here are 2 common options:</p>
<ul>
<li><p>Compare the raw residuals: <span class="math inline">y -
E(y)</span></p></li>
<li><p>Use Pearson’s residuals <span class="math inline">(y -
E(y))^2/var(E(y))</span></p></li>
</ul>
<p>We’ll implement both in our model, just to see how they work.</p>
<p>Here’s the hare model we looked at in Lab 6. As a reminder, the full
data contain replicated counts of Brown hares from 1992-2008 at 56 sites
in 8 regions of Switzerland. We chose to model the hares in just one
region, the Central region. This reduces our data to 7 study sites.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hare_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co">#Process model</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">beta1</span><span class="op">[</span><span class="va">landuse</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta2</span><span class="op">*</span><span class="va">site_area</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>      <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="co">#observation model</span></span>
<span>        <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="co">#end k</span></span>
<span>    <span class="op">}</span> <span class="co">#end t</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha</span><span class="op">[</span><span class="va">site</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="co">#priors:</span></span>
<span>  <span class="va">beta2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nlandtypes</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">beta1</span><span class="op">[</span><span class="va">m</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">alpha</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sd.site</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">sd.site</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">dexp</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Our data is <span class="math inline">y</span>, the number of hares
seen during each survey.</p>
<p>For convenience, here’s the relevant line:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Our first step is to simulate new observation data <em>inside the
model</em>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Now we can calculate our various discrepancy measures.</p>
<div class="section level3">
<h3 id="compare-the-raw-residuals">Compare the raw residuals<a class="anchor" aria-label="anchor" href="#compare-the-raw-residuals"></a>
</h3>
<p>First option is to compare the raw residuals. That’s the easiest and
my personal favorite. To do this, we subtract <span class="math inline">y</span> and <span class="math inline">y.new</span>
from the expected value of our binomial (N*p):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y.res</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="va">p.det</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="co">#residual</span></span>
<span><span class="va">y.res.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="va">p.det</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="co">#predicted residual</span></span></code></pre></div>
<p>The bayesian p-value is then the proportion of observations for which
<span class="math inline">y.res &gt; y.res.new</span>. We want this
value to be between 0.3 and 0.7. Much like maximum likelihood
‘p-values’, the cutoffs here are somewhat arbitrary.</p>
<p>Note that nimble gets cranky if we try to sum over more than 2
dimensions at once. We could either split up the sums or get a result
for each year. For this model, we might as well just calculate a p-value
for each site, so we can identify if some sites are noticeably worse
fitting than others.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>y[i,t,k] <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="at">size =</span> N[i,t],<span class="at">p =</span>p[i]<span class="sc">*</span>effort[i,t,k])</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>y.new[i,t,k] <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="at">size =</span> N[i,t],<span class="at">p =</span>p[i]<span class="sc">*</span>effort[i,t,k])</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>y.res[i,t,k] <span class="ot">&lt;-</span> y[i,t,k] <span class="sc">-</span> (N[i,t]<span class="sc">*</span>p[i]<span class="sc">*</span>effort[i,t,k]) <span class="co">#residual</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>y.res.new[i,t,k] <span class="ot">&lt;-</span> y.new[i,t,k] <span class="sc">-</span> (N[i,t]<span class="sc">*</span>p[i]<span class="sc">*</span>effort[i,t,k]) <span class="co">#predicted residual</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>y.res.dif[i,t,k] <span class="ot">&lt;-</span> y.res[i,t,k] <span class="sc">-</span> y.res.new[i,t,k]</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="er">}}</span> <span class="co">#end k and t</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>p.val1[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(y.res.dif[i,<span class="dv">1</span><span class="sc">:</span>nyears,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="er">}</span><span class="co">#end i</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pearsons-residuals">Pearson’s Residuals<a class="anchor" aria-label="anchor" href="#pearsons-residuals"></a>
</h3>
<p>Pearson’s residuals use the observation, the expected value and the
variance of the expected value: <span class="math inline">(y -
E(y))^2/var(E(y))</span>.</p>
<p>The variance of a binomial is <span class="math inline">Np(1-p)</span>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>y[i,t,k] <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="at">size =</span> N[i,t],<span class="at">p =</span>p[i]<span class="sc">*</span>effort[i,t,k])</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>y.new[i,t,k] <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="at">size =</span> N[i,t],<span class="at">p =</span>p[i]<span class="sc">*</span>effort[i,t,k])</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>y.pear[i,t,k] <span class="ot">&lt;-</span> (y[i,t,k] <span class="sc">-</span> N[i,t]<span class="sc">*</span>p[i]<span class="sc">*</span>effort[i,t,k])<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  (N[i,t]<span class="sc">*</span>(p[i]<span class="sc">*</span>effort[i,t,k])<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="er">*</span>p[i]<span class="sc">*</span>effort[i,t,k]))</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>y.pear.new[i,t,k] <span class="ot">&lt;-</span> (y.new[i,t,k] <span class="sc">-</span> N[i,t]<span class="sc">*</span>p[i]<span class="sc">*</span>effort[i,t,k])<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  (N[i,t]<span class="sc">*</span>(p[i]<span class="sc">*</span>effort[i,t,k])<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="er">*</span>p[i]<span class="sc">*</span>effort[i,t,k]))</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>y.pear.dif[i,t,k] <span class="ot">&lt;-</span> y.pear[i,t,k] <span class="sc">-</span> y.pear.new[i,t,k]</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="er">}}</span> <span class="co">#end k and t</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>p.val2[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(y.pear.dif[i,<span class="dv">1</span><span class="sc">:</span>nyears,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span></code></pre></div>
<p>That looks gross, but at least we don’t have to calculate it by
hand!</p>
<p>Let’s run the model and monitor <code>p.val1</code> and
<code>p.val2</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="run-the-model">Run the model<a class="anchor" aria-label="anchor" href="#run-the-model"></a>
</h2>
<p>For convenience, all the data cleanup we did in lecture is saved as
an object in the WILD8370 package.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Lab7hares</span><span class="op">)</span></span></code></pre></div>
<p>We just need to monitor the parameters of interest
(<code>p.val1</code> and <code>p.val2</code>), add in initial values for
y.new and we’re good to go.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Lab7hares</span><span class="op">$</span><span class="va">inits</span><span class="op">$</span><span class="va">y.new</span> <span class="op">&lt;-</span> <span class="va">Lab7hares</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">y</span></span></code></pre></div>
<p>Here’s the full model:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hare_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co">#Process model</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">beta1</span><span class="op">[</span><span class="va">landuse</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta2</span><span class="op">*</span><span class="va">site_area</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>      <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="co">#observation model</span></span>
<span>        <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="va">y.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,p <span class="op">=</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>        </span>
<span>        </span>
<span>        <span class="va">y.res</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="co">#residual</span></span>
<span>        <span class="va">y.res.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="co">#predicted residual</span></span>
<span>        <span class="va">y.res.dif</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y.res</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">-</span> <span class="va">y.res.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="va">y.pear</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">-</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>          <span class="op">(</span><span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co">#residual</span></span>
<span>        <span class="va">y.pear.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">y.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">-</span> <span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span></span>
<span>          <span class="op">(</span><span class="va">N</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co">#predicted residual</span></span>
<span>        <span class="va">y.pear.dif</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y.pear</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span> <span class="op">-</span> <span class="va">y.pear.new</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span>,<span class="va">k</span><span class="op">]</span></span>
<span>        <span class="op">}</span> <span class="co">#end k</span></span>
<span>      <span class="op">}</span> <span class="co">#end t</span></span>
<span>    </span>
<span></span>
<span>    <span class="va">p.val1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y.res.dif</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="va">nyears</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">p.val2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y.pear.dif</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="va">nyears</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha</span><span class="op">[</span><span class="va">site</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="co">#priors:</span></span>
<span>  <span class="va">beta2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nlandtypes</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">beta1</span><span class="op">[</span><span class="va">m</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">alpha</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sd.site</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">sd.site</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">dexp</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'p.val1'</span>, <span class="st">'p.val2'</span><span class="op">)</span></span>
<span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="va">Lab7hares</span><span class="op">$</span><span class="va">inits</span></span>
<span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="va">Lab7hares</span><span class="op">$</span><span class="va">dat</span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="va">Lab7hares</span><span class="op">$</span><span class="va">consts</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="co">#each chain will be run separately </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, varlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ni"</span>,  <span class="st">"nc"</span>, <span class="st">'nd'</span>, <span class="st">"hare_mod"</span>, <span class="st">'params'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hares.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>,<span class="op">{</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span> <span class="co">#reload packages for each core</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">hare_mod</span>, constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">nd</span>, inits <span class="op">=</span> <span class="va">ni</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">params</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">50000</span>, nburnin <span class="op">=</span> <span class="fl">25000</span>, thin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co">#this will take awhile and not produce any progress bar</span></span>
<span><span class="va">hares.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">as.mcmc.list</a></span><span class="op">(</span><span class="va">hares.out</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="check-output">Check Output<a class="anchor" aria-label="anchor" href="#check-output"></a>
</h3>
<p>What did we find?</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hares.out</span><span class="op">)</span><span class="op">$</span><span class="va">quantiles</span></span>
<span><span class="co">#&gt;             2.5%    25%    50%    75%  97.5%</span></span>
<span><span class="co">#&gt; p.val1[1] 0.2059 0.2941 0.3235 0.3824 0.4706</span></span>
<span><span class="co">#&gt; p.val1[2] 0.2059 0.2941 0.3529 0.4118 0.5000</span></span>
<span><span class="co">#&gt; p.val1[3] 0.2353 0.3235 0.3824 0.4118 0.5000</span></span>
<span><span class="co">#&gt; p.val1[4] 0.1471 0.2059 0.2353 0.2647 0.3235</span></span>
<span><span class="co">#&gt; p.val1[5] 0.2941 0.3824 0.4412 0.5000 0.5882</span></span>
<span><span class="co">#&gt; p.val1[6] 0.1765 0.2353 0.2941 0.3235 0.4118</span></span>
<span><span class="co">#&gt; p.val1[7] 0.1471 0.2059 0.2353 0.2941 0.3529</span></span>
<span><span class="co">#&gt; p.val2[1] 0.2647 0.3529 0.4118 0.4706 0.5588</span></span>
<span><span class="co">#&gt; p.val2[2] 0.2941 0.3529 0.4118 0.4412 0.5294</span></span>
<span><span class="co">#&gt; p.val2[3] 0.3529 0.4412 0.4706 0.5294 0.5882</span></span>
<span><span class="co">#&gt; p.val2[4] 0.2647 0.3235 0.3529 0.4118 0.4706</span></span>
<span><span class="co">#&gt; p.val2[5] 0.4412 0.5294 0.5882 0.6176 0.7059</span></span>
<span><span class="co">#&gt; p.val2[6] 0.2647 0.3529 0.4118 0.4412 0.5294</span></span>
<span><span class="co">#&gt; p.val2[7] 0.1765 0.2647 0.2941 0.3235 0.4118</span></span></code></pre></div>
<p>According to our raw residuals (<code>pval1</code>), we can see that
the data from sites 4, 6 and 7 are potentially not fitting the model
very well. However none of the values are glaringly low, so this would
be more of a note in the discussion than a clear sign to throw out the
results.</p>
<p>For the p-value calculated using pearson residuals
(<code>pval2</code>), we can see that all the values look reasonable
except maybe for site 7.</p>
<p>Remember that p-values only tell us if there is an extreme error in
our model or a glaring problem with the fit, but are not very sensitive
to small violations.</p>
</div>
</div>
<div class="section level2">
<h2 id="posterior-predictive-checks---predictive-fit">Posterior Predictive Checks - Predictive Fit<a class="anchor" aria-label="anchor" href="#posterior-predictive-checks---predictive-fit"></a>
</h2>
<p>We can also use posterior prediction to assess how good our model is
at predicting future observations or assess the sensitivity of our
predictions to subsets of our data. Usually you’ll want to run two
checks - one for the observation model and one for a latent variable of
interest.</p>
<p>The easiest way to implement these checks are as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Run the model with all data and monitor the posterior of a latent
variable of interest (usually <span class="math inline">N</span> in an
N-mixture model or <span class="math inline">z</span> in an occupancy
model).</p></li>
<li><p>Remove some of the data provided to the model.</p></li>
<li><p>Run the model on the trimmed data set and monitor the posterior
of the latent variable from earlier. Also monitor the posterior for the
data points that were removed.</p></li>
<li><p>Compare posterior estimates for the latent variable between model
runs to estimate sensitivity of predictions. Compare the posterior
estimate of the missing data to the observed data to evaluate the
predictive ability of your observation model.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="predict-fit-on-simulated-data">Predict Fit on Simulated Data<a class="anchor" aria-label="anchor" href="#predict-fit-on-simulated-data"></a>
</h2>
<p>Let’s use some simulated dynamic occupancy data. We’ll pretend that
gamma increases when percent forest is higher.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">55</span><span class="op">)</span></span>
<span><span class="va">nyears</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span><span class="va">nsites</span> <span class="op">&lt;-</span> <span class="fl">40</span></span>
<span><span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">.8</span></span>
<span><span class="va">forest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">nsites</span>, <span class="fl">0</span>, <span class="fl">.5</span><span class="op">)</span></span>
<span><span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fl">.1</span> </span>
<span><span class="va">psi1</span> <span class="op">&lt;-</span> <span class="fl">.62</span></span>
<span><span class="va">nvisits</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">.4</span></span>
<span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nsites</span>, <span class="va">nyears</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">z</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">nsites</span>, <span class="fl">1</span>, <span class="va">psi1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">nvisits</span>, <span class="va">p</span><span class="op">)</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">z</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">phi</span><span class="op">)</span><span class="op">+</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">gamma</span><span class="op">+</span><span class="fl">.2</span><span class="op">*</span><span class="va">forest</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="va">nvisits</span>, <span class="va">p</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here’s the model we want to run. Note that we’re modeling <span class="math inline">\gamma</span> as a constant, even though we
simulated it as dependent on forest cover.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occ.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsites</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">~</span><span class="fu">dbern</span><span class="op">(</span><span class="va">psi</span><span class="op">)</span></span>
<span>  <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">nvisits</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">z</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span><span class="op">]</span> <span class="op">~</span><span class="fu">dbern</span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">phi</span><span class="op">)</span><span class="op">+</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="va">gamma</span><span class="op">)</span></span>
<span>    <span class="va">y</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span><span class="op">]</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">*</span><span class="va">nvisits</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="co">#end t</span></span>
<span><span class="op">}</span> <span class="co">#end i</span></span>
<span>  </span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">Tot.occ</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">nsites</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span>  </span>
<span><span class="va">gamma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> </span>
<span><span class="va">phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> </span>
<span><span class="va">p</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">psi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>To assess the sensitivity of our estimates of Total Occupancy, we’ll
first run the model with all the data and then run the model with years
14 and 15 removed.</p>
<div class="section level3">
<h3 id="run-the-model-with-full-data">Run the model with full data<a class="anchor" aria-label="anchor" href="#run-the-model-with-full-data"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Tot.occ'</span><span class="op">)</span></span>
<span><span class="va">n.c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nsites <span class="op">=</span> <span class="va">nsites</span>, nvisits <span class="op">=</span> <span class="va">nvisits</span>, nyears <span class="op">=</span> <span class="va">nyears</span><span class="op">)</span></span>
<span><span class="va">n.d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">z.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">nsites</span><span class="op">*</span><span class="va">nyears</span>, <span class="fl">1</span>, <span class="fl">.5</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">nyears</span><span class="op">)</span></span>
<span><span class="va">z.init</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> </span>
<span><span class="va">n.i</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, phi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, psi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, z <span class="op">=</span><span class="va">z.init</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occ_out1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html" class="external-link">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">occ.mod</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">n.d</span>,</span>
<span>                     constants <span class="op">=</span> <span class="va">n.c</span>,</span>
<span>                     inits <span class="op">=</span> <span class="fu">n.i</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     monitors <span class="op">=</span> <span class="va">params</span>,</span>
<span>                     thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     niter <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                     nburnin <span class="op">=</span> <span class="fl">2500</span>,</span>
<span>                     nchains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                     samplesAsCodaMCMC <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>                      <span class="op">)</span></span></code></pre></div>
<p>Excellent. Now let’s only give Nimble data for years 1 - 13 and see
how it fares. We also want to monitor the <code>y</code> parameter so
that we can look at our observation model.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Tot.occ'</span><span class="op">)</span></span>
<span><span class="va">y.partial</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span><span class="va">y.partial</span><span class="op">[</span>,<span class="fl">14</span><span class="op">:</span><span class="fl">15</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">n.d2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span><span class="va">y.partial</span><span class="op">)</span> <span class="co">#only some of the data</span></span>
<span><span class="va">y.init</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span><span class="va">y.init</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">n.i2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, phi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, psi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, z <span class="op">=</span><span class="va">z.init</span>, y <span class="op">=</span> <span class="va">y.init</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-the-model-with-partial-data">Run the model with partial data<a class="anchor" aria-label="anchor" href="#run-the-model-with-partial-data"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occ_out2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html" class="external-link">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">occ.mod</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">n.d2</span>,</span>
<span>                     constants <span class="op">=</span> <span class="va">n.c</span>,</span>
<span>                     inits <span class="op">=</span> <span class="fu">n.i2</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     monitors <span class="op">=</span> <span class="va">params</span>,</span>
<span>                     thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     niter <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                     nburnin <span class="op">=</span> <span class="fl">2500</span>,</span>
<span>                     nchains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                     samplesAsCodaMCMC <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>                      <span class="op">)</span></span></code></pre></div>
<p>Let’s start by comparing predictions in total occupancy. Remember
that this is latent, so we don’t know the ‘right’ answer, but knowing
how sensitive the model is to the amount of data can help us understand
how useful this model will be for predicting future dynamics. ###
Compare Total Occupancy</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Tot_occ1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">occ_out1</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">'Tot'</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">occ_out1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">quantiles</span></span>
<span><span class="va">Tot_occ2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">occ_out2</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">'Tot'</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">occ_out2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">quantiles</span></span>
<span></span>
<span><span class="va">gg_tot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Tot_occ1</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, <span class="va">Tot_occ2</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                     LCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Tot_occ1</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">Tot_occ2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                     UCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Tot_occ1</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span>, <span class="va">Tot_occ2</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                     Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                     Model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'All Data'</span>, <span class="st">'Incomplete Data'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">gg_tot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y<span class="op">=</span> <span class="va">Median</span>, col <span class="op">=</span> <span class="va">Model</span>, group <span class="op">=</span> <span class="va">Model</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">LCI</span>, ymax <span class="op">=</span> <span class="va">UCI</span><span class="op">)</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'firebrick4'</span>, <span class="st">'tan3'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab7_GOF_files/figure-html/unnamed-chunk-25-1.png" width="576" style="display: block; margin: auto;"></p>
<p>We can see that without the last 2 years of data our model predicts a
slightly higher number of sites will be occupied, but the 95% credible
intervals still overlap. However, I would probably be cautious about
predicting my model out more than 2 years into the future.</p>
</div>
</div>
<div class="section level2">
<h2 id="homework">Homework<a class="anchor" aria-label="anchor" href="#homework"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Using the Central hares dataset we used above, analyze the data
in a dynamic N-mixture model framework using the constant
parameterization of the Dail-Madsen model. Do not put any covariates on
<span class="math inline">\gamma</span> or <span class="math inline">\phi</span> and keep the same equation for <span class="math inline">\lambda</span> in year 1 that was used for the <span class="math inline">\lambda</span> in the lab example. Assess the
goodness of fit using the raw residuals as a discrepancy meaure to
calculate a Bayesian p-value. Does the goodness of fit test suggest any
glaring issues with model fit?</p></li>
<li><p>Write out the mathematical equation for the model you used in
Question 1. Include priors.</p></li>
<li><p>Using the simulated dynamic occupancy model, calculate a Bayesian
p-value for each year of data. Does the goodness of fit test detect any
issues? Use Pearson residuals to calculate the discrepancy.</p></li>
<li><p>On a 1-10 scale, with 1 being the worst week ever and 10 being
the best, how would you rate this week’s content? What lingering
questions/confusion about the lecture or lab do you still have?</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Clark Rushing, Heather Gaya.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
