<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>GLMs for modeling count data • WILD8370</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="GLMs for modeling count data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WILD8370</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2025.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-house-chimney"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../articles/syllabus.html"><span class="fa fab fa-readme"></span> Syllabus</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/schedule.html"><span class="fa far fa-calendar"></span> Schedule</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lectures" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-file-powerpoint"></span> Lectures</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lectures">
<li><a class="dropdown-item" href="../articles/lectures/00_course_intro/00_course_intro.html">Lecture 0: Course introduction</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/01_inference/01_inference.html">Lecture 1: Statistical inference in ecology</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/02_probability/02_probability.html">Lecture 2: Probability refresher</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/03_bayes/03_bayes.html">Lecture 3: Principles of Bayesian inference</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/04_intro_nimble/Intro_Nimble.html">Lecture 4: Introduction to Nimble</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/05_glms/05_glms.html">Lecture 5: Generalized linear model review</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/06_priors/06_priors.html">Lecture 6: More about priors</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/07_random_effects/07_random_effects.html">Lecture 7: Random vs. Fixed Effects</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/08_occupancy/08_occupancy.html">Lecture 8: State Space Models</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-labs" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-laptop-code"></span> Labs</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-labs">
<li><a class="dropdown-item" href="../articles/lab01_intro_to_R.html">Lab 0: Introduction to R</a></li>
    <li><a class="dropdown-item" href="../articles/Lab01b_Mathematical_Notation.html">Lab 1: Mathematical Notation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab2_simulation.html">Lab 2: Data Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab3_BasicMCMC.html">Lab 3: Basic MCMC</a></li>
    <li><a class="dropdown-item" href="../articles/Lab4_glms.html">Lab 4: GLMs</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Lab 5: Priors</a></li>
    <li><a class="dropdown-item" href="../articles/Lab6_MissingData.html">Lab 6: Missing Data</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-references" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-bookmark"></span> References</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-references">
<li><a class="dropdown-item" href="../articles/homework.html">Assignment instructions</a></li>
    <li><a class="dropdown-item" href="../articles/projects_and_directories.html">Projects and directories</a></li>
    <li><a class="dropdown-item" href="../articles/RMarkdown.html">R Markdown reference</a></li>
    <li><a class="dropdown-item" href="../articles/graphics.html">Creating publication-quality graphics</a></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>GLMs for modeling count data</h1>
                        <h4 data-toc-skip class="author">Clark
Rushing</h4>
            
      

      <div class="d-none name"><code>Lab4_glms.Rmd</code></div>
    </div>

    
    
<p>In this activity, we will analyze a small data set containing counts
of both population size and reproductive success using Poisson and
Binomial GLMs.</p>
<hr>
<p><strong>Objectives</strong></p>
<ul>
<li><p>Analyze count data using Poisson and Binomial GLMs</p></li>
<li><p>Gain experience diagnosing Nimble output to check
convergence</p></li>
<li>
<p><code>R</code> functions used in this exercise:</p>
<ul>
<li><code><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file()</a></code></li>
</ul>
</li>
</ul>
<hr>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>The data for this activity comes from a long-term project that
monitored a population of peregrine falcons nesting in the <a href="https://en.wikipedia.org/wiki/Jura_(department)" class="external-link">French Jura</a>
from 1964 to 2003 <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;All data and code used in this lab are from Kéry &amp;amp;
Schaub &lt;em&gt;Bayesian Population Analysis Using WinBugs&lt;/em&gt; and can be
accessed &lt;a href="https://www.vogelwarte.ch/de/projekte/publikationen/bpa/complete-code-and-data-files-of-the-book" class="external-link"&gt;here&lt;/a&gt;.
Note that the book uses JAGS, so the syntax will be slightly
different.&lt;/p&gt;'><sup>1</sup></a>.</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/7/7b/Peregrine_falcon_%28Australia%29.JPG" width="75%" style="display: block; margin: auto;"></p>
<p>Load and inspect the data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://rushinglab.github.io/WILD8370">WILD8370</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"falcons"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">falcons</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr>
<th style="text-align:right;">
Year
</th>
<th style="text-align:right;">
Pairs
</th>
<th style="text-align:right;">
R.Pairs
</th>
<th style="text-align:right;">
Eyasses
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1964
</td>
<td style="text-align:right;">
34
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
27
</td>
</tr>
<tr>
<td style="text-align:right;">
1965
</td>
<td style="text-align:right;">
45
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
30
</td>
</tr>
<tr>
<td style="text-align:right;">
1966
</td>
<td style="text-align:right;">
39
</td>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
36
</td>
</tr>
<tr>
<td style="text-align:right;">
1967
</td>
<td style="text-align:right;">
36
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
37
</td>
</tr>
<tr>
<td style="text-align:right;">
1968
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
19
</td>
</tr>
<tr>
<td style="text-align:right;">
1969
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
10
</td>
</tr>
</tbody>
</table>
<p>The falcons dataframe has 4 columns:</p>
<ul>
<li>Year: the year (integer).</li>
<li>Pairs: the number of adult pairs (integer).</li>
<li>R.pairs: the number of reproductive pairs (integer).</li>
<li>Eyasses: the number of fledged young (integer).</li>
</ul>
</div>
<div class="section level3">
<h3 id="analysis-1-change-in-population-size">Analysis 1: Change in population size<a class="anchor" aria-label="anchor" href="#analysis-1-change-in-population-size"></a>
</h3>
<p>The first model we will fit examines change in the number of adult
falcon pairs over time. Plotting the data shows that this change has not
been linear:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">falcons</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Pairs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">stat_smooth</span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab4_glms_files/figure-html/unnamed-chunk-5-1.png" width="576" style="display: block; margin: auto;"></p>
<p>After a short decline at the beginning of the study period, the
population then increased dramatically before perhaps reaching its
carrying capacity.</p>
<div class="section level4">
<h4 id="modeling-non-linear-effects-using-linear-models">Modeling non-linear effects using linear models<a class="anchor" aria-label="anchor" href="#modeling-non-linear-effects-using-linear-models"></a>
</h4>
<p>How can we model the non-linear change in abundance if, by
definition, linear models model linear effects? Using polynomials!</p>
<p>Remember the equation for a curved line with a single peak (or
bottom):</p>
<p><span class="math display">$$\Large y = a + b \times x + c \times
x^2$$</span></p>
<p><img src="Lab4_glms_files/figure-html/unnamed-chunk-6-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
is the maximum (or minimum) value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
is the value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
where this maximum (or minimum) occurs and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
determines whether the peak is a maximum
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">c&lt;0</annotation></semantics></math>)
or a minimum
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">c&gt;0</annotation></semantics></math>).</p>
<p>We can add more complex shape by adding additional polynomial terms.
For example, including a cubic term creates an s-shaped curve:</p>
<p><span class="math display">$$\Large y = a + b \times x + c \times x^2
+ d \times x^3$$</span></p>
<p><img src="Lab4_glms_files/figure-html/unnamed-chunk-7-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Including polynomial terms in the linear predictor on the model gives
us enormous flexibility to model non-linear relationships using
GLMs.</p>
</div>
<div class="section level4">
<h4 id="modeling-change-in-falcon-counts">Modeling change in falcon counts<a class="anchor" aria-label="anchor" href="#modeling-change-in-falcon-counts"></a>
</h4>
<p>To build a model for the falcon data, we need to define the
components required in all GLMs (the distribution, link function, and
linear predictor). Because these are counts, a natural choice for the
distribution is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>t</mi></msub><mo>∼</mo><mi>P</mi><mi>o</mi><mi>i</mi><mi>s</mi><mi>s</mi><mi>o</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>λ</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">C_t \sim Poisson(\lambda_t)</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>C</mi><mi>t</mi></msub><annotation encoding="application/x-tex">C_t</annotation></semantics></math>
is the observed count in year
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\lambda_t</annotation></semantics></math>
is the expected count.</p>
<p>As we learned in lecture, the conventional link function for count
data is the log-link:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>λ</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>λ</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">log(\lambda_t) = log(E(\lambda_t))</annotation></semantics></math></p>
<p>Finally, we need to write the linear predictor. Based on the
preliminary visualization of the data, a cubic polynomial might be
appropriate to capture the non-linear change over time:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>λ</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>α</mi><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><mo>×</mo><mi>y</mi><mi>e</mi><mi>a</mi><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><mo>×</mo><mi>y</mi><mi>e</mi><mi>a</mi><msubsup><mi>r</mi><mi>t</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>β</mi><mn>3</mn></msub><mo>×</mo><mi>y</mi><mi>e</mi><mi>a</mi><msubsup><mi>r</mi><mi>t</mi><mn>3</mn></msubsup></mrow><annotation encoding="application/x-tex">log(\lambda_t) = \alpha + \beta_1 \times year_t + \beta_2 \times year^2_t + \beta_3 \times year^3_t</annotation></semantics></math></p>
</div>
<div class="section level4">
<h4 id="accessing-and-viewing-the-nimble-model">Accessing and viewing the Nimble model<a class="anchor" aria-label="anchor" href="#accessing-and-viewing-the-nimble-model"></a>
</h4>
<p>You can copy and paste the following code into your own R script.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span></span>
<span><span class="va">falcon_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Priors</span></span>
<span>  <span class="va">alpha</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.33</span><span class="op">)</span></span>
<span>  <span class="va">beta1</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.33</span><span class="op">)</span></span>
<span>  <span class="va">beta2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.33</span><span class="op">)</span></span>
<span>  <span class="va">beta3</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.33</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Likelihood</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">C</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha</span> <span class="op">+</span> <span class="va">beta1</span> <span class="op">*</span> <span class="va">year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">pow</a></span><span class="op">(</span><span class="va">year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">beta3</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">pow</a></span><span class="op">(</span><span class="va">year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="co">#end i</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>From this file, you can see that we will use relatively
non-informative normal priors on each of the regression
coefficients.</p>
<p>You can also see that the likelihood statement is very similar to the
linear regression model from the last lecture, with a few minor
differences. First, because we assume the observed falcon counts come
from a Poisson distribution, we use <code>dpois(lambda[i])</code> rather
than <code>dnorm(mu[i], tau)</code>. Also, we have to apply the log-link
function to the predicted counts (<code>log(lambda[i])=...</code>).
Notice that Nimble allows you to model the transformed predicted counts
on the left hand side of the linear predictor equation</p>
<hr>
<p><strong>In Lab Questions</strong></p>
<ol style="list-style-type: decimal">
<li><p>Plot a histogram of random samples from the normal prior used in
the model (remember to convert the precision of <code>0.33</code> to
standard deviation). As you can see, this is not as vague as the normal
priors we have used in the past. What is the advantage of using
less-vague normal priors?</p></li>
<li><p>In the linear regression model we fit in the last lecture, we
also had a prior for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>,
the (inverse) of the process variance. Why do we not include that
parameter in this model?</p></li>
<li><p>Creating the <code>lambda[i]</code> object is not strictly
necessary since it is a deterministic function of year. If you wanted to
have fewer lines of code, you could include the linear predictor
directly inside of the <code><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois()</a></code> function instead of
<code>lambda[i]</code>, though you would need to appropriately transform
the linear predictor. What transformation would you use to put the
linear predictor on the count scale?</p></li>
</ol>
<hr>
</div>
<div class="section level4">
<h4 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h4>
<p>Before fitting the model, we need to prepare the input for Nimble
This includes:</p>
<ul>
<li><p>storing the data as a named list</p></li>
<li><p>storing constants as a named list</p></li>
<li><p>creating a function to randomly generate the initial values for
each parameter</p></li>
<li><p>creating a vector with the parameters we want Nimble to
monitor</p></li>
<li><p>set the MCMC settings</p></li>
</ul>
<p>We’ve mentioned several times, it’s often a bad idea to include
covariate values that are too far from 0. For this reason, we will first
scale <code>year</code> to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>e</mi><mi>a</mi><mi>n</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">mean=0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>d</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">sd=1</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">year</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">falcons</span><span class="op">$</span><span class="va">Year</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">falcons</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">falcons</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nimdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>C <span class="op">=</span> <span class="va">falcons</span><span class="op">$</span><span class="va">Pairs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nimconsts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">year</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">falcons</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">niminits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, beta1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, beta2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, beta3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta1"</span>, <span class="st">"beta2"</span>, <span class="st">"beta3"</span>, <span class="st">"lambda"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nC</span> <span class="op">&lt;-</span> <span class="fl">3</span> <span class="co">#chains</span></span>
<span></span>
<span><span class="va">nI</span> <span class="op">&lt;-</span> <span class="fl">10000</span> <span class="co">#iterations</span></span>
<span></span>
<span><span class="va">nB</span> <span class="op">&lt;-</span> <span class="fl">2500</span> <span class="co">#burnin</span></span>
<span></span>
<span><span class="va">nT</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co">#thin</span></span></code></pre></div>
<p>Now we’re ready to run the model. The easiest way to run a Nimble
model is to run it in one command:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">falcon_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html" class="external-link">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">falcon_mod</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">nimdat</span>,</span>
<span>                     constants <span class="op">=</span> <span class="va">nimconsts</span>,</span>
<span>                     inits <span class="op">=</span> <span class="fu">niminits</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     monitors <span class="op">=</span> <span class="va">params</span>,</span>
<span>                     thin <span class="op">=</span> <span class="va">nT</span>,</span>
<span>                     niter <span class="op">=</span> <span class="va">nI</span>,</span>
<span>                     nburnin <span class="op">=</span> <span class="va">nB</span>,</span>
<span>                     nchains <span class="op">=</span> <span class="va">nC</span>,</span>
<span>                     samplesAsCodaMCMC <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="co">#&gt; |-------------|-------------|-------------|-------------|</span></span>
<span><span class="co">#&gt; |-------------------------------------------------------|</span></span>
<span><span class="co">#&gt; |-------------|-------------|-------------|-------------|</span></span>
<span><span class="co">#&gt; |-------------------------------------------------------|</span></span>
<span><span class="co">#&gt; |-------------|-------------|-------------|-------------|</span></span>
<span><span class="co">#&gt; |-------------------------------------------------------|</span></span></code></pre></div>
<p>However, sometimes (when you get more advanced), you’ll want to be
able to customize your Nimble runs a little bit more. It’s also much
easier to error check your initial values on models that take a very
long time to run if you run it step by step. Here’s what that would look
like with one chain:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">falcon_mod</span>, constants <span class="op">=</span> <span class="va">nimconsts</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">nimdat</span>, inits <span class="op">=</span> <span class="fu">niminits</span><span class="op">(</span><span class="op">)</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't intialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">params</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="va">nI</span>, nburnin <span class="op">=</span> <span class="va">nB</span>, thin <span class="op">=</span> <span class="va">nT</span><span class="op">)</span></span>
<span><span class="va">falcon_res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu">as.mcmc</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>View a portion of the results (printing all of the
<code>lambda</code> values takes up too much room):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">falcon_res</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'alpha'</span>, <span class="st">'beta1'</span>, <span class="st">'beta2'</span>, <span class="st">'beta3'</span>, <span class="st">'lambda[1]'</span>, <span class="st">'lambda[2]'</span>, <span class="st">'lambda[3]'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">quantiles</span></span></code></pre></div>
<table class="table">
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
2.5%
</th>
<th style="text-align:right;">
25%
</th>
<th style="text-align:right;">
50%
</th>
<th style="text-align:right;">
75%
</th>
<th style="text-align:right;">
97.5%
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
alpha
</td>
<td style="text-align:right;">
4.1739
</td>
<td style="text-align:right;">
4.2103
</td>
<td style="text-align:right;">
4.2301
</td>
<td style="text-align:right;">
4.2516
</td>
<td style="text-align:right;">
4.2887
</td>
</tr>
<tr>
<td style="text-align:left;">
beta1
</td>
<td style="text-align:right;">
1.0190
</td>
<td style="text-align:right;">
1.0836
</td>
<td style="text-align:right;">
1.1170
</td>
<td style="text-align:right;">
1.1489
</td>
<td style="text-align:right;">
1.2057
</td>
</tr>
<tr>
<td style="text-align:left;">
beta2
</td>
<td style="text-align:right;">
-0.0399
</td>
<td style="text-align:right;">
-0.0079
</td>
<td style="text-align:right;">
0.0078
</td>
<td style="text-align:right;">
0.0241
</td>
<td style="text-align:right;">
0.0530
</td>
</tr>
<tr>
<td style="text-align:left;">
beta3
</td>
<td style="text-align:right;">
-0.2810
</td>
<td style="text-align:right;">
-0.2514
</td>
<td style="text-align:right;">
-0.2347
</td>
<td style="text-align:right;">
-0.2168
</td>
<td style="text-align:right;">
-0.1832
</td>
</tr>
<tr>
<td style="text-align:left;">
lambda[1]
</td>
<td style="text-align:right;">
26.5225
</td>
<td style="text-align:right;">
30.3368
</td>
<td style="text-align:right;">
32.4247
</td>
<td style="text-align:right;">
34.6385
</td>
<td style="text-align:right;">
38.9902
</td>
</tr>
<tr>
<td style="text-align:left;">
lambda[2]
</td>
<td style="text-align:right;">
25.5318
</td>
<td style="text-align:right;">
28.6873
</td>
<td style="text-align:right;">
30.3652
</td>
<td style="text-align:right;">
32.1225
</td>
<td style="text-align:right;">
35.5587
</td>
</tr>
<tr>
<td style="text-align:left;">
lambda[3]
</td>
<td style="text-align:right;">
24.9367
</td>
<td style="text-align:right;">
27.5302
</td>
<td style="text-align:right;">
28.9135
</td>
<td style="text-align:right;">
30.3248
</td>
<td style="text-align:right;">
33.1395
</td>
</tr>
</tbody>
</table>
<p>Note that beta2 appears to cross 0 - there’s not much of an effect of
year^2 on lambda.</p>
<p>This seems reasonable, but let’s make sure the <code>Rhat</code>
values are less than 1.1. To do this, we’ll use the
<code><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag()</a></code> function from the <code>coda</code>
package.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">falcon_res</span>, multivariate <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span> <span class="co">#don't want to print out all 40 lambdas</span></span>
<span><span class="co">#&gt;           Point est. Upper C.I.</span></span>
<span><span class="co">#&gt; alpha          1.004      1.014</span></span>
<span><span class="co">#&gt; beta1          1.016      1.056</span></span>
<span><span class="co">#&gt; beta2          1.003      1.010</span></span>
<span><span class="co">#&gt; beta3          1.016      1.058</span></span>
<span><span class="co">#&gt; lambda[1]      1.004      1.015</span></span>
<span><span class="co">#&gt; lambda[2]      1.003      1.010</span></span>
<span><span class="co">#&gt; lambda[3]      1.001      1.004</span></span>
<span><span class="co">#&gt; lambda[4]      1.000      1.001</span></span>
<span><span class="co">#&gt; lambda[5]      1.000      1.000</span></span>
<span><span class="co">#&gt; lambda[6]      1.001      1.003</span></span></code></pre></div>
<p>All parameters appear to have converged.</p>
<p>As usual, let’s check the trace plots to see how they look:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View traceplots for alpha, beta1, beta2, and beta3 (not for lambda)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">falcon_res</span><span class="op">[</span>,<span class="va">params</span><span class="op">[</span><span class="op">-</span><span class="fl">5</span><span class="op">]</span>,<span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab4_glms_files/figure-html/unnamed-chunk-15-1.png" width="576" style="display: block; margin: auto;"></p>
<p>By monitoring <code>lambda</code> we can also plot the predicted
counts along with the observed counts. First, we need to calculate the
posterior means and upper/lower bounds of the 95% credible interval and
add them to the falcons data frame, then use ggplot to visualize:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#get the quantiles for just the lambda parameters:</span></span>
<span><span class="va">lambdas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">falcon_res</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'lambda['</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">40</span>, <span class="st">']'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">quantiles</span> </span>
<span></span>
<span><span class="va">falcons</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">falcons</span>, lambda <span class="op">=</span> <span class="va">lambdas</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, </span>
<span>                                  q2.5 <span class="op">=</span> <span class="va">lambdas</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, </span>
<span>                                  q97.5 <span class="op">=</span> <span class="va">lambdas</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">falcons</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, ymin <span class="op">=</span> <span class="va">q2.5</span>, ymax <span class="op">=</span> <span class="va">q97.5</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_path</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">lambda</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Pairs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span><span class="st">"Pairs"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab4_glms_files/figure-html/unnamed-chunk-16-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level3">
<h3 id="analysis-2-nest-success-model">Analysis 2: Nest success model<a class="anchor" aria-label="anchor" href="#analysis-2-nest-success-model"></a>
</h3>
<p>Next, let’s use the <code>falcons</code> data set to fit another type
of GLM - the binomial GLM. Hopefully this exercise will show you that
once you’re comfortable writing out and coding the GLM components
(distribution, link function, and linear predictor), it is extremely
easy to fit models with different distributional assumptions.</p>
<p>To estimate reproductive success (i.e., the probability that a pair
successfully produces offspring), we will model the number of
reproductive pairs (<code>falcons$R.Pairs</code>) as a function of the
total number of pairs (<code>falcons$Pairs</code>).</p>
<p>Because the total number of reproductive pairs cannot exceed the
total number of pairs, the counts in <code>falcons$.RPairs</code> are
bounded to be less than <code>falcons$Pairs</code>. In this case, the
Poisson distribution is not an appropriate count model. Instead, we will
use the binomial distribution:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>t</mi></msub><mo>∼</mo><mi>b</mi><mi>i</mi><mi>n</mi><mi>o</mi><mi>m</mi><mi>i</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mi>t</mi></msub><mo>,</mo><msub><mi>p</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">C_t \sim binomial(N_t, p_t)</annotation></semantics></math></p>
<p>Our goal is to model
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>t</mi></msub><annotation encoding="application/x-tex">p_t</annotation></semantics></math>,
the probability of nesting successfully in each year. In this case, the
log link is not appropriate -
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>t</mi></msub><annotation encoding="application/x-tex">p_t</annotation></semantics></math>
is bound between 0 and 1. For probabilities, the logit link is generally
the appropriate link function:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>l</mi><mi>o</mi><mi>g</mi><mo minsize="2.4" maxsize="2.4" stretchy="false" form="prefix">(</mo><mfrac><msub><mi>p</mi><mi>t</mi></msub><mrow><mn>1</mn><mo>−</mo><msub><mi>p</mi><mi>t</mi></msub></mrow></mfrac><mo minsize="2.4" maxsize="2.4" stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">logit(p_t) = log\bigg(\frac{p_t}{1-p_t}\bigg)</annotation></semantics></math></p>
<p>Following Kéry &amp; Schaub, we’ll model probability as a quadratic
function of year:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>α</mi><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><mo>×</mo><mi>y</mi><mi>e</mi><mi>a</mi><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><mo>×</mo><mi>y</mi><mi>e</mi><mi>a</mi><msubsup><mi>r</mi><mi>t</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">logit(p_t) = \alpha + \beta_1 \times year_t + \beta_2 \times year^2_t</annotation></semantics></math></p>
<p>As in the last example, you can copy the code here. Note that in
Nimble the order for the arguments of a binomial are probability and
then size, unlike what we would type in R:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pairs_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Priors</span></span>
<span>  <span class="va">alpha</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.33</span><span class="op">)</span></span>
<span>  <span class="va">beta1</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.33</span><span class="op">)</span></span>
<span>  <span class="va">beta2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.33</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Likelihood</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nyears</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">C</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>, <span class="va">N</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha</span> <span class="op">+</span> <span class="va">beta1</span> <span class="op">*</span> <span class="va">year</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">pow</a></span><span class="op">(</span><span class="va">year</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="co">#end i</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>As before, we prepare the data and run the model:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#using standardized year from above</span></span>
<span><span class="va">nimdat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>C <span class="op">=</span> <span class="va">falcons</span><span class="op">$</span><span class="va">R.Pairs</span><span class="op">)</span></span>
<span><span class="va">nimconsts2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="va">falcons</span><span class="op">$</span><span class="va">Pairs</span>, year <span class="op">=</span> <span class="va">year</span>, nyears <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">falcons</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">niminits2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, beta1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, beta2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span><span class="va">params2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta1"</span>, <span class="st">"beta2"</span>, <span class="st">"p"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nC</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span></span>
<span><span class="va">nI</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span></span>
<span><span class="va">nB</span> <span class="op">&lt;-</span> <span class="fl">2500</span></span>
<span></span>
<span><span class="va">nT</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">pairs_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleMCMC.html" class="external-link">nimbleMCMC</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">pairs_mod</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">nimdat2</span>,</span>
<span>                     constants <span class="op">=</span> <span class="va">nimconsts2</span>,</span>
<span>                     inits <span class="op">=</span> <span class="fu">niminits2</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     monitors <span class="op">=</span> <span class="va">params2</span>,</span>
<span>                     thin <span class="op">=</span> <span class="va">nT</span>,</span>
<span>                     niter <span class="op">=</span> <span class="va">nI</span>,</span>
<span>                     nburnin <span class="op">=</span> <span class="va">nB</span>,</span>
<span>                     nchains <span class="op">=</span> <span class="va">nC</span>,</span>
<span>                     samplesAsCodaMCMC <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="co">#&gt; |-------------|-------------|-------------|-------------|</span></span>
<span><span class="co">#&gt; |-------------------------------------------------------|</span></span>
<span><span class="co">#&gt; |-------------|-------------|-------------|-------------|</span></span>
<span><span class="co">#&gt; |-------------------------------------------------------|</span></span>
<span><span class="co">#&gt; |-------------|-------------|-------------|-------------|</span></span>
<span><span class="co">#&gt; |-------------------------------------------------------|</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pairs_res</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'alpha'</span>, <span class="st">'beta1'</span>, <span class="st">'beta2'</span>, <span class="st">'p[1]'</span>, <span class="st">'p[2]'</span>, <span class="st">'p[3]'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">quantiles</span></span></code></pre></div>
<table class="table">
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
2.5%
</th>
<th style="text-align:right;">
25%
</th>
<th style="text-align:right;">
50%
</th>
<th style="text-align:right;">
75%
</th>
<th style="text-align:right;">
97.5%
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
alpha
</td>
<td style="text-align:right;">
0.6767
</td>
<td style="text-align:right;">
0.7476
</td>
<td style="text-align:right;">
0.7847
</td>
<td style="text-align:right;">
0.8212
</td>
<td style="text-align:right;">
0.8918
</td>
</tr>
<tr>
<td style="text-align:left;">
beta1
</td>
<td style="text-align:right;">
-0.0317
</td>
<td style="text-align:right;">
0.0285
</td>
<td style="text-align:right;">
0.0588
</td>
<td style="text-align:right;">
0.0890
</td>
<td style="text-align:right;">
0.1487
</td>
</tr>
<tr>
<td style="text-align:left;">
beta2
</td>
<td style="text-align:right;">
-0.3854
</td>
<td style="text-align:right;">
-0.3333
</td>
<td style="text-align:right;">
-0.3048
</td>
<td style="text-align:right;">
-0.2772
</td>
<td style="text-align:right;">
-0.2204
</td>
</tr>
<tr>
<td style="text-align:left;">
p[1]
</td>
<td style="text-align:right;">
0.3869
</td>
<td style="text-align:right;">
0.4349
</td>
<td style="text-align:right;">
0.4593
</td>
<td style="text-align:right;">
0.4852
</td>
<td style="text-align:right;">
0.5344
</td>
</tr>
<tr>
<td style="text-align:left;">
p[2]
</td>
<td style="text-align:right;">
0.4139
</td>
<td style="text-align:right;">
0.4591
</td>
<td style="text-align:right;">
0.4819
</td>
<td style="text-align:right;">
0.5056
</td>
<td style="text-align:right;">
0.5509
</td>
</tr>
<tr>
<td style="text-align:left;">
p[3]
</td>
<td style="text-align:right;">
0.4400
</td>
<td style="text-align:right;">
0.4821
</td>
<td style="text-align:right;">
0.5033
</td>
<td style="text-align:right;">
0.5250
</td>
<td style="text-align:right;">
0.5665
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View traceplots for alpha, beta1, and beta2(not for p)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pairs_res</span><span class="op">[</span>,<span class="va">params2</span><span class="op">[</span><span class="op">-</span><span class="fl">4</span><span class="op">]</span>,<span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab4_glms_files/figure-html/unnamed-chunk-20-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pairs_res</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'p['</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">40</span>, <span class="st">']'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">quantiles</span> </span>
<span><span class="va">falcons</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">falcons</span>, p <span class="op">=</span> <span class="va">ps</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, </span>
<span>                                  q2.5_p <span class="op">=</span> <span class="va">ps</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, </span>
<span>                                  q97.5_p <span class="op">=</span> <span class="va">ps</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">falcons</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, ymin <span class="op">=</span> <span class="va">q2.5_p</span>, ymax <span class="op">=</span> <span class="va">q97.5_p</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_path</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">p</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">R.Pairs</span><span class="op">/</span><span class="va">Pairs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span><span class="st">"Pairs"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab4_glms_files/figure-html/unnamed-chunk-21-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="homework-questions">Homework Questions<a class="anchor" aria-label="anchor" href="#homework-questions"></a>
</h2>
<p>Using what you’ve learned in this lab, write out a model for the
expected number of nestlings (Eyasses) per reproducing pair (R.pairs) in
each year.</p>
<ol style="list-style-type: lower-alpha">
<li>Begin by writing out the mathematical formulation of your model</li>
<li>Write out the Nimble code.</li>
<li>Provide your model with data, constants and initial values</li>
<li>Check your output for convergence</li>
<li>Display a ggplot showing the expected number of nestlings per
reproducing pair in each year (with 95% credible interval) vs the raw
data. Don’t forget a title and axis labels.</li>
</ol>
<p>It may help to plot the data first to see what type of data you are
working with:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">falcons</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Eyasses</span><span class="op">/</span><span class="va">R.Pairs</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">1</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab4_glms_files/figure-html/unnamed-chunk-22-1.png" width="576" style="display: block; margin: auto;"></p>
<ol start="2" style="list-style-type: decimal">
<li>In our second analysis, we used a binomial GLM to describe the
proportion of successful peregrine pairs per year in the French Jura
mountains. To see the connections between three important types of GLMs,
first use a Poisson GLM to model the number of successful pairs (thus
disregarding the fact that the binomial total varies by year), and
second, use a normal GLM to do the same. In the same graph, compare the
predicted numbers of successful pairs for every year under all three
models (binomial, Poisson, and normal GLMs). [This assignment stolen
directly from the WinBUGS book, so blame Marc Kéry and Michael Schaub
for this one.]</li>
</ol>
<p>Note: If you find that your normal distribution model predicts
extremely low counts, be sure to look at your priors. If selected
correctly, you should see all 3 models roughly overlap the raw data.</p>
<ol start="3" style="list-style-type: decimal">
<li>On a 1-10 scale, with 1 being the worst week ever and 10 being the
best, how would you rate this week’s content? What lingering
questions/confusion about the lecture or lab do you still have?</li>
</ol>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Clark Rushing, Heather Gaya.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
