<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Lab9: Spatial Capture Recapture • WILD8370</title>
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Lab9: Spatial Capture Recapture">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WILD8370</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2025.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-house-chimney"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../articles/syllabus.html"><span class="fa fab fa-readme"></span> Syllabus</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/schedule.html"><span class="fa far fa-calendar"></span> Schedule</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lectures" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-file-powerpoint"></span> Lectures</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lectures">
<li><a class="dropdown-item" href="../articles/lectures/00_course_intro/00_course_intro.html">Lecture 0: Course introduction</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/01_inference/01_inference.html">Lecture 1: Statistical inference in ecology</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/02_probability/02_probability.html">Lecture 2: Probability refresher</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/03_bayes/03_bayes.html">Lecture 3: Principles of Bayesian inference</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/04_intro_nimble/Intro_Nimble.html">Lecture 4: Introduction to Nimble</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/05_glms/05_glms.html">Lecture 5: Generalized linear model review</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/06_priors/06_priors.html">Lecture 6: More about priors</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/07_random_effects/07_random_effects.html">Lecture 7: Random vs. Fixed Effects</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/08_occupancy/08_occupancy.html">Lecture 8: State Space Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/09_NMix/09_NMix.html">Lecture 9: N-Mixture and Occupancy</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/11_DynamicNMix/11_DynamicNMix.html">Lecture 11: Dynamic N-Mixture Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/9b_ExtraOcc/9b_ExtraOcc.html">Lecture 9b: Static Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/10_DynamicOcc/10_DynamicOcc.html">Lecture 10: Dynamic Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/12_MovementModels/12_MovementModels.html">Lecture 12: Movement Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/13_ClosedCMR/Lecture13_ClosedCMR.html">Lecture 13: Closed CMR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/14_ClosedSCR/Lecture14_ClosedSCR.html">Lecture 14: Closed SCR</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-labs" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-laptop-code"></span> Labs</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-labs">
<li><a class="dropdown-item" href="../articles/lab01_intro_to_R.html">Lab 0: Introduction to R</a></li>
    <li><a class="dropdown-item" href="../articles/Lab01b_Mathematical_Notation.html">Lab 1: Mathematical Notation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab2_simulation.html">Lab 2: Data Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab3_BasicMCMC.html">Lab 3: Basic MCMC</a></li>
    <li><a class="dropdown-item" href="../articles/Lab4_glms.html">Lab 4: GLMs</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Lab 5: Priors</a></li>
    <li><a class="dropdown-item" href="../articles/Lab6_MissingData.html">Lab 6: Missing Data</a></li>
    <li><a class="dropdown-item" href="../articles/Lab7_GOF.html">Lab 7: Goodness of Fit</a></li>
    <li><a class="dropdown-item" href="../articles/Lab8_Movement.html">Lab 8: Resource Selection Functions</a></li>
    <li><a class="dropdown-item" href="../articles/Lab9_SCR.html">Lab 9: Spatial Capture Recapture</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-references" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-bookmark"></span> References</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-references">
<li><a class="dropdown-item" href="../articles/homework.html">Assignment instructions</a></li>
    <li><a class="dropdown-item" href="../articles/projects_and_directories.html">Projects and directories</a></li>
    <li><a class="dropdown-item" href="../articles/RMarkdown.html">R Markdown reference</a></li>
    <li><a class="dropdown-item" href="../articles/graphics.html">Creating publication-quality graphics</a></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Lab9: Spatial Capture Recapture</h1>
            
      

      <div class="d-none name"><code>Lab9_SCR.Rmd</code></div>
    </div>

    
    
<p>In this activity we’ll practice running both a spatial and
non-spatial mark recapture model on some data.</p>
<div class="section level2">
<h2 id="butterflies">Butterflies!<a class="anchor" aria-label="anchor" href="#butterflies"></a>
</h2>
<p>Today’s dataset is on a study of false heath fritillary butterflies
(<em>Melitaea diamina</em>) conducted in Finland. You can find more
details about this study here:</p>
<p>Fabritius, H., Rönkä, K. &amp; Ovaskainen, O. The dual role of rivers
in facilitating or hindering movements of the false heath fritillary
butterfly. Mov Ecol 3, 4 (2015). <a href="https://doi.org/10.1186/s40462-015-0031-z" class="external-link uri">https://doi.org/10.1186/s40462-015-0031-z</a></p>
<p>The full study uses three datasets but today we will be only using
the data from 1995.</p>
<p>**In case the authors read this and wonder what the heck we are
teaching American students, I have modified the habitat information to
be simpler than the original study. So the results will be slightly off
from the original study.</p>
<p>From the authors:</p>
<p>Details of the three data sets summarized below. The number of search
days without (with) parenthesis indicates the length of study period
(versus the number of effective search days with search activity).</p>
<ul>
<li>Location: Siitama, Pirkanmaa, Finland (61.6°N, 24.2°E)</li>
<li>Year of data collection: 1995</li>
<li>Coordinator: Niklas Wahlberg</li>
<li>Coordinate reference system: Finland Zone 3 (EPSG:2393)</li>
</ul>
<p>We will work with 4 files to get the information we need:</p>
<ol style="list-style-type: decimal">
<li>Effort log - a 1/0 matrix indicating if the ‘trap’ was
operational</li>
<li>Records of each time an individual was captured (and what trap)</li>
<li>Trap locations in Finland Zone 3 units</li>
<li>Habitat information about the trapping area</li>
</ol>
</div>
<div class="section level2">
<h2 id="summary-info">Summary Info<a class="anchor" aria-label="anchor" href="#summary-info"></a>
</h2>
<p>Let’s see how many individuals we have and what our effort looks
like:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'butterflies'</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effort</span> <span class="op">&lt;-</span> <span class="va">Finnish_butterflies</span><span class="op">$</span><span class="va">effort</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">effort</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    112 obs. of  15 variables:</span></span>
<span><span class="co">#&gt;  $ Trap: int  1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span><span class="co">#&gt;  $ V1  : int  1 1 0 0 0 1 1 1 0 0 ...</span></span>
<span><span class="co">#&gt;  $ V2  : int  1 1 1 1 0 1 1 1 1 0 ...</span></span>
<span><span class="co">#&gt;  $ V3  : int  0 0 0 0 0 0 0 0 1 0 ...</span></span>
<span><span class="co">#&gt;  $ V4  : int  0 0 0 0 0 1 0 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ V5  : int  1 1 1 1 1 1 0 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ V6  : int  0 0 0 1 1 1 0 1 0 0 ...</span></span>
<span><span class="co">#&gt;  $ V7  : int  0 0 0 0 1 1 0 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ V8  : int  1 0 1 1 1 1 0 1 0 0 ...</span></span>
<span><span class="co">#&gt;  $ V9  : int  0 0 1 0 1 1 0 1 0 0 ...</span></span>
<span><span class="co">#&gt;  $ V10 : int  0 0 0 0 1 1 0 1 0 1 ...</span></span>
<span><span class="co">#&gt;  $ V11 : int  0 0 0 0 1 1 0 1 0 0 ...</span></span>
<span><span class="co">#&gt;  $ V12 : int  0 0 0 0 1 1 0 1 0 0 ...</span></span>
<span><span class="co">#&gt;  $ V13 : int  0 0 0 0 1 1 0 1 0 0 ...</span></span>
<span><span class="co">#&gt;  $ V14 : int  0 0 0 0 1 1 0 1 0 0 ...</span></span></code></pre></div>
<p>There appear to be 14 trap occasions and 112 traps.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">caps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">Finnish_butterflies</span><span class="op">$</span><span class="va">cap_hist</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">caps</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Individual Day Trap Sex</span></span>
<span><span class="co">#&gt; 1          1  10   72   0</span></span>
<span><span class="co">#&gt; 2          1   2   72   1</span></span>
<span><span class="co">#&gt; 3          1   3   72   1</span></span>
<span><span class="co">#&gt; 4          1   4   72   1</span></span>
<span><span class="co">#&gt; 5          1   6   72   1</span></span>
<span><span class="co">#&gt; 6          1   1   74   0</span></span></code></pre></div>
<p>The data gives us one row per capture. The individual ID is given for
each capture, as well as the day, and trap of this capture. We also have
some indication of sex (as a binary variable).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">caps</span><span class="op">$</span><span class="va">Individual</span>, <span class="va">caps</span><span class="op">$</span><span class="va">Day</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab9_SCR_files/figure-html/unnamed-chunk-5-1.png" width="768" style="display: block; margin: auto;">
Most individuals were only captured once, but a few individuals were
capture up to 8 times!</p>
</div>
<div class="section level2">
<h2 id="non-spatial-cmr">Non-Spatial CMR<a class="anchor" aria-label="anchor" href="#non-spatial-cmr"></a>
</h2>
<p>Let’s begin by analyzing the data in a non-spatial framework. We know
that sometimes not all areas were surveyed, so we’ll model detection
probability as a function of the number of traps that were open.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmr_flies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">psi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="co">#N/M</span></span>
<span>  <span class="va">alpha0</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">alpha1</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nocc</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha0</span> <span class="op">+</span> <span class="va">alpha1</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">t</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">psi</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nocc</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="co"># end t</span></span>
<span>  <span class="op">}</span> <span class="co"># end i</span></span>
<span>  </span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">EN</span> <span class="op">&lt;-</span> <span class="va">M</span><span class="op">*</span><span class="va">psi</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We can start by putting our capture data into a different format. We
want one row per individual, one column per occasion. We also need to
choose a value of <span class="math inline">M</span>. Our goal is simply
to choose a value of M such that <span class="math inline">N/M &lt;
1</span>. Of course, we don’t <em>know</em> <span class="math inline">N</span>, so this is tricky.</p>
<p>Let’s start by choosing a value that will likely be too small so we
can see what happens. I’ll choose <span class="math inline">M</span> =
<code>nind</code> + 10, which would suggest we only missed 10
butterflies in the entire population when sampling.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">caps</span><span class="op">$</span><span class="va">Individual</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nocc</span> <span class="op">&lt;-</span> <span class="fl">14</span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="va">nind</span> <span class="op">+</span> <span class="fl">10</span> </span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">nocc</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>Note that I create an array that has <span class="math inline">M</span> rows, not <span class="math inline">nind</span> rows. This is because we need to tell
the model the capture history of EVERY individual that could potentially
be in the population, including the ones we never saw.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">caps</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">y</span><span class="op">[</span><span class="va">caps</span><span class="op">$</span><span class="va">Individual</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">caps</span><span class="op">$</span><span class="va">Day</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,]    1    1    1    1    0    1    0    0    0     1     0     0     0     0</span></span>
<span><span class="co">#&gt; [2,]    1    0    0    0    1    1    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [3,]    1    0    0    0    0    0    0    1    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]    1    0    0    0    1    1    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]    0    1    0    1    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [6,]    0    1    0    1    1    1    0    0    0     0     0     0     0     0</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt;        [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13]</span></span>
<span><span class="co">#&gt; [161,]    0    0    0    0    0    0    0    0    0     0     0     0     0</span></span>
<span><span class="co">#&gt; [162,]    0    0    0    0    0    0    0    0    0     0     0     0     0</span></span>
<span><span class="co">#&gt; [163,]    0    0    0    0    0    0    0    0    0     0     0     0     0</span></span>
<span><span class="co">#&gt; [164,]    0    0    0    0    0    0    0    0    0     0     0     0     0</span></span>
<span><span class="co">#&gt; [165,]    0    0    0    0    0    0    0    0    0     0     0     0     0</span></span>
<span><span class="co">#&gt; [166,]    0    0    0    0    0    0    0    0    0     0     0     0     0</span></span>
<span><span class="co">#&gt;        [,14]</span></span>
<span><span class="co">#&gt; [161,]     0</span></span>
<span><span class="co">#&gt; [162,]     0</span></span>
<span><span class="co">#&gt; [163,]     0</span></span>
<span><span class="co">#&gt; [164,]     0</span></span>
<span><span class="co">#&gt; [165,]     0</span></span>
<span><span class="co">#&gt; [166,]     0</span></span></code></pre></div>
<p>Next we can cleanup effort, which will tell the model the number of
traps open per occasion.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">effort</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Trap V1 V2 V3 V4 V5 V6 V7 V8 V9 V10 V11 V12 V13 V14</span></span>
<span><span class="co">#&gt; 1    1  1  1  0  0  1  0  0  1  0   0   0   0   0   0</span></span>
<span><span class="co">#&gt; 2    2  1  1  0  0  1  0  0  0  0   0   0   0   0   0</span></span>
<span><span class="co">#&gt; 3    3  0  1  0  0  1  0  0  1  1   0   0   0   0   0</span></span>
<span><span class="co">#&gt; 4    4  0  1  0  0  1  1  0  1  0   0   0   0   0   0</span></span>
<span><span class="co">#&gt; 5    5  0  0  0  0  1  1  1  1  1   1   1   1   1   1</span></span>
<span><span class="co">#&gt; 6    6  1  1  0  1  1  1  1  1  1   1   1   1   1   1</span></span>
<span><span class="va">eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">effort</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span></code></pre></div>
<p>Above, we’re taking the column sums, which will give us a count of
how many traps were open. Notice that column 1 is trap ID, so we don’t
add that one up for our effort vector.</p>
<div class="section level4">
<h4 id="first-try-cmr">First Try CMR<a class="anchor" aria-label="anchor" href="#first-try-cmr"></a>
</h4>
<p>Now let’s make our objects and run the model!</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>effort <span class="op">=</span> <span class="va">eff</span>,nocc <span class="op">=</span> <span class="va">nocc</span>, M <span class="op">=</span> <span class="va">M</span><span class="op">)</span></span>
<span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="va">z.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nind</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">M</span><span class="op">-</span><span class="va">nind</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>psi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z.init</span><span class="op">)</span><span class="op">/</span><span class="va">M</span>, alpha0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, alpha1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, z <span class="op">=</span> <span class="va">z.init</span><span class="op">)</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'alpha0'</span>, <span class="st">'alpha1'</span>, <span class="st">'psi'</span>, <span class="st">'N'</span><span class="op">)</span></span></code></pre></div>
<p>We’ll start with the long way of running the model look for problems
with initial values:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">cmr_flies</span>, constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">nd</span>, inits <span class="op">=</span> <span class="va">ni</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="co">#&gt; [1] -19006</span></span></code></pre></div>
<p>Uh oh! Let’s figure out what went wrong.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">$</span><span class="va">logProb_z</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -37.79</span></span></code></pre></div>
<p>Nothing wrong with the z values. Is y the problem?</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">$</span><span class="va">logProb_y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -18965</span></span></code></pre></div>
<p>Yes! The log probability is -Inf. That’s not great.</p>
<p>Individual 1 seems to have issues:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepnim</span><span class="op">$</span><span class="va">logProb_y</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;  [1] -8.974e-06 -3.247e-07 -1.077e-01 -1.930e-05 -1.392e+01 -1.170e-07</span></span>
<span><span class="co">#&gt;  [7] -1.213e+01 -1.596e+01 -1.009e+01 -2.492e-05 -9.834e+00 -7.281e+00</span></span>
<span><span class="co">#&gt; [13] -1.034e+01 -6.261e+00</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepnim</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 0 1 0 0 0 1 0 0 0 0</span></span></code></pre></div>
<p>Hmm, it doesn’t like when we didn’t see it. What did we initialize p
as?</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepnim</span><span class="op">$</span><span class="va">p</span></span>
<span><span class="co">#&gt;  [1] 1.0000 1.0000 0.8979 1.0000 1.0000 1.0000 1.0000 1.0000 1.0000 1.0000</span></span>
<span><span class="co">#&gt; [11] 0.9999 0.9993 1.0000 0.9981</span></span></code></pre></div>
<p>Oops! We told the model our detection probability was way too high!
Let’s try again with lower values:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>psi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z.init</span><span class="op">)</span><span class="op">/</span><span class="va">M</span>, alpha0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, </span>
<span>           alpha1 <span class="op">=</span> <span class="fl">0</span>, z <span class="op">=</span> <span class="va">z.init</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">cmr_flies</span>, constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">nd</span>, inits <span class="op">=</span> <span class="va">ni</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="co">#&gt; [1] -1161</span></span></code></pre></div>
<p>Much better. We can now run the model.</p>
</div>
<div class="section level4">
<h4 id="second-try-cmr">Second Try CMR<a class="anchor" aria-label="anchor" href="#second-try-cmr"></a>
</h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="co">#each chain will be run separately </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, varlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ni"</span>,  <span class="st">"nc"</span>, <span class="st">'nd'</span>, <span class="st">"cmr_flies"</span>, <span class="st">'params'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cmr1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>,<span class="op">{</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span> <span class="co">#reload packages for each core</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">cmr_flies</span>, constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">nd</span>, inits <span class="op">=</span> <span class="va">ni</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">params</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">50000</span>, nburnin <span class="op">=</span> <span class="fl">25000</span>, thin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co">#this will take awhile and not produce any progress bar</span></span>
<span><span class="va">cmr1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">as.mcmc.list</a></span><span class="op">(</span><span class="va">cmr1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Let’s see what our model output gives us.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">cmr1</span>, pdf <span class="op">=</span> <span class="cn">F</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab9_SCR_files/figure-html/unnamed-chunk-21-1.png" width="768" style="display: block; margin: auto;"><img src="Lab9_SCR_files/figure-html/unnamed-chunk-21-2.png" width="768" style="display: block; margin: auto;"></p>
<p>Uh oh! Our value for <span class="math inline">M</span> is clearly
way too low. The posterior for <span class="math inline">psi</span> is
pushing up against 1, which means we’ve enforced a total population that
is lower than the number the data is suggesting. Let’s try again with a
higher M.</p>
<p>One way to choose a value of M is to look at the raw detection
frequency:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">caps</span><span class="op">$</span><span class="va">Individual</span>, <span class="va">caps</span><span class="op">$</span><span class="va">Day</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2.628</span></span></code></pre></div>
<p>On average, we saw each butterfly 2.6 times, despite going out for 14
days. That tells us that a good starting M might be about <span class="math inline">nind * 14/2.6</span> which is ~ <span class="math inline">nind*5.4</span></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> <span class="va">nind</span><span class="op">*</span><span class="fl">6</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">nocc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">caps</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">y</span><span class="op">[</span><span class="va">caps</span><span class="op">$</span><span class="va">Individual</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">caps</span><span class="op">$</span><span class="va">Day</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>effort <span class="op">=</span> <span class="va">eff</span>,nocc <span class="op">=</span> <span class="va">nocc</span>, M <span class="op">=</span> <span class="va">M</span><span class="op">)</span></span>
<span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="va">z.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nind</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">M</span><span class="op">-</span><span class="va">nind</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>psi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z.init</span><span class="op">)</span><span class="op">/</span><span class="va">M</span>, alpha0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, alpha1 <span class="op">=</span> <span class="fl">0</span>, z <span class="op">=</span> <span class="va">z.init</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="third-try-cmr">Third Try CMR<a class="anchor" aria-label="anchor" href="#third-try-cmr"></a>
</h4>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="co">#each chain will be run separately </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, varlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ni"</span>,  <span class="st">"nc"</span>, <span class="st">'nd'</span>, <span class="st">"cmr_flies"</span>, <span class="st">'params'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cmr2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>,<span class="op">{</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span> <span class="co">#reload packages for each core</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">cmr_flies</span>, constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">nd</span>, inits <span class="op">=</span> <span class="va">ni</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">params</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">50000</span>, nburnin <span class="op">=</span> <span class="fl">25000</span>, thin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co">#this will take awhile and not produce any progress bar</span></span>
<span><span class="va">cmr2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">as.mcmc.list</a></span><span class="op">(</span><span class="va">cmr2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Let’s see what our model output gives us.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">cmr2</span>, pdf <span class="op">=</span> <span class="cn">F</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab9_SCR_files/figure-html/unnamed-chunk-26-1.png" width="768" style="display: block; margin: auto;"><img src="Lab9_SCR_files/figure-html/unnamed-chunk-26-2.png" width="768" style="display: block; margin: auto;"></p>
<p>Much better! We can see that this time our M was large enough - only
about 18% of the M individuals were probably even real. The fact that we
chose an M that was too large doesn’t matter, but it does slow down our
model runs a little bit. Remember that biologically, <span class="math inline">psi</span> means nothing. If we were to run this
again, we could drop the value of M down by a few hundred and still get
the same result with less computer time.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html" class="external-link">MCMCsummary</a></span><span class="op">(</span><span class="va">cmr2</span><span class="op">)</span></span>
<span><span class="co">#&gt;             mean       sd      2.5%       50%     97.5% Rhat n.eff</span></span>
<span><span class="co">#&gt; N      169.66491 4.437504 162.00000 169.00000 179.00000    1 33068</span></span>
<span><span class="co">#&gt; alpha0  -3.46048 0.237253  -3.93749  -3.45911  -2.97955    1   527</span></span>
<span><span class="co">#&gt; alpha1   0.03619 0.004392   0.02728   0.03615   0.04498    1   516</span></span>
<span><span class="co">#&gt; psi      0.18199 0.013482   0.15643   0.18173   0.20910    1 53989</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="graphing-detection-probability">Graphing Detection Probability<a class="anchor" aria-label="anchor" href="#graphing-detection-probability"></a>
</h3>
<p>Before we move on, let’s graph how detection probability is expected
to increase with increasing effort (traps open).</p>
<p>Remember that our equation for detection is:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimble-math.html" class="external-link">logit</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">alpha0</span> <span class="op">+</span> <span class="va">alpha1</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">t</span><span class="op">]</span></span></code></pre></div>
<p>We can replicate that with R code and our MCMC chains to get a CI for
detection over different levels of effort. We’ll first create a vector
with all the possible values of effort we want to plot along, and then
use the equation above to estimate the value of p for each level of
effort using each iteration of the MCMC. Then we’ll take the quantiles
of those estimates to get the CI of the posterior.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alphas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">cmr2</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'alpha0'</span>, <span class="st">'alpha1'</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">effort_seq</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">112</span> </span>
<span><span class="va">niter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">alphas</span><span class="op">)</span></span>
<span><span class="va">p_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">niter</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">effort_seq</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">niter</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">p_out</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">alphas</span><span class="op">[</span><span class="va">j</span>,<span class="st">'alpha0'</span><span class="op">]</span> <span class="op">+</span> <span class="va">alphas</span><span class="op">[</span><span class="va">j</span>,<span class="st">'alpha1'</span><span class="op">]</span><span class="op">*</span><span class="va">effort_seq</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">p.CI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">p_out</span>, <span class="fl">2</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">.5</span>, <span class="fl">.975</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Time to graph!</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gg.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>effort <span class="op">=</span> <span class="va">effort_seq</span>,</span>
<span>                   LCI <span class="op">=</span> <span class="va">p.CI</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>,</span>
<span>                   UCI <span class="op">=</span> <span class="va">p.CI</span><span class="op">[</span><span class="fl">3</span>,<span class="op">]</span>,</span>
<span>                   Median <span class="op">=</span> <span class="va">p.CI</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">gg.p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">effort</span>, y <span class="op">=</span> <span class="va">Median</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">LCI</span>, ymax <span class="op">=</span> <span class="va">UCI</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.4</span>, fill <span class="op">=</span> <span class="st">'lightblue'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Detection Probability"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Number of Traps Open"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">25</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab9_SCR_files/figure-html/unnamed-chunk-30-1.png" width="768" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="spatial-capture-recapture">Spatial Capture Recapture<a class="anchor" aria-label="anchor" href="#spatial-capture-recapture"></a>
</h2>
<p>Now that we’ve analyzed the data in a non-spatial manner, let’s try
fitting the data to a spatial model.</p>
<p>There are 3 types of habitat designated by the authors: - Low quality
matrix (habitat type 1) - High quality matrix (habitat type 3) -
Breeding area (habitat 2)</p>
<p>It’s likely that butterfly abundance is different in each of these
habitat types. We’ll want to include that in our model for lambda.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scr_flies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleCode.html" class="external-link">nimbleCode</a></span><span class="op">(</span><span class="op">{</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">beta0</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span><span class="va">g0</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">sigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">g</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">)</span> <span class="op">{</span> <span class="co">## Loop over pixels</span></span>
<span>  <span class="va">lambda</span><span class="op">[</span><span class="va">g</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">beta0</span><span class="op">[</span><span class="va">habitat</span><span class="op">[</span><span class="va">g</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="va">pixelArea</span></span>
<span>  <span class="va">pi</span><span class="op">[</span><span class="va">g</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lambda</span><span class="op">[</span><span class="va">g</span><span class="op">]</span><span class="op">/</span><span class="va">SumLambda</span></span>
<span><span class="op">}</span></span>
<span><span class="va">SumLambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">G</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">psi</span> <span class="op">&lt;-</span> <span class="va">SumLambda</span><span class="op">/</span><span class="va">M</span> <span class="co">#proportion real</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">xlim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">xlim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> </span>
<span>  <span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">ylim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">ylim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">pixel</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lookup</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">ylim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">delta</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span>,  <span class="co">## raster row</span></span>
<span>                     <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="va">xlim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">delta</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span><span class="op">]</span>  <span class="co">## raster column</span></span>
<span>  <span class="va">logProb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">pi</span><span class="op">[</span><span class="va">pixel</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">zeros</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="op">-</span><span class="va">logProb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="co">## zeros trick for IPP</span></span>
<span>  <span class="va">z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">psi</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">ntraps</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dist</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="va">j</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="va">j</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">p</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">g0</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">dist</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span> <span class="op">{</span>  <span class="co">## Model for capture histories</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">ntraps</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nocc</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span><span class="op">*</span><span class="va">z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">effort</span><span class="op">[</span><span class="va">j</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">EN</span> <span class="op">&lt;-</span> <span class="va">M</span><span class="op">*</span><span class="va">psi</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>In the spatial model, there’s a little more data cleanup than before.
One part we haven’t dealt with before is the lookup table and the
habitat. Let’s take a look at our habitat information.</p>
<div class="section level3">
<h3 id="pixel-lookup">Pixel Lookup<a class="anchor" aria-label="anchor" href="#pixel-lookup"></a>
</h3>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">habitat</span> <span class="op">&lt;-</span> <span class="va">Finnish_butterflies</span><span class="op">$</span><span class="va">habitat</span></span>
<span><span class="va">habitat_sp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">habitat</span>, type <span class="op">=</span> <span class="st">'xyz'</span>, crs <span class="op">=</span> <span class="st">'EPSG:2393'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">habitat_sp</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab9_SCR_files/figure-html/unnamed-chunk-32-1.png" width="768" style="display: block; margin: auto;"></p>
<p>We can see that most of the habitat is low-quality (type 3) with some
high quality (type 3) and breeding area (type 2) mixed in here and
there.</p>
<p>If we were to look at the habitat information as a vector, it would
look like:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">habitat</span><span class="op">$</span><span class="va">layer</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 3 2 1 3 3 1 1 1 1 1 3 3 2 3 3 3 1 3 3 3 3 2 3 2 1 3 2 1 1</span></span>
<span><span class="co">#&gt; [39] 1 1 3 3 3 2 3 3 2 1 1 1 1 1 1 2 3 1 1 1 1 1 1 1 3 3 2 1 1 1 1 1 1 1 1 3 3 3</span></span>
<span><span class="co">#&gt; [77] 1</span></span></code></pre></div>
<p>The order of the pixels goes from the top left pixel to the top
right, then down one row starting on the left and going across again,
etc. until we end at the bottom right pixel.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">habitat_sp</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  7 11  1</span></span>
<span><span class="va">pixel_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">habitat_sp</span><span class="op">)</span><span class="op">)</span>, byrow <span class="op">=</span> <span class="cn">T</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">habitat_sp</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">pixel_order</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11]</span></span>
<span><span class="co">#&gt; [1,]    1    2    3    4    5    6    7    8    9    10    11</span></span>
<span><span class="co">#&gt; [2,]   12   13   14   15   16   17   18   19   20    21    22</span></span>
<span><span class="co">#&gt; [3,]   23   24   25   26   27   28   29   30   31    32    33</span></span>
<span><span class="co">#&gt; [4,]   34   35   36   37   38   39   40   41   42    43    44</span></span>
<span><span class="co">#&gt; [5,]   45   46   47   48   49   50   51   52   53    54    55</span></span>
<span><span class="co">#&gt; [6,]   56   57   58   59   60   61   62   63   64    65    66</span></span>
<span><span class="co">#&gt; [7,]   67   68   69   70   71   72   73   74   75    76    77</span></span></code></pre></div>
<p>Therefore making our habitat object for Nimble is really easy:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">habitat</span><span class="op">$</span><span class="va">layer</span><span class="op">)</span></span></code></pre></div>
<p>Let’s say I had a point with coordinates c(3237000, 6832000). How do
I figure out what pixel I’m in? First I need the pixel resolution of my
raster and the minimum and maximum values of my state space. Then I can
subtract each point by its the limit value and divide by the width of my
pixel to find where I am.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myx</span> <span class="op">&lt;-</span> <span class="fl">3237000</span><span class="op">/</span><span class="fl">1e5</span></span>
<span><span class="va">myy</span> <span class="op">&lt;-</span> <span class="fl">6832000</span><span class="op">/</span><span class="fl">1e5</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="va">habitat_sp</span><span class="op">)</span><span class="op">/</span><span class="fl">1e5</span></span>
<span><span class="co">#&gt; [1] 0.005 0.005</span></span>
<span><span class="va">lims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">habitat_sp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1e5</span></span>
<span><span class="va">lims</span></span>
<span><span class="co">#&gt; [1] 32.35 32.40 68.30 68.33</span></span></code></pre></div>
<p>Our habitat resolution is 500 by 500 m.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">lims</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="va">myy</span><span class="op">)</span><span class="op">/</span><span class="fl">.005</span><span class="op">+</span><span class="fl">.5</span><span class="op">)</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">myx</span> <span class="op">-</span> <span class="va">lims</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fl">.005</span><span class="op">+</span><span class="fl">.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3 5</span></span></code></pre></div>
<p>Our point is in the pixel 5th from the left and 3rds from the
top.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pixel_order</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 27</span></span></code></pre></div>
<p>Our point is in pixel 27!</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">habitat_sp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="fl">3237000</span>, <span class="fl">6832000</span>, pch <span class="op">=</span> <span class="fl">21</span>, col <span class="op">=</span> <span class="st">'red'</span>, cex <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab9_SCR_files/figure-html/unnamed-chunk-39-1.png" width="768" style="display: block; margin: auto;">
We will need to implement this sort of system inside our model so it can
lookup which pixel any given point is in and use that habitat covariate
in the log likelihood.</p>
</div>
<div class="section level3">
<h3 id="gathering-information-for-nimble">Gathering Information for Nimble<a class="anchor" aria-label="anchor" href="#gathering-information-for-nimble"></a>
</h3>
<p>Time to get our information in order for Nimble.</p>
<p>First constants</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">npix</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">hab</span><span class="op">)</span></span>
<span><span class="va">pixelArea</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="va">habitat_sp</span><span class="op">)</span><span class="op">/</span><span class="fl">1e5</span><span class="op">)</span></span>
<span><span class="va">M</span> <span class="op">=</span> <span class="va">nind</span><span class="op">*</span><span class="fl">1.5</span></span>
<span><span class="va">traps</span> <span class="op">&lt;-</span> <span class="va">Finnish_butterflies</span><span class="op">$</span><span class="va">traps</span></span>
<span><span class="va">trap_locs</span> <span class="op">&lt;-</span> <span class="va">traps</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x'</span>, <span class="st">'y'</span><span class="op">)</span><span class="op">]</span><span class="op">/</span><span class="fl">1e5</span></span>
<span><span class="va">nconsts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>G <span class="op">=</span> <span class="va">npix</span>, pixelArea <span class="op">=</span> <span class="va">pixelArea</span>, habitat <span class="op">=</span> <span class="va">hab</span>, M <span class="op">=</span> <span class="va">M</span>, xlim <span class="op">=</span> <span class="va">lims</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, </span>
<span>                ylim <span class="op">=</span> <span class="va">lims</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, delta <span class="op">=</span> <span class="fl">.005</span>, x <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">trap_locs</span><span class="op">)</span>, </span>
<span>                effort <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">effort</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, ntraps <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">traps</span><span class="op">)</span>,</span>
<span>                nocc <span class="op">=</span> <span class="va">nocc</span><span class="op">)</span></span></code></pre></div>
<p>Then data. We have three types of data: + the all 0’s to trick the
model isn’t using the point process to distribute points + the
observations we have of butterflies, which should be in an array of
dimension M by ntraps by occasion + The lookup table, which isn’t
actually data but nimble doesn’t like it as a constants for whatever
reason</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zeros</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">M</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">M</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">traps</span><span class="op">)</span>, <span class="va">nocc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">caps</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">me</span> <span class="op">&lt;-</span> <span class="va">caps</span><span class="op">$</span><span class="va">Individual</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">day</span> <span class="op">&lt;-</span> <span class="va">caps</span><span class="op">$</span><span class="va">Day</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">trap</span> <span class="op">&lt;-</span> <span class="va">caps</span><span class="op">$</span><span class="va">Trap</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">y</span><span class="op">[</span><span class="va">me</span>, <span class="va">trap</span>, <span class="va">day</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ndat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, zeros <span class="op">=</span> <span class="va">zeros</span>, lookup <span class="op">=</span> <span class="va">pixel_order</span><span class="op">)</span></span></code></pre></div>
<p>Finally, initial values.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ninits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, g0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="co">#give a big sigma</span></span>
<span><span class="va">z.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nind</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">M</span><span class="op">-</span><span class="va">nind</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">s.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">M</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mytraps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">i</span>,,<span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mytraps</span><span class="op">)</span> <span class="op">&gt;</span><span class="fl">0</span> <span class="op">)</span><span class="op">{</span> <span class="co">#guys we saw</span></span>
<span>    <span class="va">s.init</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">trap_locs</span><span class="op">[</span><span class="va">mytraps</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="co">#augmented guys</span></span>
<span>    <span class="va">s.init</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lims</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">lims</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="co">#x coord </span></span>
<span>    <span class="va">s.init</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lims</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">lims</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="co">#y coord</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">ninits</span><span class="op">$</span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">z.init</span></span>
<span><span class="va">ninits</span><span class="op">$</span><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">s.init</span></span></code></pre></div>
<p>Also parameters of interest:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'beta0'</span>, <span class="st">'g0'</span>, <span class="st">'sigma'</span>, <span class="st">'N'</span>, <span class="st">'EN'</span>, <span class="st">'psi'</span><span class="op">)</span></span></code></pre></div>
<p>Time to see if the initial values are working!</p>
</div>
<div class="section level3">
<h3 id="running-the-scr-model">Running the SCR Model<a class="anchor" aria-label="anchor" href="#running-the-scr-model"></a>
</h3>
<p>*Note, this model will take a decent amount of time to run.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="co">#each chain will be run separately </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, varlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ninits"</span>,  <span class="st">"nconsts"</span>, <span class="st">'ndat'</span>, <span class="st">"scr_flies"</span>, <span class="st">'prms'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">scr1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>,<span class="op">{</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-nimble.org" class="external-link">nimble</a></span><span class="op">)</span> <span class="co">#reload packages for each core</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/nimbleModel.html" class="external-link">nimbleModel</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">scr_flies</span>, constants <span class="op">=</span> <span class="va">nconsts</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">ndat</span>, inits <span class="op">=</span> <span class="va">ninits</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="va">mcmcnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/configureMCMC.html" class="external-link">configureMCMC</a></span><span class="op">(</span><span class="va">prepnim</span>, monitors <span class="op">=</span> <span class="va">prms</span>, print <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">nimMCMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/buildMCMC.html" class="external-link">buildMCMC</a></span><span class="op">(</span><span class="va">mcmcnim</span><span class="op">)</span> <span class="co">#actually build the code for those samplers</span></span>
<span><span class="va">Cmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">prepnim</span><span class="op">)</span> <span class="co">#compiling the model itself in C++;</span></span>
<span><span class="va">Compnim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimble/man/compileNimble.html" class="external-link">compileNimble</a></span><span class="op">(</span><span class="va">nimMCMC</span>, project <span class="op">=</span> <span class="va">prepnim</span><span class="op">)</span> <span class="co"># compile the samplers next</span></span>
<span><span class="va">Compnim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>niter <span class="op">=</span> <span class="fl">50000</span>, nburnin <span class="op">=</span> <span class="fl">25000</span>, thin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">as.mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Compnim</span><span class="op">$</span><span class="va">mvSamples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co">#this will take awhile and not produce any progress bar</span></span>
<span><span class="va">scr1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">as.mcmc.list</a></span><span class="op">(</span><span class="va">scr1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Time to plot:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">scr1</span>, pdf <span class="op">=</span> <span class="cn">F</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab9_SCR_files/figure-html/unnamed-chunk-46-1.png" width="768" style="display: block; margin: auto;"><img src="Lab9_SCR_files/figure-html/unnamed-chunk-46-2.png" width="768" style="display: block; margin: auto;"><img src="Lab9_SCR_files/figure-html/unnamed-chunk-46-3.png" width="768" style="display: block; margin: auto;"></p>
<p>Exact estimates can be summarized as well (but remember sigma needs
to be multiplied by 1e5)</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html" class="external-link">MCMCsummary</a></span><span class="op">(</span><span class="va">scr1</span><span class="op">)</span></span>
<span><span class="co">#&gt;               mean        sd       2.5%       50%     97.5% Rhat n.eff</span></span>
<span><span class="co">#&gt; EN       1.668e+02 8.4416561 150.386066 1.669e+02 1.834e+02 1.00  7082</span></span>
<span><span class="co">#&gt; N        1.706e+02 4.5663976 163.000000 1.700e+02 1.800e+02 1.00  9965</span></span>
<span><span class="co">#&gt; beta0[1] 1.195e+01 0.0507878  11.848617 1.195e+01 1.205e+01 1.00  7098</span></span>
<span><span class="co">#&gt; beta0[2] 1.001e+00 1.0062739  -0.965923 1.004e+00 3.000e+00 1.00 11447</span></span>
<span><span class="co">#&gt; beta0[3] 9.927e-01 1.0112792  -1.006757 9.886e-01 2.977e+00 1.00 11274</span></span>
<span><span class="co">#&gt; g0       3.576e-03 0.0002033   0.003192 3.573e-03 3.982e-03 1.00  7847</span></span>
<span><span class="co">#&gt; psi      7.130e-01 0.0360755   0.642675 7.131e-01 7.837e-01 1.00  7082</span></span>
<span><span class="co">#&gt; sigma    1.186e+00 1.0453899   0.146388 8.694e-01 3.935e+00 1.01  4343</span></span></code></pre></div>
<p>Let’s compare with the CMR method:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CMR_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html" class="external-link">MCMCsummary</a></span><span class="op">(</span><span class="va">cmr2</span>, params <span class="op">=</span> <span class="st">'N'</span><span class="op">)</span></span>
<span><span class="va">SCR_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html" class="external-link">MCMCsummary</a></span><span class="op">(</span><span class="va">scr1</span>, params <span class="op">=</span> <span class="st">'N'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">CMR_est</span>, <span class="va">SCR_est</span><span class="op">)</span></span>
<span><span class="co">#&gt;     mean    sd 2.5% 50% 97.5% Rhat n.eff</span></span>
<span><span class="co">#&gt; N  169.7 4.438  162 169   179    1 33068</span></span>
<span><span class="co">#&gt; N1 170.6 4.566  163 170   180    1  9965</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="homework">Homework<a class="anchor" aria-label="anchor" href="#homework"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>In lab (above), we used the Mt version for our closed CMR model
(detection probability changed with time). Perform a prior predictive
check on this model. Report out the posterior for p in each occasion. If
you notice any are very informative, adjust the alpha values until the
posteriors look reasonable.</p></li>
<li><p>Re-write the closed CMR model as an Mb model (trap shyness).
Compare the abundance estimates with those we got out of the Mt version
of the model by graphing the CIs (and medians) for both models.</p></li>
<li><p>In the SCR model, our detection probability predicts that male
and female butterflies are equally likely to be captured. Re-write the
model to allow for male and female butterflies to have different
detection probabilities. You can adjust either g0 or sigma. You do not
need to run this model, just write out the code.</p></li>
<li><p>Using the SCR beta outputs from lab (not the one you just wrote
for Q3), make a map showing the expected abundance in each pixel in the
study area as well as the trap locations. Notice that the model predicts
very high abundance in the poor quality habitat. Why do you think that
is? (Note: this is an inaccurate model, clearly but
<em>why</em>?)</p></li>
<li><p>On a 1-10 scale, with 1 being the worst week ever and 10 being
the best, how would you rate this week’s content? What lingering
questions/confusion about the lecture or lab do you still have?</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Clark Rushing, Heather Gaya.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
