<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Lab 3: Basic MCMC • WILD8370</title>
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Lab 3: Basic MCMC">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WILD8370</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2025.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-house-chimney"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../articles/syllabus.html"><span class="fa fab fa-readme"></span> Syllabus</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/schedule.html"><span class="fa far fa-calendar"></span> Schedule</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lectures" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-file-powerpoint"></span> Lectures</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lectures">
<li><a class="dropdown-item" href="../articles/lectures/00_course_intro/00_course_intro.html">Lecture 0: Course introduction</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/01_inference/01_inference.html">Lecture 1: Statistical inference in ecology</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/02_probability/02_probability.html">Lecture 2: Probability refresher</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/03_bayes/03_bayes.html">Lecture 3: Principles of Bayesian inference</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/04_intro_nimble/Intro_Nimble.html">Lecture 4: Introduction to Nimble</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/05_glms/05_glms.html">Lecture 5: Generalized linear model review</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/06_priors/06_priors.html">Lecture 6: More about priors</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/07_random_effects/07_random_effects.html">Lecture 7: Random vs. Fixed Effects</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/08_occupancy/08_occupancy.html">Lecture 8: State Space Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/09_NMix/09_NMix.html">Lecture 9: N-Mixture and Occupancy</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/11_DynamicNMix/11_DynamicNMix.html">Lecture 11: Dynamic N-Mixture Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/9b_ExtraOcc/9b_ExtraOcc.html">Lecture 9b: Static Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/10_DynamicOcc/10_DynamicOcc.html">Lecture 10: Dynamic Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/12_MovementModels/12_MovementModels.html">Lecture 12: Movement Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/13_ClosedCMR/Lecture13_ClosedCMR.html">Lecture 13: Closed CMR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/14_ClosedSCR/Lecture14_ClosedSCR.html">Lecture 14: Closed SCR</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-labs" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-laptop-code"></span> Labs</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-labs">
<li><a class="dropdown-item" href="../articles/lab01_intro_to_R.html">Lab 0: Introduction to R</a></li>
    <li><a class="dropdown-item" href="../articles/Lab01b_Mathematical_Notation.html">Lab 1: Mathematical Notation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab2_simulation.html">Lab 2: Data Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab3_BasicMCMC.html">Lab 3: Basic MCMC</a></li>
    <li><a class="dropdown-item" href="../articles/Lab4_glms.html">Lab 4: GLMs</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Lab 5: Priors</a></li>
    <li><a class="dropdown-item" href="../articles/Lab6_MissingData.html">Lab 6: Missing Data</a></li>
    <li><a class="dropdown-item" href="../articles/Lab7_GOF.html">Lab 7: Goodness of Fit</a></li>
    <li><a class="dropdown-item" href="../articles/Lab8_Movement.html">Lab 8: Resource Selection Functions</a></li>
    <li><a class="dropdown-item" href="../articles/Lab9_SCR.html">Lab 9: Spatial Capture Recapture</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-references" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-bookmark"></span> References</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-references">
<li><a class="dropdown-item" href="../articles/homework.html">Assignment instructions</a></li>
    <li><a class="dropdown-item" href="../articles/projects_and_directories.html">Projects and directories</a></li>
    <li><a class="dropdown-item" href="../articles/RMarkdown.html">R Markdown reference</a></li>
    <li><a class="dropdown-item" href="../articles/graphics.html">Creating publication-quality graphics</a></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Lab 3: Basic MCMC</h1>
                        <h4 data-toc-skip class="author">Clark Rushing
and Heather Gaya</h4>
            
      

      <div class="d-none name"><code>Lab3_BasicMCMC.Rmd</code></div>
    </div>

    
    
<p>In this activity, we will use <code>R</code> to create a simple
Metropolis sampler to estimate the posterior distributions of the
parameters in a linear regression model. This sounds like a giant task
but once you understand the mechanisms, it’s not too hard.</p>
<hr>
<p><strong>Objectives</strong></p>
<ul>
<li><p>Create a Metropolis sampler to estimate the parameters of a
linear regression model</p></li>
<li><p>Create custom functions to avoid copying/pasting code</p></li>
</ul>
<hr>
<div class="section level2">
<h2 id="markov-chain-monte-carlo">Markov chain Monte Carlo<a class="anchor" aria-label="anchor" href="#markov-chain-monte-carlo"></a>
</h2>
<p>The basic steps of the Metropolis sampler are:</p>
<ol start="0" style="list-style-type: decimal">
<li><p>Choose an initial value for <span class="math inline">\theta</span> (call it <span class="math inline">\theta^1</span>)</p></li>
<li><p>Propose a new value <span class="math inline">\theta^*</span>
from a proposal distribution</p></li>
<li><p>Compute the probability of accepting <span class="math inline">\theta^*</span> using the joint distributions
evaluated at <span class="math inline">\theta^*</span> and the previous
value <span class="math inline">\theta^{k-1}</span></p></li>
<li><p>Accept <span class="math inline">\theta*</span> (i.e., <span class="math inline">\theta^{k} = \theta^*</span>) with the probability
estimated in step 2, otherwise retain the previous value (i.e., <span class="math inline">\theta^{k} = \theta^{k-1}</span></p></li>
</ol>
</div>
<div class="section level2">
<h2 id="why-bother">Why Bother?<a class="anchor" aria-label="anchor" href="#why-bother"></a>
</h2>
<p>First, let’s simulate some fake data from a binomial distribution as
an example. Maybe we’re flipping a coin and want to know if it’s fair.
We flip it 20 times and these are the results we get:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">20</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt;  [1] 1 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1</span></span></code></pre></div>
<p>Let’s take a look at our data with a table:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; x</span></span>
<span><span class="co">#&gt;  0  1 </span></span>
<span><span class="co">#&gt; 16  4</span></span></code></pre></div>
<p>Looks like we have 16 zeros (“failures”) and 4 1’s (“successes”).
Probably not a fair coin. But what if we want to estimate the
probability of success? If it were truly fair, we’d expect a probability
of 0.5.</p>
<p>If we reallllllly wanted to, we could try to figure this out entire
“by hand” by guessing a bunch of values and using the probability
density function of a binomial distribution to tell us if we were close
to the correct value. Here’s how that might look:</p>
<p>We know that the equation for a binomial distribution with size 20
is: <span class="math inline">\frac{20!}{(20-X!)X!}(p^X)(1-p)^{20-X}</span></p>
<p>So how do we go about finding p? Well, to start, what’s the
probability density of 4 successes if p = .1?</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">20</span>, <span class="fl">.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.08978</span></span></code></pre></div>
<p>Okay, not too high.</p>
<p>How about if p = .4?</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">20</span>, <span class="fl">.4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.03499</span></span></code></pre></div>
<p>Hmm, a little lower.</p>
<p>What about p = .7?</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">20</span>, <span class="fl">.7</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5.008e-06</span></span></code></pre></div>
<p>Oof, lower again.</p>
<p>So we could do this over and over and over again and eventually we’d
see that some numbers were larger (yay) and some were smaller (less good
answers). If we guessed enough numbers, we’d probably find a few that
were highest and we could say that p was pretty close to whatever that
value was.</p>
<p>Obviously picking random values of p by hand isn’t very efficient.
Let’s have a function do it for us and graph what the result is:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pick.ps</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">20</span>,<span class="va">p</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>p <span class="op">=</span> <span class="va">p</span>, d<span class="op">=</span><span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Lab3_BasicMCMC_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;"></p>
<p>We can see that the value of p is probably close to .3 because that’s
where the highest probability density was, but we can also see that this
method tried a bunch of points (AKA wastes a lot of time) over around
values that we basically know aren’t going to be good answers. For
instance, we’re pretty sure this coin isn’t going to have a success
probability of .9, so we would kind of prefer that the model not spend
so much time testing values over there.</p>
<p>Is there a way we could have the function spend more time in “good”
areas, trying to estimate the exact value of p and less time in “bad”
areas where the answer is very unlikely? And what about for equations
where the math isn’t just one distribution but a bunch of distributions
combined?</p>
<p>Why yes! It’s called MCMC. And it makes our ineffective plug-and-chug
methods much faster.</p>
</div>
<div class="section level2">
<h2 id="seed-count-model">Seed count model<a class="anchor" aria-label="anchor" href="#seed-count-model"></a>
</h2>
<p>When we generated the seed count data, we did so assuming a linear
model that linked pollination visits to seed counts:</p>
<p><span class="math display">y_i = \alpha + \beta * x_i +
\epsilon_i</span> <span class="math display">\epsilon_i \sim Normal(0,
\sigma^2)</span></p>
<p>This model includes 3 random variables that we want to estimate
posterior distributions for: <span class="math inline">\alpha</span>,
<span class="math inline">\beta</span>, and <span class="math inline">\sigma^2</span> (remember that the <span class="math inline">y_i</span> and <span class="math inline">x_i</span>
are <em>observed</em> and therefore treated as <em>fixed</em> and
<em>known</em> rather than random variables governed by probability
distributions). So:</p>
<p><span class="math display">[\alpha, \beta, \sigma^2|y_i] \propto
[y_i|\alpha, \beta, \sigma^2][\alpha][\beta][\sigma^2]
\tag{1}</span></p>
<p>Sticking with the data generating model, we can define the likelihood
of our model using a Normal distribution. For given values of <span class="math inline">\alpha</span>, <span class="math inline">\beta</span>, and <span class="math inline">\sigma^2</span>, we estimate the likelihood as:</p>
<p><span class="math display">[y_i|\alpha, \beta, \sigma] =
\prod_{i=1}^N Normal(y_i|\alpha + \beta \times x_i, \sigma^2)</span></p>
<p>Because <span class="math inline">\alpha</span>, <span class="math inline">\beta</span>, and <span class="math inline">\sigma^2</span> are random variables, we must define
prior distributions for them. Because <span class="math inline">\alpha</span> and <span class="math inline">\beta</span> can be positive or negative real
numbers (we’ll ignore for now that we know the sign of each in our data
generating model), we can use normal priors:</p>
<p><span class="math display">[\alpha] = Normal(\alpha|0, 50)</span></p>
<p><span class="math display">[\beta] = Normal(\beta|0, 50)</span></p>
<p>These are relatively non-informative priors for the intercept and
slope coefficients.</p>
<p>We also need a model for <span class="math inline">\sigma</span>.</p>
<p>Side note: A lot of MCMC codes (such as the BUGS language) model a
normal distribution as <span class="math inline">Normal(mean,
precision)</span> where precision = (<span class="math inline">1/\sigma^2</span>).</p>
<p>For <span class="math inline">\sigma</span>, we will use a relatively
diffuse gamma prior:</p>
<p><span class="math display">[\sigma] = Gamma(\sigma|1, 1)</span></p>
</div>
<div class="section level2">
<h2 id="custom-functions">Custom functions<a class="anchor" aria-label="anchor" href="#custom-functions"></a>
</h2>
<p>At each iteration of the sampler, we will need to perform the same
set of tasks, namely estimating the likelihood and joint distributions
for the proposed and current parameter values. We could do this by
copying and pasting the code necessary for these calculations at each
point in the sampler code where we need them. However, any time you find
yourself copying and pasting the same code more than once or twice, it’s
a good idea to consider wrapping that code in a function, which will do
here.</p>
<div class="section level3">
<h3 id="function-for-calculating-likelihood">Function for calculating likelihood<a class="anchor" aria-label="anchor" href="#function-for-calculating-likelihood"></a>
</h3>
<p>Given values of <span class="math inline">\alpha</span>, <span class="math inline">\beta</span>, and <span class="math inline">\sigma</span>, we can estimate the likelihood in
<code>R</code> using the <code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm()</a></code> function (note that we
will take the sum of the log likelihoods rather than the product of the
likelihoods to avoid numerical issues):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate the predicted count for each flower</span></span>
<span>  <span class="va">lp</span> <span class="op">&lt;-</span> <span class="va">alpha</span> <span class="op">+</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">x</span>  </span>
<span>  </span>
<span><span class="co"># Calculate the likelihood of our data given the model</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">lp</span>, <span class="va">sigma</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>To turn this code into a function, first open a new script and call
it <code>calc_like.R</code>. Save it in the <code>R/</code>
sub-directory. This script will contain the function code. The function
code is:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calc_like</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">alpha</span>, <span class="va">beta</span>, <span class="va">sigma</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lp</span> <span class="op">&lt;-</span> <span class="va">alpha</span> <span class="op">+</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">x</span></span>
<span>  <span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">lp</span>, <span class="va">sigma</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">ll</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This allows us to put in the data (<code>y</code>), covariate values
(<code>x</code>), and values of <span class="math inline">\alpha</span>,
<span class="math inline">\beta</span>, and <span class="math inline">\sigma</span> as arguments and the function will
return the log likelihood.</p>
<p>Save this code in the script and then close the script.</p>
</div>
<div class="section level3">
<h3 id="functions-for-calculating-prior-probabilities">Functions for calculating prior probabilities<a class="anchor" aria-label="anchor" href="#functions-for-calculating-prior-probabilities"></a>
</h3>
<p>We also need functions to estimate the prior probabilities for
specific values of <span class="math inline">\alpha</span>, <span class="math inline">\beta</span>, and <span class="math inline">\sigma</span>. Create a new script titled
<code>priors.R</code> and save it to the <code>R/</code> sub-directory.
The following functions will take values of each parameter and estimate
the prior probability given the prior distributions we defined
above:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priorAlpha</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">alpha</span>, <span class="va">mu</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">sigma</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">alpha</span>, <span class="va">mu</span>, <span class="va">sigma</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span></span>
<span><span class="op">}</span> </span>
<span></span>
<span><span class="va">priorBeta</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta</span>, <span class="va">mu</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">sigma</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">beta</span>, <span class="va">mu</span>, <span class="va">sigma</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span></span>
<span><span class="op">}</span> </span>
<span></span>
<span><span class="va">priorsigma</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sigma</span>, <span class="va">shape1</span> <span class="op">=</span> <span class="fl">0.1</span>, <span class="va">rate1</span> <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">sigma</span>, shape <span class="op">=</span> <span class="va">shape1</span>, rate <span class="op">=</span> <span class="va">rate1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span></span>
<span><span class="op">}</span> </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="metropolis-sampler">Metropolis sampler<a class="anchor" aria-label="anchor" href="#metropolis-sampler"></a>
</h3>
<p>Now we are ready to create the sampler. Remember that when there are
multiple parameters, we need to define the full conditionals. For each
random variable in the model, we define the full conditional by
including any element on the right hand side of eq. 1 that contains the
parameter (note the change to <span class="math inline">\sigma</span>):</p>
<p><span class="math display">[\alpha|.] = [y_i|\alpha, \beta,
\sigma][\alpha]</span> <span class="math display">[\beta|.] =
[y_i|\alpha, \beta, \sigma][\beta]</span></p>
<p><span class="math display">[\sigma|.] = [y_i|\alpha, \beta,
\sigma][\sigma]</span></p>
<p>In the sampler, we loop over each parameter, going through the
Metropolis steps for each and treating the other parameters as known
(based on their current value in the chain). If this in not clear,
walking through the <code>R</code> code will hopefully make it more
concrete (don’t worry about trying to copy and run the code in this
section, which is simply for illustration. In the next section, we will
<em>slightly</em> modify this code to run the sampler for our seed count
data).</p>
<p>First, we set the length of our chains, set the tuning parameter for
the proposal distribution, and create an empty data frame to store the
samples and a binary variable for estimating the acceptance rate:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Length of chains</span></span>
<span>  <span class="va">nIter</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span></span>
<span><span class="co">## Tuning parameter</span></span>
<span>  <span class="va">tuning</span> <span class="op">&lt;-</span> <span class="fl">1.5</span></span>
<span></span>
<span><span class="co">## Empty data frame to store posterior samples of each parameter</span></span>
<span>  <span class="va">mcmc_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">nIter</span>,</span>
<span>                        alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">nIter</span><span class="op">)</span>,</span>
<span>                        beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">nIter</span><span class="op">)</span>,</span>
<span>                        sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">nIter</span><span class="op">)</span>,</span>
<span>                        accept.alpha <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                        accept.beta <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                        accept.sigma <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>Next, we will randomly generate initial values for each parameter.
Remember that these are quite big numbers in the data generating model
so we will create initial values of the same magnitude:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Initial values</span></span>
<span>  <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">200</span>, <span class="fl">300</span><span class="op">)</span></span>
<span>  <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">25</span>, <span class="fl">75</span><span class="op">)</span></span>
<span>  <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>The final “set up” step is to estimate the likelihood of our data
given these initial values. To do this, we use the
<code>calc_like()</code> function we created earlier:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Initial likelihood</span></span>
<span><span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="fu">calc_like</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                       beta <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, sigma <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                       x <span class="op">=</span> <span class="va">x</span><span class="op">)</span> </span></code></pre></div>
<p>Now we create the actual sampler. Below, we will create a loop that
implements these steps for each iteration of the chains. Here, we will
simply go through each step to make sure you understand what it’s doing.
We’ll start by going through the Metropolis steps for <span class="math inline">\alpha</span> (though remember the order doesn’t
matter):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################</span></span>
<span><span class="co">#### 1. Update alpha</span></span>
<span><span class="co">########################</span></span>
<span></span>
<span><span class="co">## 1a: Generate candidate value</span></span>
<span>  <span class="va">cand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">tuning</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 1b: Calculate likelihood at candidate value</span></span>
<span>  <span class="va">cand_like</span> <span class="op">&lt;-</span> <span class="fu">calc_like</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="va">cand</span>, beta <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, sigma <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co">## 1c: Calculate likelihood * prior at old value and candidate value</span></span>
<span>  <span class="va">jointOld</span> <span class="op">&lt;-</span> <span class="va">likelihood</span> <span class="op">+</span> <span class="fu">priorAlpha</span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span>  <span class="va">jointCand</span> <span class="op">&lt;-</span> <span class="va">cand_like</span> <span class="op">+</span> <span class="fu">priorAlpha</span><span class="op">(</span><span class="va">cand</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="co">## 1d: Acceptance probability </span></span>
<span>  <span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">jointCand</span> <span class="op">-</span> <span class="va">jointOld</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 1e: Decide whether to accept or not</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">R</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co"># if accepted</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cand</span></span>
<span>      <span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="va">cand_like</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>Let’s go through this line by line. In <code>step 1a</code>, we
generate a new value of <span class="math inline">\alpha</span> from a
normal distribution centered on the previous value. Remember that the
tuning parameter we set earlier determines how big the jumps are between
the current and proposed values.</p>
<p>In <code>step 1b</code>, we use the <code>calc_like()</code> function
to estimate the likelihood of our data given the new value of <span class="math inline">\alpha</span> and the previous values of <span class="math inline">\beta</span> and <span class="math inline">\sigma</span>. This is what we mean when we say that
we treat the other parameters as <em>fixed</em> and <em>known</em>.</p>
<p>In <code>step 1c</code>, we estimate the joint probability of both
the current and proposed values by adding the log likelihood to the log
prior probability (note that sum of the log values is the same as the
product of the probabilities).</p>
<p>In <code>step 1d</code>, we estimate the probability of accepting the
new value. Note that if the proposed value is more likely than the
current value (<span class="math inline">R &gt; 1</span>), this function
will return 1. Otherwise, it returns the ratio. The closer the joint
probabilities are, the closer <span class="math inline">R</span> will be
to 1. The less likely the proposed value is relative to the current
value, the smaller <span class="math inline">R</span> will be. This
means that we will be much less likely to accept new values of <span class="math inline">\alpha</span> that are a lot less probable than the
current value (though not impossible).</p>
<p>Finally, in <code>step 1e</code> we accept or reject the proposed
value. Note that we compare <span class="math inline">R</span> to a
random value generated from a <span class="math inline">Uniform(0,1)</span> distribution. If <span class="math inline">R=1</span>, it will always be greater than this
value so we will always accept the proposed value
(<code>mcmc_df$alpha[i] &lt;- cand</code>) and we update the current
likelihood to match the current value of <span class="math inline">\alpha</span>. If <span class="math inline">R&lt;1</span>, it turns out testing whether <span class="math inline">R</span> is less than our randomly generated value
from <span class="math inline">Uniform(0,1)</span> ensures that we
accept <span class="math inline">\alpha</span> with probability <span class="math inline">R</span> (I’ll leave it to you to prove this based
on the properties of the uniform distribution).</p>
<p>Next we do the same thing for <span class="math inline">\beta</span>,
using the new value of <span class="math inline">alpha</span>
(<code>mcmc_df$alpha[i]</code>) and the previous value of <span class="math inline">\sigma</span>
(<code>mcmc_df$sigma[i - 1]</code>):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################</span></span>
<span><span class="co">#### 2. Update beta</span></span>
<span><span class="co">########################</span></span>
<span></span>
<span><span class="co">## 2a: Generate candidate value</span></span>
<span>  <span class="va">cand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">tuning</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 2b: Calculate likelihood at candidate value</span></span>
<span>  <span class="va">cand_like</span> <span class="op">&lt;-</span> <span class="fu">calc_like</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, beta <span class="op">=</span> <span class="va">cand</span>, </span>
<span>                         sigma <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co">## 2c: Calculate likelihood * prior at old value and candidate value</span></span>
<span>  <span class="va">jointOld</span> <span class="op">&lt;-</span> <span class="va">likelihood</span> <span class="op">+</span> <span class="fu">priorBeta</span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span>  <span class="va">jointCand</span> <span class="op">&lt;-</span> <span class="va">cand_like</span> <span class="op">+</span> <span class="fu">priorBeta</span><span class="op">(</span><span class="va">cand</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="co">## 2d: Acceptance probability </span></span>
<span>  <span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">jointCand</span> <span class="op">-</span> <span class="va">jointOld</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 2e: Decide whether to accept or not</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">R</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co"># if accepted</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cand</span></span>
<span>      <span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="va">cand_like</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span></code></pre></div>
<p>Finally, we update <span class="math inline">\sigma</span> using the
new values of both <span class="math inline">\alpha</span> and <span class="math inline">\beta</span>. The only difference here is that
because <span class="math inline">\sigma</span> has to be <span class="math inline">&gt;0</span>, the normal proposal distribution we
used for <span class="math inline">\alpha</span> and <span class="math inline">\beta</span> will not work (it could create negative
values). As we learned in lecture, you could create a proposal
distribution that generates positive value (e.g., gamma) and use moment
matching to estimate the parameters with regards to the current <span class="math inline">\sigma</span> and the tuning parameter. We’ll use a
slightly less efficient approach here to demonstrate there are different
ways to enforcing the behavior we want in the sampler. In this cases,
will simply add a small value to the current <span class="math inline">\sigma</span> and automatically reject the proposed
value if it’s less than 0. The small value can be negative or positive
to allow us to explore the posterior.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="do">########################</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="do">#### 3. Update sigma</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="do">########################</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="do">## 3a: Generate candidate value</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    cand <span class="ot">&lt;-</span> mcmc_df<span class="sc">$</span>sigma[i<span class="dv">-1</span>] <span class="sc">+</span> <span class="fu">runif</span>(<span class="dv">1</span>,  <span class="sc">-</span>.<span class="dv">1</span>, <span class="fl">0.1</span>)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    <span class="co"># If candidate value is outside [0,Inf], keep the old value of sigma</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>    <span class="cf">if</span> (cand <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>      mcmc_df<span class="sc">$</span>sigma[i] <span class="ot">&lt;-</span> mcmc_df<span class="sc">$</span>sigma[i<span class="dv">-1</span>]</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="do">## 3b: Calculate likelihood at candidate value</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>      cand_like <span class="ot">&lt;-</span> <span class="fu">calc_like</span>(<span class="at">y =</span> y, <span class="at">alpha =</span> mcmc_df<span class="sc">$</span>alpha[i], <span class="at">beta =</span> mcmc_df<span class="sc">$</span>beta[i], </span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>                          <span class="at">sigma =</span> cand, <span class="at">x =</span> x)</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>      </span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="do">## 3c: Calculate likelihood * prior at old value and candidate value</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>      jointOld <span class="ot">&lt;-</span> likelihood <span class="sc">+</span> <span class="fu">priorsigma</span>(mcmc_df<span class="sc">$</span>sigma[i<span class="dv">-1</span>])</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>      jointCand <span class="ot">&lt;-</span> cand_like <span class="sc">+</span> <span class="fu">priorsigma</span>(cand)</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="do">## 3d: Acceptance probability </span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>      R <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">1</span>, <span class="fu">exp</span>(jointCand <span class="sc">-</span> jointOld))</span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="do">## 3e: Decide whether to accept or not</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>      <span class="cf">if</span>(R <span class="sc">&gt;</span> <span class="fu">runif</span>(<span class="dv">1</span>)) {   <span class="co"># if accepted</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a>        mcmc_df<span class="sc">$</span>sigma[i] <span class="ot">&lt;-</span> cand</span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a>        likelihood <span class="ot">&lt;-</span> cand_like</span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>        mcmc_df<span class="sc">$</span>sigma[i] <span class="ot">&lt;-</span> mcmc_df<span class="sc">$</span>sigma[i<span class="dv">-1</span>]</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>      }</span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>    }</span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>  <span class="er">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="running-the-sampler">Running the sampler<a class="anchor" aria-label="anchor" href="#running-the-sampler"></a>
</h2>
<p>Finally, we can run the sampler. Create a new script called
<code>metroplis.R</code> (or something similar) and put it in
<code>scripts/</code>. First, we will load the packages we need and use
the <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code> function to read in our custom functions
(<code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code> runs the <code>.R</code> files given in the
argument which in this case will make the functions available for our
sampler):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">WILD6900</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"R/calc_like.R"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"R/priors.R"</span><span class="op">)</span></span></code></pre></div>
<p>Next, read in the simulated data and set the initial values for the
MCMC:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Read simulated data</span></span>
<span>  <span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/sim_seed_counts.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Length of chains</span></span>
<span>  <span class="va">nIter</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span></span>
<span><span class="co">## Tuning parameter</span></span>
<span>  <span class="va">tuning</span> <span class="op">&lt;-</span> <span class="fl">1.5</span></span>
<span></span>
<span><span class="co">## Empty data frame to store posterior samples of each parameter</span></span>
<span>  <span class="va">mcmc_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">nIter</span>,</span>
<span>                        alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">nIter</span><span class="op">)</span>,</span>
<span>                        beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">nIter</span><span class="op">)</span>,</span>
<span>                        sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">nIter</span><span class="op">)</span>,</span>
<span>                        accept.alpha <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                        accept.beta <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                        accept.sigma <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Initial values</span></span>
<span>  <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">200</span>, <span class="fl">300</span><span class="op">)</span></span>
<span>  <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">25</span>, <span class="fl">75</span><span class="op">)</span></span>
<span>  <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co">## Initial likelihood</span></span>
<span>  <span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="fu">calc_like</span><span class="op">(</span>y <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">y</span>, alpha <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                       beta <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, sigma <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                       x <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">visits.c</span><span class="op">)</span> </span></code></pre></div>
<p>Now take the sampler code and put it inside a <code>for</code> loop
to create the chains. Note that in the likelihood functions we will need
to reference our simulated data and covariates:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nIter</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="co">########################</span></span>
<span><span class="co">#### 1. Update alpha</span></span>
<span><span class="co">########################</span></span>
<span></span>
<span><span class="co">## 1a: Generate candidate value</span></span>
<span>  <span class="va">cand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">tuning</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 1b: Calculate likelihood at candidate value</span></span>
<span>  <span class="va">cand_like</span> <span class="op">&lt;-</span> <span class="fu">calc_like</span><span class="op">(</span>y <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">y</span>, alpha <span class="op">=</span> <span class="va">cand</span>, </span>
<span>                         beta <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, sigma <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                         x <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">visits.c</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co">## 1c: Calculate likelihood * prior at old value and candidate value</span></span>
<span>  <span class="va">jointOld</span> <span class="op">&lt;-</span> <span class="va">likelihood</span> <span class="op">+</span> <span class="fu">priorAlpha</span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span>  <span class="va">jointCand</span> <span class="op">&lt;-</span> <span class="va">cand_like</span> <span class="op">+</span> <span class="fu">priorAlpha</span><span class="op">(</span><span class="va">cand</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="co">## 1d: Acceptance probability </span></span>
<span>  <span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">jointCand</span> <span class="op">-</span> <span class="va">jointOld</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 1e: Decide whether to accept or not</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">R</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co"># if accepted</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cand</span></span>
<span>      <span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="va">cand_like</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">accept.alpha</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  </span>
<span><span class="co">########################</span></span>
<span><span class="co">#### 2. Update beta</span></span>
<span><span class="co">########################</span></span>
<span></span>
<span><span class="co">## 2a: Generate candidate value</span></span>
<span>  <span class="va">cand</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">tuning</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 2b: Calculate likelihood at candidate value</span></span>
<span>  <span class="va">cand_like</span> <span class="op">&lt;-</span> <span class="fu">calc_like</span><span class="op">(</span>y <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">y</span>, alpha <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, beta <span class="op">=</span> <span class="va">cand</span>, </span>
<span>                         sigma <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">visits.c</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co">## 2c: Calculate likelihood * prior at old value and candidate value</span></span>
<span>  <span class="va">jointOld</span> <span class="op">&lt;-</span> <span class="va">likelihood</span> <span class="op">+</span> <span class="fu">priorBeta</span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span>  <span class="va">jointCand</span> <span class="op">&lt;-</span> <span class="va">cand_like</span> <span class="op">+</span> <span class="fu">priorBeta</span><span class="op">(</span><span class="va">cand</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="co">## 2d: Acceptance probability </span></span>
<span>  <span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">jointCand</span> <span class="op">-</span> <span class="va">jointOld</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 2e: Decide whether to accept or not</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">R</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co"># if accepted</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cand</span></span>
<span>      <span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="va">cand_like</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">accept.beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  </span>
<span><span class="co">########################</span></span>
<span><span class="co">#### 3. Update sigma</span></span>
<span><span class="co">########################</span></span>
<span></span>
<span><span class="co">## 3a: Generate candidate value</span></span>
<span>    <span class="va">cand</span> <span class="op">&lt;-</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>,  <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="co"># If candidate value is outside [0,Inf], keep the old value of sigma</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cand</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span><span class="co">## 3b: Calculate likelihood at candidate value</span></span>
<span>      <span class="va">cand_like</span> <span class="op">&lt;-</span> <span class="fu">calc_like</span><span class="op">(</span>y <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">y</span>, alpha <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, beta <span class="op">=</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                          sigma <span class="op">=</span> <span class="va">cand</span>, x <span class="op">=</span> <span class="va">sim_dat</span><span class="op">$</span><span class="va">visits.c</span><span class="op">)</span></span>
<span>      </span>
<span><span class="co">## 3c: Calculate likelihood * prior at old value and candidate value</span></span>
<span>      <span class="va">jointOld</span> <span class="op">&lt;-</span> <span class="va">likelihood</span> <span class="op">+</span> <span class="fu">priorsigma</span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">jointCand</span> <span class="op">&lt;-</span> <span class="va">cand_like</span> <span class="op">+</span> <span class="fu">priorsigma</span><span class="op">(</span><span class="va">cand</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 3d: Acceptance probability </span></span>
<span>      <span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">jointCand</span> <span class="op">-</span> <span class="va">jointOld</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 3e: Decide whether to accept or not</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">R</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co"># if accepted</span></span>
<span>        <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cand</span></span>
<span>        <span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="va">cand_like</span></span>
<span>        <span class="va">mcmc_df</span><span class="op">$</span><span class="va">accept.sigma</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>At this point, you should be able to run the script from start to
finish and create the posterior samples for each parameter.</p>
</div>
<div class="section level2">
<h2 id="checking-the-output">Checking the output<a class="anchor" aria-label="anchor" href="#checking-the-output"></a>
</h2>
<p>Now we can determine whether the sampler returns the data generating
values from our data simulation. When assessing the output of MCMC
chains, a good first diagnostic is usually checking the trace plots:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">mcmc_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_path</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab3_BasicMCMC_files/figure-html/unnamed-chunk-22-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The chain for <span class="math inline">\alpha</span> moved rapidly
from the initial value to the stationary posterior distribution but
those first few samples will obviously bias our parameter estimates if
we include them in the posterior. Let’s remove them by using the
<code>dplyr</code> function <code>slice()</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="va">mcmc_df</span>, <span class="fl">1000</span><span class="op">:</span><span class="va">nIter</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">mcmc_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_path</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab3_BasicMCMC_files/figure-html/unnamed-chunk-23-1.png" width="672" style="display: block; margin: auto;"></p>
<p>That looks better. Now we can estimate the mean and 95% credible
interval of the posterior:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 251.3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  2.5% 97.5% </span></span>
<span><span class="co">#&gt; 250.2 252.4</span></span></code></pre></div>
<p>Pretty close to the data generating value of 250. Now let’s check
<span class="math inline">\beta</span>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">mcmc_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">beta</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_path</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab3_BasicMCMC_files/figure-html/unnamed-chunk-25-1.png" width="672" style="display: block; margin: auto;"></p>
<p>and</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 49.1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">beta</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  2.5% 97.5% </span></span>
<span><span class="co">#&gt; 48.02 50.17</span></span></code></pre></div>
<p>Also pretty close to the data generating value of 50. Finally, <span class="math inline">\sigma</span></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">mcmc_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_path</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab3_BasicMCMC_files/figure-html/unnamed-chunk-27-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7.424</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">sigma</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  2.5% 97.5% </span></span>
<span><span class="co">#&gt; 6.690 8.254</span></span></code></pre></div>
<p>Wasn’t that easy?</p>
</div>
<div class="section level2">
<h2 id="homework">Homework<a class="anchor" aria-label="anchor" href="#homework"></a>
</h2>
<ol style="list-style-type: decimal">
<li>In simulation, we set <span class="math inline">\alpha</span> = 250,
and we provided a reasonable, diffuse prior in the example above. But
what happens if we give a restrictive (and wrong) prior for <span class="math inline">\alpha</span>? Change your <code>priorAlpha</code>
function to instead match <span class="math inline">\alpha \sim
Uniform(0, 150)</span>. Make sure to also change this line to match the
new prior:</li>
</ol>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_df</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">200</span>, <span class="fl">300</span><span class="op">)</span> <span class="co">#change this to something reasonable</span></span></code></pre></div>
<p>Run your sampler again and print out the chain for <span class="math inline">\alpha</span>. What do you see?</p>
<ol start="2" style="list-style-type: decimal">
<li>Go back to the original prior for alpha. We didn’t discuss it much
in lab, but the tuning parameter affects how fast the sampler will
explore the state space. If it’s really small, it might take forever. If
it’s really large, it can make giant jumps and reject a lot of possible
values, which wastes time and causes the sampler to ‘stall’. We can see
what the acceptance rate of our sampler was by calculating the mean of
the accept.alpha, accept.beta and accept.sigma columns. Run the sampler
with a tuning parameter of .05 and 50. Calculate the acceptance rates
for each of the 3 parameters. What do you notice?</li>
</ol>
</div>
<div class="section level2">
<h2 id="homework-1-bonus-point">Homework (+1 Bonus Point)<a class="anchor" aria-label="anchor" href="#homework-1-bonus-point"></a>
</h2>
<ol start="3" style="list-style-type: decimal">
<li>When we generated the seed count data, we did so assuming a linear
model that linked pollination visits to seed counts: <span class="math inline">y_i = \alpha + \beta * x_i + \epsilon_i</span>.
Because we used simulated data, we know this model ahead of time.
However in real life, we wouldn’t know the true model ahead of time and
might try to fit a different model to the data. Adding on to what we
already have, create an MCMC that also includes a second beta term that
looks at visits squared: <span class="math inline">y_i = \alpha + \beta
* x_i + \beta_2 * x_i^2 + \epsilon_i</span>. Run the MCMC and look at
the output. What does the MCMC estimate for <span class="math inline">\beta_2</span>?</li>
</ol>
<blockquote>
<p>Hint: Approach this problem one step at a time.</p>
<p>- Begin by changing the mcmc_df to allow you to store an additional
beta parameter.</p>
<p>- Next, choose an initial value for beta2.</p>
<p>- Change your calc_like function to include beta2. Remember that lp
will just be alpha + beta<em>x + beta2</em>x*x.</p>
<p>- Optionally, create another function for priorBeta2 (or just re-use
the priorBeta function for beta2 as well).</p>
<p>Next create a section in your sampler to update Beta2. It will look
almost identical to the one already present for Beta.</p>
<p>- Run your model.</p>
<p>- Finally, use the quantile function to look at the estimate:
quantile(mcmc_df$beta2, probs = c(0.025,0.5, 0.975))</p>
</blockquote>
<ol start="4" style="list-style-type: decimal">
<li>On a 1-10 scale, with 1 being the worst week ever and 10 being the
best, how would you rate this week’s content? What lingering
questions/confusion about the lecture or lab do you still have?</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Clark Rushing, Heather Gaya.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
