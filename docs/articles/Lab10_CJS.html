<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Lab10: Discrete Survival Models • WILD8370</title>
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Lab10: Discrete Survival Models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WILD8370</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2025.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-house-chimney"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../articles/syllabus.html"><span class="fa fab fa-readme"></span> Syllabus</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/schedule.html"><span class="fa far fa-calendar"></span> Schedule</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lectures" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-file-powerpoint"></span> Lectures</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lectures">
<li><a class="dropdown-item" href="../articles/lectures/00_course_intro/00_course_intro.html">Lecture 0: Course introduction</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/01_inference/01_inference.html">Lecture 1: Statistical inference in ecology</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/02_probability/02_probability.html">Lecture 2: Probability refresher</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/03_bayes/03_bayes.html">Lecture 3: Principles of Bayesian inference</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/04_intro_nimble/Intro_Nimble.html">Lecture 4: Introduction to Nimble</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/05_glms/05_glms.html">Lecture 5: Generalized linear model review</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/06_priors/06_priors.html">Lecture 6: More about priors</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/07_random_effects/07_random_effects.html">Lecture 7: Random vs. Fixed Effects</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/08_occupancy/08_occupancy.html">Lecture 8: State Space Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/09_NMix/09_NMix.html">Lecture 9: N-Mixture and Occupancy</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/11_DynamicNMix/11_DynamicNMix.html">Lecture 11: Dynamic N-Mixture Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/9b_ExtraOcc/9b_ExtraOcc.html">Lecture 9b: Static Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/10_DynamicOcc/10_DynamicOcc.html">Lecture 10: Dynamic Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/12_MovementModels/12_MovementModels.html">Lecture 12: Movement Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/13_ClosedCMR/Lecture13_ClosedCMR.html">Lecture 13: Closed CMR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/14_ClosedSCR/Lecture14_ClosedSCR.html">Lecture 14: Closed SCR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/15_KnownFate/15_KnownFate.html">Lecture 15: Known Fate Modeling</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/16_CJS/16_CJS.html">Lecture 16: CJS Models</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-labs" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-laptop-code"></span> Labs</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-labs">
<li><a class="dropdown-item" href="../articles/lab01_intro_to_R.html">Lab 0: Introduction to R</a></li>
    <li><a class="dropdown-item" href="../articles/Lab01b_Mathematical_Notation.html">Lab 1: Mathematical Notation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab2_simulation.html">Lab 2: Data Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab3_BasicMCMC.html">Lab 3: Basic MCMC</a></li>
    <li><a class="dropdown-item" href="../articles/Lab4_glms.html">Lab 4: GLMs</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Lab 5: Priors</a></li>
    <li><a class="dropdown-item" href="../articles/Lab6_MissingData.html">Lab 6: Missing Data</a></li>
    <li><a class="dropdown-item" href="../articles/Lab7_GOF.html">Lab 7: Goodness of Fit</a></li>
    <li><a class="dropdown-item" href="../articles/Lab8_Movement.html">Lab 8: Resource Selection Functions</a></li>
    <li><a class="dropdown-item" href="../articles/Lab9_SCR.html">Lab 9: Spatial Capture Recapture</a></li>
    <li><a class="dropdown-item" href="../articles/Lab10_CJS.html">Lab 10: CJS</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-references" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-bookmark"></span> References</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-references">
<li><a class="dropdown-item" href="../articles/homework.html">Assignment instructions</a></li>
    <li><a class="dropdown-item" href="../articles/projects_and_directories.html">Projects and directories</a></li>
    <li><a class="dropdown-item" href="../articles/RMarkdown.html">R Markdown reference</a></li>
    <li><a class="dropdown-item" href="../articles/graphics.html">Creating publication-quality graphics</a></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Lab10: Discrete Survival Models</h1>
            
      

      <div class="d-none name"><code>Lab10_CJS.Rmd</code></div>
    </div>

    
    
<p>In this exercise, we’ll look at how our estimates might change when
we fit data with imperfect detection to both a known-fate and a CJS
model. In this case, we’ll be using a CJS model to estimate ‘apparent
infection rate’ rather than survival to demonstrate how these models can
be used for more than just live/dead tracking of animals.</p>
<div class="section level2">
<h2 id="the-data-set">The Data Set<a class="anchor" aria-label="anchor" href="#the-data-set"></a>
</h2>
<p>Today’s lab will work with data we saw in class - frog and toad
capture recapture information from a published study on chytrid
fungus.</p>
<p>Here’s the citation: Russell, R.E., Halstead, B.J., Fisher, R.N.,
Muths, E.L., Adams, M.J., and Hossack, B.R., 2019, Amphibian capture
mark-recapture: U.S. Geological Survey data release, <a href="https://doi.org/10.5066/P9LNLEDF" class="external-link uri">https://doi.org/10.5066/P9LNLEDF</a>.</p>
<p>In lecture we looked at how we might model apparent survival using
these data, but completely ignore the infection status of animals. Now,
let’s see if we can model apparent infection - the joint probability
that an animal survives and becomes infected with chytrid. We will
assume once an animal gets the disease it is positive for the rest of
its life.</p>
</div>
<div class="section level2">
<h2 id="known-fate-style">Known-fate Style<a class="anchor" aria-label="anchor" href="#known-fate-style"></a>
</h2>
<p>It is often tempting to ignore detection probability when modeling
capture mark recapture data. However, doing so will often give you
biased information about the parameter of interest.</p>
<p>If we were to fit a very simple known fate model to our data, it
might look something like this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">KnownFrogs</span> <span class="op">&lt;-</span> <span class="fu">nimbleCode</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">eta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nind</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="op">(</span><span class="va">first_live</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">last_live</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">eta</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>In this case eta (<span class="math inline">\eta</span>) is not
survival but rather the probability of getting the disease, conditional
on surviving. We will not estimate survival directly. If the animal is
infected, <span class="math inline">z = 0</span> and we stop monitoring
the animal in our study.</p>
<p>Let’s organize the data to fit this simple model. We’ll use the
boreal toad (<em>Rana muscosa</em>) in California for this example. As
in lecture, we will only concern ourselves with the yearly level, not
the capture-date level. Thus, if an animal ever tested positive during a
given year, we will mark it as positive for the entire year.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"WyomingFrogs"</span><span class="op">)</span></span>
<span><span class="va">Rmus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">frog_caps</span>, <span class="va">frog_caps</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">'Rana muscosa'</span><span class="op">)</span></span>
<span><span class="va">Rmus</span><span class="op">$</span><span class="va">Bd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">Bd.presence</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Negative'</span>, <span class="st">'negative'</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">Bd.presence</span> <span class="op">==</span> <span class="st">'Positive'</span>, <span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">Rmus</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">Ind.ID</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Rmus</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">Survey.Date</span>, format <span class="op">=</span> <span class="st">'%m/%d/%y'</span><span class="op">)</span></span>
<span><span class="va">Rmus</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">date</span>, <span class="st">'%y'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Rmus</span><span class="op">$</span><span class="va">occ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 11</span></span></span>
<span><span class="co">#&gt;   Ind.ID   Survey.Date Project Species  Sex   Bd.presence    Bd    id date      </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 20836382 9/17/10     CA      Rana mu… Male  Negative        1   100 2010-09-17</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 20836382 7/7/09      CA      Rana mu… Male  Negative        1   100 2009-07-07</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 20836382 6/5/12      CA      Rana mu… Male  Negative        1   100 2012-06-05</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 20839859 5/27/09     CA      Rana mu… Male  Positive        0   101 2009-05-27</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 20840567 5/27/09     CA      Rana mu… Fema… Negative        1   102 2009-05-27</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 20841578 8/15/14     CA      Rana mu… Fema… Negative        1   103 2014-08-15</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: year &lt;dbl&gt;, occ &lt;dbl&gt;</span></span></span></code></pre></div>
<p>We need to organize our data so that we get the capture history and
determine the first and last time we saw the animal in its negative
state.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nocc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">occ</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nind</span>, <span class="va">nocc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">z</span><span class="op">[</span><span class="va">Rmus</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,<span class="va">Rmus</span><span class="op">$</span><span class="va">occ</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Rmus</span><span class="op">$</span><span class="va">Bd</span><span class="op">[</span><span class="va">j</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>One major problem is, of course, that there IS a lot of detection
error, so we have to do a lot of thinning of our data to remove all the
all-NA rows and the all-0 rows. We also need to remove all the
individuals who were not seen in at least two consecutive time periods
(neither the first capture nor the second capture cannot be NA).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new.z</span> <span class="op">&lt;-</span> <span class="va">z</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">z</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>,<span class="op">]</span> <span class="co">#get rid of ones with no negative caps</span></span>
<span><span class="va">first</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">new.z</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">row</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>  <span class="co"># Returns the index of the first detection</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">last</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">new.z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">new.z</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">first</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">==</span> <span class="va">nocc</span><span class="op">)</span> <span class="kw">next</span></span>
<span> <span class="va">last</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">new.z</span><span class="op">[</span><span class="va">j</span>, <span class="op">(</span><span class="va">first</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">nocc</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">first</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">z_useable</span> <span class="op">&lt;-</span> <span class="va">new.z</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">last</span><span class="op">-</span><span class="va">first</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">first.use</span> <span class="op">&lt;-</span> <span class="va">first</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">last</span><span class="op">-</span><span class="va">first</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">last.use</span> <span class="op">&lt;-</span> <span class="va">last</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">last</span><span class="op">-</span><span class="va">first</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#Make sure censors are correct:</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">z_useable</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">first.use</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">z_useable</span><span class="op">[</span><span class="va">k</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">first.use</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">last.use</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">!=</span> <span class="va">nocc</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">z_useable</span><span class="op">[</span><span class="va">k</span>, <span class="op">(</span><span class="va">last.use</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">nocc</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">nind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">z_useable</span><span class="op">)</span></span></code></pre></div>
<p>Now we can make some objects for nimble and send them to the
model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">z_useable</span><span class="op">)</span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nind <span class="op">=</span> <span class="va">nind</span>,</span>
<span>           first_live <span class="op">=</span> <span class="va">first.use</span>,</span>
<span>           last_live <span class="op">=</span> <span class="va">last.use</span><span class="op">)</span></span>
<span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>eta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'eta'</span><span class="op">)</span></span></code></pre></div>
<p>Check that everything is working properly:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu">nimbleModel</span><span class="op">(</span>code <span class="op">=</span> <span class="va">KnownFrogs</span>, constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">nd</span>, inits <span class="op">=</span> <span class="va">ni</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="co">#&gt; [1] -20.42</span></span></code></pre></div>
<p>Run the model:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">frogs_kf</span> <span class="op">&lt;-</span> <span class="fu">nimbleMCMC</span><span class="op">(</span>code <span class="op">=</span> <span class="va">KnownFrogs</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">nd</span>,</span>
<span>                     constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                     inits <span class="op">=</span> <span class="va">ni</span>,</span>
<span>                     monitors <span class="op">=</span> <span class="va">params</span>,</span>
<span>                     thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     niter <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                     nburnin <span class="op">=</span> <span class="fl">2500</span>,</span>
<span>                     nchains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                     samplesAsCodaMCMC <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>                      <span class="op">)</span></span></code></pre></div>
<p>Check the chains. Remember that we defined eta as similar to
survival, so we’re really most interested in 1-eta (probability of
infection).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">frogs_kf</span>, pdf <span class="op">=</span> <span class="cn">F</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab10_CJS_files/figure-html/unnamed-chunk-10-1.png" width="768" style="display: block; margin: auto;"></p>
<p>This model suggests the annual probability of infection (conditional
on survival) is around 3.5%</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">-</span> <span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html" class="external-link">MCMCsummary</a></span><span class="op">(</span><span class="va">frogs_kf</span>, Rhat <span class="op">=</span> <span class="cn">F</span>, n.eff <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="co">#&gt;        mean    sd    2.5%     50%   97.5%</span></span>
<span><span class="co">#&gt; eta 0.03892 0.983 0.07726 0.03637 0.01294</span></span></code></pre></div>
<p>Of course, this was fit with a model that is inappropriate for this
type of data. Let’s see what happens when we fit a model that account
for detection probability.</p>
</div>
<div class="section level2">
<h2 id="cjs-style">CJS Style<a class="anchor" aria-label="anchor" href="#cjs-style"></a>
</h2>
<p>For the CJS style model, we will fit a very similar model, but
account for detection probability in our estimates.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">UnknownFrogs</span> <span class="op">&lt;-</span> <span class="fu">nimbleCode</span><span class="op">(</span><span class="op">{</span></span>
<span><span class="va">eta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nind</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co">#initial capture</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="op">(</span><span class="va">first</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">nocc</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">eta</span><span class="op">*</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dbern</span><span class="op">(</span><span class="va">p</span><span class="op">*</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We do need to make sure the data doesn’t let any frogs recover from
chytrid (to match our other model) and removes all the frogs that were
positive at first capture, but otherwise cleanup is pretty easy.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nind.cjs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nocc.cjs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">$</span><span class="va">occ</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y.cjs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nind.cjs</span>, <span class="va">nocc.cjs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Rmus</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">y.cjs</span><span class="op">[</span><span class="va">Rmus</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,<span class="va">Rmus</span><span class="op">$</span><span class="va">occ</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Rmus</span><span class="op">$</span><span class="va">Bd</span><span class="op">[</span><span class="va">j</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="va">y.new.cjs</span> <span class="op">&lt;-</span> <span class="va">y.cjs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">y.cjs</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>,<span class="op">]</span> <span class="co">#get rid of ones with no negative caps</span></span>
<span><span class="va">first.cjs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">y.new.cjs</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">row</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>  <span class="co"># Returns the index of the first detection</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#can't use guys only seen on the last interval</span></span>
<span><span class="va">bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">first.cjs</span> <span class="op">==</span> <span class="va">nocc.cjs</span><span class="op">)</span></span>
<span><span class="va">y.new.cjs</span> <span class="op">&lt;-</span> <span class="va">y.new.cjs</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bad</span><span class="op">)</span>,<span class="op">]</span> <span class="co">#remove bad ones</span></span>
<span><span class="va">z.new.cjs</span> <span class="op">&lt;-</span> <span class="va">y.new.cjs</span></span>
<span><span class="va">z.new.cjs</span><span class="op">[</span><span class="va">z.new.cjs</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span> <span class="co">#unknown </span></span>
<span><span class="va">first.cjs</span> <span class="op">&lt;-</span> <span class="va">first.cjs</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bad</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">nind2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">first.cjs</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Remove anything before the first detection and put 0's after last detection</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">y.new.cjs</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">first.cjs</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>     <span class="va">y.new.cjs</span><span class="op">[</span><span class="va">k</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">first.cjs</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>    <span class="va">y.new.cjs</span><span class="op">[</span><span class="va">k</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">y.new.cjs</span><span class="op">[</span><span class="va">k</span>,<span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co">#didn't see</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">y.new.cjs</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,]    0    0    0    0    0    1    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [2,]    0    0    0    0    1    1    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [3,]    0    0    0    0    0    1    1    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]    0    0    0    0    1    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]    0    0    0    0    0    1    0    0    0     0     1     0     0     0</span></span></code></pre></div>
<p>We also need to fill in our z object, which just contains the 1’s. We
know that in-between the first time we saw an animal and the last time
we saw it uninfected that it was still alive/negative.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">last.cjs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">y.new.cjs</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">row</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Returns the index of the last detection</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">z.new.cjs</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">z.new.cjs</span><span class="op">[</span><span class="va">j</span>, <span class="va">first.cjs</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">:</span><span class="va">last.cjs</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">z.new.cjs</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,]   NA   NA   NA   NA   NA    1   NA   NA   NA    NA    NA    NA    NA    NA</span></span>
<span><span class="co">#&gt; [2,]   NA   NA   NA   NA    1    1   NA   NA   NA    NA    NA    NA    NA    NA</span></span>
<span><span class="co">#&gt; [3,]   NA   NA   NA   NA   NA    1    1   NA   NA    NA    NA    NA    NA    NA</span></span>
<span><span class="co">#&gt; [4,]   NA   NA   NA   NA    1   NA   NA   NA   NA    NA    NA    NA    NA    NA</span></span>
<span><span class="co">#&gt; [5,]   NA   NA   NA   NA   NA    1    1    1    1     1     1    NA    NA    NA</span></span>
<span><span class="co">#&gt; [6,]   NA   NA   NA   NA    1    1    1    1    1    NA    NA    NA    NA    NA</span></span></code></pre></div>
<p>Time to add initial values for z:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z.init</span> <span class="op">&lt;-</span> <span class="va">z.new.cjs</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nind2</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">first.cjs</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">z.init</span><span class="op">[</span><span class="va">j</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">first.cjs</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co">#start everyone alive before first capture </span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">last.cjs</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">nocc.cjs</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">z.init</span><span class="op">[</span><span class="va">j</span>, <span class="op">(</span><span class="va">last.cjs</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">nocc.cjs</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co">#kill everyone after last detection</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">z.init</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">z.new.cjs</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span> <span class="co">#no inits for known data</span></span></code></pre></div>
<p>Send params to objects, then make sure nimble model works:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>eta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, z <span class="op">=</span> <span class="va">z.init</span><span class="op">)</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'eta'</span>, <span class="st">'p'</span><span class="op">)</span></span>
<span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y.new.cjs</span>, z <span class="op">=</span> <span class="va">z.new.cjs</span><span class="op">)</span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>first <span class="op">=</span> <span class="va">first.cjs</span>, nocc <span class="op">=</span> <span class="va">nocc.cjs</span>, nind <span class="op">=</span> <span class="va">nind2</span><span class="op">)</span></span></code></pre></div>
<p>Check that everything is working properly:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu">nimbleModel</span><span class="op">(</span>code <span class="op">=</span> <span class="va">UnknownFrogs</span>, constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">nd</span>, inits <span class="op">=</span> <span class="va">ni</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="co">#&gt; [1] -1423</span></span></code></pre></div>
<p>Run the model:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">frogs_cjs</span> <span class="op">&lt;-</span> <span class="fu">nimbleMCMC</span><span class="op">(</span>code <span class="op">=</span> <span class="va">UnknownFrogs</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">nd</span>,</span>
<span>                     constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                     inits <span class="op">=</span> <span class="va">ni</span>,</span>
<span>                     monitors <span class="op">=</span> <span class="va">params</span>,</span>
<span>                     thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     niter <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                     nburnin <span class="op">=</span> <span class="fl">2500</span>,</span>
<span>                     nchains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                     samplesAsCodaMCMC <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>                      <span class="op">)</span></span></code></pre></div>
<p>Check the chains. Again, we’re really most interested in 1-eta
(probability of infection).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">frogs_cjs</span>, pdf <span class="op">=</span> <span class="cn">F</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab10_CJS_files/figure-html/unnamed-chunk-20-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Let’s see how the estimates compare with the Known-fate style
model.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kf_out</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span> <span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html" class="external-link">MCMCsummary</a></span><span class="op">(</span><span class="va">frogs_kf</span>, Rhat <span class="op">=</span> <span class="cn">F</span>, n.eff <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">cjs_out</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span> <span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html" class="external-link">MCMCsummary</a></span><span class="op">(</span><span class="va">frogs_cjs</span>, Rhat <span class="op">=</span> <span class="cn">F</span>, n.eff <span class="op">=</span> <span class="cn">F</span>, params <span class="op">=</span> <span class="st">'eta'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">kf_out</span>, <span class="va">cjs_out</span><span class="op">)</span></span>
<span><span class="co">#&gt;         mean     sd    2.5%     50%   97.5%</span></span>
<span><span class="co">#&gt; eta  0.03892 0.9830 0.07726 0.03637 0.01294</span></span>
<span><span class="co">#&gt; eta1 0.28028 0.9791 0.32365 0.27932 0.24219</span></span></code></pre></div>
<p>And that is why you should not ignore detection probability.</p>
</div>
<div class="section level2">
<h2 id="homework">Homework<a class="anchor" aria-label="anchor" href="#homework"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Using only the capture records for <em>Rana sierrae</em>, write a
CJS model for apparent survival that models capture probability as a
function of both sex and a random effect of year. Make a ggplot showing
detection probability across time, with different colors for the
different sexes. Note: you will need to remove frogs with Ids that start
with the number 9. These are an error in the dataset (example:
“9.00043E+14”)</p></li>
<li><p>You are a reviewer for a journal and are trying to run code from
several manuscripts to make sure the author’s results make sense.
Unfortunately, with the information you are given, none of the models
run. Use data(‘bad_data’) to find the information from 3 manuscripts
(Birds N-mixture, frog CJS, and falcons). Diagnose the problem(s) with
each dataset. If the problem is in the initial values, determine what
initial value is needed instead to make the model run. You do not need
to run the models all the way, just fix the information until you can
get a non-NA, non-infinite value for calculate().</p></li>
</ol>
<p>Here’s an example workflow to get you started for the first
manuscript (birds):</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'bad_data'</span><span class="op">)</span></span>
<span><span class="va">birds</span> <span class="op">&lt;-</span> <span class="va">bad_data</span><span class="op">$</span><span class="va">birds</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">birds</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="va">birds</span><span class="op">$</span><span class="va">dat</span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="va">birds</span><span class="op">$</span><span class="va">consts</span></span>
<span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="va">birds</span><span class="op">$</span><span class="va">inits</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="va">birds</span><span class="op">$</span><span class="va">monitors</span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu">nimbleModel</span><span class="op">(</span>code <span class="op">=</span> <span class="va">model</span>, constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">nd</span>, inits <span class="op">=</span> <span class="va">ni</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>On a 1-10 scale, with 1 being the worst week ever and 10 being the
best, how would you rate this week’s content? What lingering
questions/confusion about the lecture or lab do you still have?</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Clark Rushing, Heather Gaya.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
