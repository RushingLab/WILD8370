<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Lab11: Discrete and continuous-time multistate models • WILD8370</title>
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Lab11: Discrete and continuous-time multistate models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WILD8370</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2025.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-house-chimney"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../articles/syllabus.html"><span class="fa fab fa-readme"></span> Syllabus</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/schedule.html"><span class="fa far fa-calendar"></span> Schedule</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lectures" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-file-powerpoint"></span> Lectures</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lectures">
<li><a class="dropdown-item" href="../articles/lectures/00_course_intro/00_course_intro.html">Lecture 0: Course introduction</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/01_inference/01_inference.html">Lecture 1: Statistical inference in ecology</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/02_probability/02_probability.html">Lecture 2: Probability refresher</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/03_bayes/03_bayes.html">Lecture 3: Principles of Bayesian inference</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/04_intro_nimble/Intro_Nimble.html">Lecture 4: Introduction to Nimble</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/05_glms/05_glms.html">Lecture 5: Generalized linear model review</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/06_priors/06_priors.html">Lecture 6: More about priors</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/07_random_effects/07_random_effects.html">Lecture 7: Random vs. Fixed Effects</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/08_occupancy/08_occupancy.html">Lecture 8: State Space Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/09_NMix/09_NMix.html">Lecture 9: N-Mixture and Occupancy</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/11_DynamicNMix/11_DynamicNMix.html">Lecture 11: Dynamic N-Mixture Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/9b_ExtraOcc/9b_ExtraOcc.html">Lecture 9b: Static Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/10_DynamicOcc/10_DynamicOcc.html">Lecture 10: Dynamic Occupancy Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/12_MovementModels/12_MovementModels.html">Lecture 12: Movement Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/13_ClosedCMR/Lecture13_ClosedCMR.html">Lecture 13: Closed CMR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/14_ClosedSCR/Lecture14_ClosedSCR.html">Lecture 14: Closed SCR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/15_KnownFate/15_KnownFate.html">Lecture 15: Known Fate Modeling</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/16_CJS/16_CJS.html">Lecture 16: CJS Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/17_MultiState/17_Multistate.html">Lecture 17: Multistate Models</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/18_CT/18_CT.html">Lecture 18: Continuous-time CMR</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/19_JS/19_openCMR.html">Lecture 19: Open Capture Mark Recapture Part 1</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/20_JSSuper/20_JSSuper.html">Lecture 20: Open Capture Mark Recapture Part 2</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/21_MultiOcc/21_MultiOcc.html">Lecture 21: Multispecies Occupancy</a></li>
    <li><a class="dropdown-item" href="../articles/lectures/22_USCR/21_USCR.html">Lecture 22: Unmarked SCR</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-labs" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-laptop-code"></span> Labs</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-labs">
<li><a class="dropdown-item" href="../articles/lab01_intro_to_R.html">Lab 0: Introduction to R</a></li>
    <li><a class="dropdown-item" href="../articles/Lab01b_Mathematical_Notation.html">Lab 1: Mathematical Notation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab2_simulation.html">Lab 2: Data Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/Lab3_BasicMCMC.html">Lab 3: Basic MCMC</a></li>
    <li><a class="dropdown-item" href="../articles/Lab4_glms.html">Lab 4: GLMs</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Lab 5: Priors</a></li>
    <li><a class="dropdown-item" href="../articles/Lab6_MissingData.html">Lab 6: Missing Data</a></li>
    <li><a class="dropdown-item" href="../articles/Lab7_GOF.html">Lab 7: Goodness of Fit</a></li>
    <li><a class="dropdown-item" href="../articles/Lab8_Movement.html">Lab 8: Resource Selection Functions</a></li>
    <li><a class="dropdown-item" href="../articles/Lab9_SCR.html">Lab 9: Spatial Capture Recapture</a></li>
    <li><a class="dropdown-item" href="../articles/Lab10_CJS.html">Lab 10: CJS</a></li>
    <li><a class="dropdown-item" href="../articles/Lab11_Multistate.html">Lab 11: Continuous-time CMR</a></li>
    <li><a class="dropdown-item" href="../articles/Lab12_JointLiveDead.html">Lab 12: Joint Live-Dead Recovery Models</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-references" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa far fa-bookmark"></span> References</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-references">
<li><a class="dropdown-item" href="../articles/homework.html">Assignment instructions</a></li>
    <li><a class="dropdown-item" href="../articles/projects_and_directories.html">Projects and directories</a></li>
    <li><a class="dropdown-item" href="../articles/RMarkdown.html">R Markdown reference</a></li>
    <li><a class="dropdown-item" href="../articles/graphics.html">Creating publication-quality graphics</a></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Lab11: Discrete and continuous-time multistate models</h1>
            
      

      <div class="d-none name"><code>Lab11_Multistate.Rmd</code></div>
    </div>

    
    
<p>In this lab, we will explore multi-state models fit using both
discrete and continuous time formulations. We will first simulate a
capture-recapture data set with continuous transitions and detections,
and then fit the model as a discrete-time multi-state model by binning
detections. Finally, we will compare the discrete time model to a
continuous-time formulation.</p>
<div class="section level2">
<h2 id="model-structure">Model structure<a class="anchor" aria-label="anchor" href="#model-structure"></a>
</h2>
<p>For this example, we will assume alive individuals can be in one of
two states but can only transition from state 1 to state 2. Call this
transition rate <span class="math inline">\eta_{1,2}</span>. Both groups
experience a state-specific hazard rate <span class="math inline">h_1</span> and <span class="math inline">h_2</span>.
All rates are constant. The transition rate matrix is thus:</p>
<p><span class="math display">\mathbf Q = \left[\begin{array}
{ccc}
-[\eta_{1,2} + h_1] &amp; \eta_{1,2} &amp; h_{1}\\
0 &amp; -h_2 &amp; h_2\\
0 &amp; 0 &amp; 0
\end{array}\right]</span></p>
<p>Individuals can be detected in the alive states based on
state-specific detection rates <span class="math inline">\lambda_1</span> and <span class="math inline">\lambda_2</span>. The observation matrix is:</p>
<p><span class="math display">\mathbf \Lambda = \left[\begin{array}
{ccc}
\lambda_1 &amp; 0 &amp; 0\\
0 &amp; \lambda_2 &amp; 0\\
0 &amp; 0 &amp; 0
\end{array}\right]</span></p>
</div>
<div class="section level2">
<h2 id="simulating-the-data">Simulating the data<a class="anchor" aria-label="anchor" href="#simulating-the-data"></a>
</h2>
<p>To simulate the detection data, we will approximate continuous-time
state transitions by simulating each individual’s state on each day,
based on their state in the previous day. First, define parameters and
the transition rate matrix <code>Q</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://R-Forge.R-project.org/projects/expm/" class="external-link">expm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">584893</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Set parameters</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">100</span>                    <span class="co"># Number of individuals</span></span>
<span><span class="cn">T</span> <span class="op">&lt;-</span> <span class="fl">100</span>                    <span class="co"># Length of study, in days</span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0025</span>, <span class="fl">0.01</span><span class="op">)</span>        <span class="co"># Hazard rates</span></span>
<span><span class="va">eta12</span> <span class="op">&lt;-</span> <span class="fl">0.025</span>              <span class="co"># Transition rate from state 1 to state 2    </span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.15</span>, <span class="fl">0</span><span class="op">)</span>  <span class="co"># Detection rates </span></span>
<span></span>
<span></span>
<span><span class="co">## Define transition rate matrix and detection matrix</span></span>
<span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">Q</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="op">(</span><span class="va">eta12</span> <span class="op">+</span> <span class="va">h</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Q</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">eta12</span></span>
<span><span class="va">Q</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">h</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">Q</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">h</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">Q</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">h</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<p>Next, create a matrix <code>s</code> to store each individual’s state
on each day. Then use <code>Q</code> to simulate states:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Simulate true states</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">N</span>, ncol <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">s</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="cn">T</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">s</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">Q</span><span class="op">)</span><span class="op">[</span><span class="va">s</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span>,<span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Change state 3 to 0 (dead)</span></span>
<span><span class="va">s</span><span class="op">[</span><span class="va">s</span> <span class="op">==</span> <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>Next we simulate encounter histories based on the detection intensity
<span class="math inline">\lambda</span>. Because the length of the
encounter histories will differ among individuals, we first simulate the
observations as a list and then convert the list into a matrix based on
the longest detection history. We will also keep track of the state of
each detection (<code>state_list</code>):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Simulate encounter histories as a list because </span></span>
<span><span class="co">##  history length differs among individuals</span></span>
<span><span class="va">det_list</span> <span class="op">&lt;-</span> <span class="va">state_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span><span class="va">U1</span> <span class="op">&lt;-</span> <span class="va">U2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>length <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># How many days was each individual in each state?</span></span>
<span><span class="va">s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">s</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">s</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">U1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">s1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="co"># Number of detections</span></span>
<span>  <span class="va">dets1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">U1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">s1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># Time of detections </span></span>
<span>  <span class="va">state1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">U1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">U2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">s2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="co"># Number of detections</span></span>
<span>  <span class="va">dets2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">U2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">s2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">s1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="co"># Time of detections </span></span>
<span>  <span class="va">state2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">U2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">det_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dets1</span>, <span class="va">dets2</span><span class="op">)</span></span>
<span>  <span class="va">state_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">state1</span>, <span class="va">state2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Total number of detections for each individual</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="va">U1</span> <span class="op">+</span> <span class="va">U2</span></span>
<span></span>
<span><span class="co"># Covert detections to matrix </span></span>
<span><span class="va">det</span> <span class="op">&lt;-</span> <span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">N</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">det</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">det_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">state</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">state_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To fit the continuous-time model, we also need to calculate the time
between detections <span class="math inline">\Delta t</span>. For each
individual’s first detection, <span class="math inline">\Delta t_1 = t_1
- 0 = t_1</span>. We will also include the time from each individual’s
last detection to the end of the study <span class="math inline">\Delta
t_{U+1} = T - t_{U+1}</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate time difference between detections (including last detection to end of study)</span></span>
<span><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">N</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">delta</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">det</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">delta</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">det</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">-</span> <span class="va">det</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">delta</span><span class="op">[</span><span class="va">i</span>, <span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">T</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">det</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="discrete-time-model">Discrete-time model<a class="anchor" aria-label="anchor" href="#discrete-time-model"></a>
</h2>
<p>Because many ecologists are familiar with discrete-time multi-state
models, it is tempting to fit this data by binning detections in
discrete “occasions.” One problem is that, unlike data that is truly
detected at pre-defined sampling occasions, the length of these post-hoc
intervals is arbitrary. The shorter the intervals, the more the
discrete-time model will approximate the continuous-time model but also
the model will have to loop over more occasions (many of which will
contain no detections). Longer intervals are more computationally
efficient but less accurate.</p>
<p>Setting these issues aside, we’ll bin our data into 10-day intervals.
First, we create a matrix to store the detections. Because our observed
states are <code>state 1</code>, <code>state 2</code>,
<code>not observed</code>, we will pre-fill the matrix with all
<code>3</code>. Then we just have to fill in the observed states for
each individual:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">3</span>, nrow <span class="op">=</span> <span class="va">N</span>, ncol <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co"># empty detection matrix with 10 "sampling occasions"</span></span></code></pre></div>
<p>Next, we need to fill in the observed states. We can use the
<code><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut()</a></code> function to quickly determine which 10-day bin each
detection occurred in. We also know the state of each detection:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cut returns a factor, so convert to numeric</span></span>
<span><span class="va">bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">det_list</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">T</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">obs_state</span> <span class="op">&lt;-</span> <span class="va">state_list</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">bin</span>, <span class="va">obs_state</span><span class="op">)</span></span>
<span><span class="co">#&gt;    bin obs_state</span></span>
<span><span class="co">#&gt; 1    2         1</span></span>
<span><span class="co">#&gt; 2    3         1</span></span>
<span><span class="co">#&gt; 3    3         1</span></span>
<span><span class="co">#&gt; 4    3         1</span></span>
<span><span class="co">#&gt; 5    3         1</span></span>
<span><span class="co">#&gt; 6    4         1</span></span>
<span><span class="co">#&gt; 7    4         1</span></span>
<span><span class="co">#&gt; 8    5         1</span></span>
<span><span class="co">#&gt; 9    6         1</span></span>
<span><span class="co">#&gt; 10   6         1</span></span>
<span><span class="co">#&gt; 11   6         1</span></span>
<span><span class="co">#&gt; 12   6         1</span></span>
<span><span class="co">#&gt; 13   6         1</span></span>
<span><span class="co">#&gt; 14   7         1</span></span>
<span><span class="co">#&gt; 15   7         1</span></span>
<span><span class="co">#&gt; 16   8         1</span></span>
<span><span class="co">#&gt; 17   8         1</span></span>
<span><span class="co">#&gt; 18   8         2</span></span>
<span><span class="co">#&gt; 19   9         2</span></span>
<span><span class="co">#&gt; 20  10         2</span></span>
<span><span class="co">#&gt; 21  10         2</span></span>
<span><span class="co">#&gt; 22  10         2</span></span></code></pre></div>
<p>There are two things worth noting here. First, in this example,
binning the data greatly reduces the amount of information we have to
estimate parameters. This individual was observed multiple times during
nearly all intervals but we can only “encounter” individuals once per
occasion in the discrete-time formulation so we lose a lot of data.
Also, during interval 8, the individual was observed in both states 1
and 2. But the discrete-time model only allows a single state per
sampling occasion So we have to make an arbitrary decision about what
state to keep and which one to remove (Don’t ask me the best way to do
that, because I’m not sure)</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">det_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">obs_state</span> <span class="op">&lt;-</span> <span class="va">state_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bin</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">d</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">obs_state</span><span class="op">[</span><span class="va">bin</span> <span class="op">==</span> <span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## All individuals captured in first occasion</span></span>
<span><span class="va">d</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre></div>
<p>Now we’re ready to fit the model in nimble.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt_ms</span> <span class="op">&lt;-</span> <span class="fu">nimbleCode</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Priors </span></span>
<span>  <span class="va">phi1</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">phi2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">psi12</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">p1</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">p2</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Define state-transition and observation matrices</span></span>
<span>  <span class="co"># Define probabilities of state S(t+1) given S(t)</span></span>
<span>  <span class="va">ps</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi1</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">psi12</span><span class="op">)</span></span>
<span>  <span class="va">ps</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi1</span> <span class="op">*</span> <span class="va">psi12</span></span>
<span>  <span class="va">ps</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">phi1</span></span>
<span>  <span class="va">ps</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">ps</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi2</span></span>
<span>  <span class="va">ps</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">phi2</span></span>
<span>  <span class="va">ps</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">ps</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">ps</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="co"># Define probabilities of O(t) given S(t)</span></span>
<span>  <span class="va">po</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p1</span></span>
<span>  <span class="va">po</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">po</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">p1</span></span>
<span>  <span class="va">po</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">po</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p2</span></span>
<span>  <span class="va">po</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">p2</span></span>
<span>  <span class="va">po</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">po</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">po</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="co"># Likelihood </span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Define latent state at first capture</span></span>
<span>    <span class="va">z</span><span class="op">[</span><span class="va">i</span>, <span class="va">f</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span>, <span class="va">f</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="op">(</span><span class="va">f</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">nOcc</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># State process: draw S(t) given S(t-1)</span></span>
<span>      <span class="va">z</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dcat</span><span class="op">(</span><span class="va">ps</span><span class="op">[</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span>, <span class="fl">1</span><span class="op">:</span><span class="va">nStates</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="co"># Observation process: draw O(t) given S(t)</span></span>
<span>      <span class="va">y</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dcat</span><span class="op">(</span><span class="va">po</span><span class="op">[</span><span class="va">z</span><span class="op">[</span><span class="va">i</span>, <span class="va">t</span><span class="op">]</span>, <span class="fl">1</span><span class="op">:</span><span class="va">nStates</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="co">#t</span></span>
<span>  <span class="op">}</span> <span class="co">#i</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Prepare the data and fit the model:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">N</span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">z.init</span> <span class="op">&lt;-</span> <span class="va">d</span></span>
<span></span>
<span><span class="co">### NA for occasion 1 (deterministic) or occasions individual was not captured</span></span>
<span><span class="va">z</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">z</span><span class="op">[</span><span class="va">z</span> <span class="op">==</span> <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co">### Intialize z for occasions where individual was not captured</span></span>
<span><span class="va">z.init</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">z.init</span><span class="op">[</span><span class="va">d</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span> </span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">max1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">z.init</span><span class="op">[</span><span class="va">i</span>, <span class="va">nd</span><span class="op">[</span><span class="va">nd</span> <span class="op">&lt;</span> <span class="va">max1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">z.init</span><span class="op">[</span><span class="va">i</span>, <span class="va">nd</span><span class="op">[</span><span class="va">nd</span> <span class="op">&gt;</span> <span class="va">max1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">d</span>, z <span class="op">=</span> <span class="va">z</span><span class="op">)</span></span>
<span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span>,</span>
<span>           f <span class="op">=</span> <span class="va">f</span>,</span>
<span>           nOcc <span class="op">=</span> <span class="fl">10</span>, </span>
<span>           nStates <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>phi1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, </span>
<span>           phi2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>           psi12 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>           p1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>           p2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>           z <span class="op">=</span> <span class="va">z.init</span><span class="op">)</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'phi1'</span>, <span class="st">'phi2'</span>, <span class="st">'psi12'</span>, <span class="st">'p1'</span>, <span class="st">'p2'</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">prepnim</span> <span class="op">&lt;-</span> <span class="fu">nimbleModel</span><span class="op">(</span>code <span class="op">=</span> <span class="va">dt_ms</span>, constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">nd</span>, inits <span class="op">=</span> <span class="va">ni</span>, calculate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">initializeInfo</span><span class="op">(</span><span class="op">)</span> <span class="co">#will tell you what is or isn't initialized</span></span>
<span><span class="va">prepnim</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="op">)</span> <span class="co">#if this is NA or -Inf you know it's gone wrong</span></span>
<span><span class="co">#&gt; [1] -2421</span></span></code></pre></div>
<p>Run the model:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt_fit</span> <span class="op">&lt;-</span> <span class="fu">nimbleMCMC</span><span class="op">(</span>code <span class="op">=</span> <span class="va">dt_ms</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">nd</span>,</span>
<span>                     constants <span class="op">=</span> <span class="va">nc</span>,</span>
<span>                     inits <span class="op">=</span> <span class="va">ni</span>,</span>
<span>                     monitors <span class="op">=</span> <span class="va">params</span>,</span>
<span>                     thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     niter <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                     nburnin <span class="op">=</span> <span class="fl">2500</span>,</span>
<span>                     nchains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                     samplesAsCodaMCMC <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>                      <span class="op">)</span></span></code></pre></div>
<p>Look at the traceplots:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCtrace.html" class="external-link">MCMCtrace</a></span><span class="op">(</span><span class="va">dt_fit</span> , pdf <span class="op">=</span> <span class="cn">F</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="Lab11_Multistate_files/figure-html/unnamed-chunk-13-1.png" width="768" style="display: block; margin: auto;"><img src="Lab11_Multistate_files/figure-html/unnamed-chunk-13-2.png" width="768" style="display: block; margin: auto;"></p>
<p>Look at the model output:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html" class="external-link">MCMCsummary</a></span><span class="op">(</span><span class="va">dt_fit</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt;         mean      sd   2.5%    50%  97.5%</span></span>
<span><span class="co">#&gt; p1    0.9232 0.01633 0.8918 0.9221 0.9519</span></span>
<span><span class="co">#&gt; p2    0.7456 0.02775 0.6881 0.7461 0.7981</span></span>
<span><span class="co">#&gt; phi1  0.9549 0.01228 0.9289 0.9568 0.9743</span></span>
<span><span class="co">#&gt; phi2  0.8755 0.02325 0.8240 0.8758 0.9148</span></span>
<span><span class="co">#&gt; psi12 0.2001 0.02221 0.1600 0.2006 0.2419</span></span></code></pre></div>
<p>How do we compare these estimates to the simulated parameter values?
Remember that <span class="math inline">\phi = e^{-ht}</span>. What
about detection and transition probabilities?</p>
</div>
<div class="section level2">
<h2 id="continuous-time-model">Continuous-time model<a class="anchor" aria-label="anchor" href="#continuous-time-model"></a>
</h2>
<p>Fitting the continuous-time version of this model in nimble is
slightly more challenging because nimble does not have a built-in matrix
exponential function or a built-in likelihood function.</p>
<p>However, we can calculate the likelihoods of each observation by hand
and then use the zeros trick to have them added to the model likelihood.
To calculate likelihoods by hand, we will take advantage of nimble’s
user defined functions by creating a function that computes matrix
exponentials using base R functions</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dCTMS</span> <span class="op">&lt;-</span> <span class="fu">nimbleFunction</span><span class="op">(</span></span>
<span>  run <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">Q</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                 <span class="va">Lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                 <span class="va">delta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>                 <span class="va">s1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>                 <span class="va">s2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>                 <span class="va">last</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">0</span>, default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                 <span class="va">log</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">0</span>, default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="op">(</span><span class="va">Q</span> <span class="op">-</span> <span class="va">Lambda</span><span class="op">)</span> <span class="op">*</span> <span class="va">delta</span><span class="op">)</span><span class="op">$</span><span class="va">vectors</span></span>
<span>    <span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="op">(</span><span class="va">Q</span> <span class="op">-</span> <span class="va">Lambda</span><span class="op">)</span> <span class="op">*</span> <span class="va">delta</span><span class="op">)</span><span class="op">$</span><span class="va">values</span></span>
<span>    <span class="va">G</span> <span class="op">&lt;-</span> <span class="va">P</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu">inverse</span><span class="op">(</span><span class="va">P</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">last</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">G</span><span class="op">[</span><span class="va">s1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">(</span><span class="va">G</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Lambda</span><span class="op">)</span><span class="op">[</span><span class="va">s1</span>, <span class="va">s2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu">returnType</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The <code>nimbleFunction()</code> function allows us to define our
own functions to use inside of nimble models using notation that is
similar to creating functions in R. Our <code>dCTMS()</code> function
takes two matrices (<code>Q</code> and <code>Lambda</code>), the time
between the detections, the observed states associated with each
detection, and whether or not it was the individuals last detection. The
function then returns the associated likelihood of that detection, using
some matrix algebra that you can read about elsewhere if you really want
to know how it works.</p>
<p>To use the function in our nimble model, we need to first compile it.
We can then test that it works correctly by testing it against the
<code><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm()</a></code> function:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">C_dCTMS</span> <span class="op">&lt;-</span> <span class="fu">compileNimble</span><span class="op">(</span><span class="va">dCTMS</span><span class="op">)</span></span>
<span><span class="fu">C_dCTMS</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q</span>, Lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span>, delta <span class="op">=</span> <span class="fl">0.75</span>, s1 <span class="op">=</span> <span class="fl">1</span>, s2 <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.002388</span></span>
<span><span class="op">(</span><span class="fu">expm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="op">(</span><span class="va">Q</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 0.002388</span></span>
<span></span>
<span><span class="fu">C_dCTMS</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q</span>, Lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span>, delta <span class="op">=</span> <span class="fl">0.75</span>, s1 <span class="op">=</span> <span class="fl">1</span>, s2 <span class="op">=</span> <span class="fl">2</span>, last <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8298</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu">expm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="op">(</span><span class="va">Q</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8298</span></span></code></pre></div>
<p>Now we’re ready to write the model code and estimate the parameters.
To make the code a little easier, we will distinguish between three
groups of individuals - those never recountered, those recaptured once,
and those captured more than once. Those groups have different indexing
to calculate their likelihoods, so this makes it slightly easier (though
probably slower):</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ct_ms</span> <span class="op">&lt;-</span> <span class="fu">nimbleCode</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Priors</span></span>
<span>  <span class="va">h</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">h</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">eta12</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">p</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">p</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">p</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  </span>
<span>  <span class="va">Q</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="op">(</span><span class="va">h</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">eta12</span><span class="op">)</span></span>
<span>  <span class="va">Q</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">eta12</span></span>
<span>  <span class="va">Q</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">h</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">Q</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">Q</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">h</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">Q</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">h</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">Q</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">Q</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">Q</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  </span>
<span>  <span class="co"># Likelihood</span></span>
<span>  <span class="co"># 1. Individuals that were not reencountered</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">L</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">dCTMS</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, Lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                     delta <span class="op">=</span> <span class="va">delta</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, s1 <span class="op">=</span> <span class="fl">1</span>, s2 <span class="op">=</span> <span class="fl">1</span>, last <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">LL</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">L</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># 2. Individuals that were reencountered once</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="op">(</span><span class="va">N0</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">N0</span> <span class="op">+</span> <span class="va">N1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># First encounter</span></span>
<span>    <span class="va">L</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">dCTMS</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, Lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                     delta <span class="op">=</span> <span class="va">delta</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, s1 <span class="op">=</span> <span class="fl">1</span>, s2 <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># First encounter to end of study</span></span>
<span>    <span class="va">L</span><span class="op">[</span><span class="va">i</span>, <span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">dCTMS</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, Lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                            delta <span class="op">=</span> <span class="va">delta</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, s1 <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, </span>
<span>                            s2 <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, last <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">LL</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">L</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># 2. Individuals that were reencountered more than once</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="op">(</span><span class="va">N0</span> <span class="op">+</span> <span class="va">N1</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># First encounter</span></span>
<span>    <span class="va">L</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">dCTMS</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, Lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                     delta <span class="op">=</span> <span class="va">delta</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, s1 <span class="op">=</span> <span class="fl">1</span>, s2 <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Between subsequent encounters</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">L</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">dCTMS</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, </span>
<span>                       Lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                        delta <span class="op">=</span> <span class="va">delta</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span>, </span>
<span>                        s1 <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span>, </span>
<span>                        s2 <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="co"># j</span></span>
<span></span>
<span>    <span class="co"># Between last detection to end of study</span></span>
<span>    <span class="va">L</span><span class="op">[</span><span class="va">i</span>, <span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">dCTMS</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, </span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                            delta <span class="op">=</span> <span class="va">delta</span><span class="op">[</span><span class="va">i</span>, <span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>, s1 <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">i</span>, <span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                            s2 <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">i</span>, <span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, last <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>   </span>
<span>   <span class="va">LL</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">L</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># B. Zeros trick to implement the likelihood</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">phi</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">LL</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">10000</span></span>
<span>    <span class="va">zeros</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">phi</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="co"># i</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Next, we’ll create the data objects, constants, and initiatial
values. Note that we sort all of the matrices by the number of
detections, which will first include individuals never detected, then
individuals detected once, then more than once:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span>    </span>
<span><span class="va">ct_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>zeros<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ct_const</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span>, N0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>               N1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>               U <span class="op">=</span> <span class="va">U</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, </span>
<span>               delta <span class="op">=</span> <span class="va">delta</span><span class="op">[</span><span class="va">ord</span>,<span class="op">]</span>, </span>
<span>               state <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">ord</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ct_inits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>h<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">0.005</span><span class="op">)</span>, </span>
<span>                          eta12 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span>, p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Parameters monitored</span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"h"</span>, <span class="st">"p"</span>, <span class="st">"eta12"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ct_fit</span> <span class="op">&lt;-</span> <span class="fu">nimbleMCMC</span><span class="op">(</span>code <span class="op">=</span> <span class="va">ct_ms</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">ct_data</span>,</span>
<span>                     constants <span class="op">=</span> <span class="va">ct_const</span>,</span>
<span>                     inits <span class="op">=</span> <span class="va">ct_inits</span>,</span>
<span>                     monitors <span class="op">=</span> <span class="va">param</span>,</span>
<span>                     thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     niter <span class="op">=</span> <span class="fl">1500</span>,</span>
<span>                     nburnin <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                     nchains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                     samplesAsCodaMCMC <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">MCMCvis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html" class="external-link">MCMCsummary</a></span><span class="op">(</span><span class="va">ct_fit</span>, Rhat <span class="op">=</span> <span class="cn">T</span>, n.eff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           mean       sd      2.5%      50%    97.5%</span></span>
<span><span class="co">#&gt; eta12 0.022675 0.002510 0.0177222 0.022444 0.027888</span></span>
<span><span class="co">#&gt; h[1]  0.002325 0.001038 0.0004644 0.002132 0.004493</span></span>
<span><span class="co">#&gt; h[2]  0.013566 0.002145 0.0099099 0.013234 0.018045</span></span>
<span><span class="co">#&gt; p[1]  0.254431 0.008318 0.2374105 0.254614 0.271169</span></span>
<span><span class="co">#&gt; p[2]  0.148262 0.006582 0.1367348 0.147997 0.161442</span></span>
<span><span class="co">#&gt; p[3]  0.000000 0.000000 0.0000000 0.000000 0.000000</span></span></code></pre>
<p>Pretty close to the true parameter estimates! In this case, the
continuous time model took a little longer to run than the discrete
model. This is at least in part because the matrix multiplication we did
to calculate the likelihood is slow to compute. Other software (JAGS and
Stan) have built-in matrix exponential functions that are much faster.
It is also likely that the nimble function could be altered to calculate
the matrix exponential using faster operations.</p>
<p>The code is also somewhat slower because we tended to have a lot of
detections of each individual relative to the number of occasions in the
discrete-time model. Bigger dimensions on for loops always slows down
models. In other cases, the continuous-time formulation may have been
faster.</p>
</div>
<div class="section level2">
<h2 id="extensions">Extensions<a class="anchor" aria-label="anchor" href="#extensions"></a>
</h2>
<p>We have seen several continuous time models, both of which used
constant rates. Often, those rates will vary over time as we have seen
in other CMR models. Continuous-time models can accommodate temporal
variation in rates but the coding is more complex than we have time to
cover. If you are interested in time-varying models, see the <a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2656.13902" class="external-link">this
paper</a>, particularly the appendices.</p>
</div>
<div class="section level2">
<h2 id="homework">Homework<a class="anchor" aria-label="anchor" href="#homework"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Vary the length of time bins in the discrete model. Fit one model
with longer bins (e.g., 25 days) and one with shorter bins (e.g., 5
days). How do your parameter estimates change?</p></li>
<li><p>Modify the simulation code and continuous-time model to allow
transitions from state 2 back to state 1. Set this rate at something
relatively low, e.g. 0.01.</p></li>
<li><p>On a 1-10 scale, with 1 being the worst week ever and 10 being
the best, how would you rate this week’s content? What lingering
questions/confusion about the lecture or lab do you still have?</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Clark Rushing, Heather Gaya.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
